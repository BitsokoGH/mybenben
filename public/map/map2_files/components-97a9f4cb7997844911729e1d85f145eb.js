function scStats(){this.attributes({mapPath:null}),this.onSCStatsRequestRefresh=function(t,e){this.currentPath=e.path,this.startLoading(this.attr.mapPath+"/stats.json?path="+e.path)},this.onSCStatsDestroy=function(){debug("destroy: wdwotstats"),this.teardown()},this.after("initialize",function(){debug("sc stats init"),this.on("pane:request:refresh",this.onSCStatsRequestRefresh),this.on(document,"mapp:destroy",this.onSCStatsDestroy)})}function verseStats(){this.attributes({}),this.onRequestRefresh=function(t,e){this.currentPath=e.path,0!=this.currentPath.indexOf("/")&&(this.currentPath="/"+this.currentPath),this.startLoading("/parcelverse/stats.json?path="+e.path)},this.onVerseStatsDestroy=function(){debug("destroy: versestats"),this.teardown()},this.after("initialize",function(){debug("verse stats init"),this.on("pane:request:refresh",this.onRequestRefresh),this.on(document,"mapp:destroy",this.onVerseStatsDestroy)})}function wdwotStats(){this.attributes({}),this.onRequestRefresh=function(t,e){this.currentPath=e.path,this.startLoading(e.path+"/stats.json")},this.onWDWOTStatsDestroy=function(){debug("destroy: wdwotstats"),this.teardown()},this.onWDWOTStatsHashChange=function(){var t=$.bbq.getState("o");t&&this.currentOwner!=t&&this.highlightOwner(t)},this.after("initialize",function(){debug("wdwot stats init"),this.on("pane:request:refresh",this.onRequestRefresh),this.on(document,"mapp:destroy",this.onWDWOTStatsDestroy),this.on(window,"hashchange",this.onWDWOTStatsHashChange)})}function renderMixin(){this.render=function(t){var e=this.attr,i=(e.templateId,this.$node);LL.Templates.fetch(this.attr.templateId,function(n){var o=n(t||e);fn=e.append?i.append:i.html,fn.call(i,o)})},this.after("initialize",function(){if(!this.attr.templateId)throw new Error("Component must be initialized with a templateId to use render mixin.");LL.Templates.preload(this.attr.templateId),this.attr.autoRender&&this.render()})}function mapMixin(){var t=640,e=640,i="https://maps.googleapis.com/maps/api/",n="AIzaSyBsAlcqiHLaF5T-eV0EdxV3h6my-xcgTkM",o=t+"x"+e,s=$.param({size:o,key:n});this.computeHeading=function(t,e){return google.maps.geometry.spherical.computeHeading(t,e)},this.makeGoogleLatLng=function(t){var e=t[1],i=t[0];return new google.maps.LatLng(e,i)},this.generateViewUrl=function(t){var e=i;return e+=this.panorama?"streetview":"staticmap",e+="?"+s,e+"&"+$.param(t)}}!function(){LL.BizMetrics=flight.component(function(){this.attributes({}),this.refresh=function(){var t=LL.Spinner.start();$.get("/admin/metrics/biz.json",function(t){LL.Templates.fetch("metrics_biz",function(e){if("ok"==t.status){var i=e(t.financials);this.$node.html(i),this.makeRevenueChart(t.financials)}else $("#admin-dash").html("Couldn't get the metrics: "+t.message)}.bind(this))}.bind(this)).fail(function(){this.$node.html("Couldn't get the metrics :(")}.bind(this)).always(function(){LL.Spinner.stop(t)})},this.onShowTab=function(){this.refresh()},this.makeRevenueChart=function(){return},this.onDestroying=function(){debug("biz metrics destroying"),this.teardown()},this.after("initialize",function(){$('#metrics-tabber a[href="#biz"]').one("show.bs.tab",this.onShowTab.bind(this)),this.on("metrics:refresh",this.refresh),LL.Templates.preload(["metrics_biz"])})})}(),function(){LL.DailyMetrics=flight.component(function(){var t=null,e="recent.not-loveland";this.refresh=function(){var e=LL.Spinner.start();$.get("/admin/metrics/daily.json",function(e){t=e;var i=moment(t.epoch);t.dates=_.map(_.range(t.num_days),function(t){return moment(i).add(t,"days").format("D")}),_.each(t.groups,function(t){t.classes=[],t.history&&t.classes.push("recent"),t.classes.push(t.loveland?"loveland":"not-loveland"),t.classes.push(t.paying?"paid":"free"),t.classes.push("state-"+t.state.toLowerCase()),t.max_maps=(""+t.max_maps).replace(/000$/,"k"),t.max_users=(""+t.max_users).replace(/000$/,"k")}),LL.Templates.fetch("metrics_daily",function(e){var i=e(t);$("#group-container",this.$node).html(i),this.postRender()}.bind(this))}.bind(this)).always(function(){LL.Spinner.stop(e)})},this.postRender=function(){var t={3:{sorter:"price"},5:{sorter:"date2"},6:{sorter:"firstNumber"},7:{sorter:"firstNumber"}};$("table.group-list thead th").each(function(e,i){0==$(i).data("sort")&&(t[e]={sorter:!1})}),$("table.group-list").tablesorter({headers:t}),this.applyFilter(e)},this.onShowTab=function(){this.refresh()},this.applyFilter=function(t){$("#daily .filters a.btn").removeClass("btn-info"),$("#daily .filters a[data-filter='"+t+"']").addClass("btn-info"),"all"==t?$("#daily .group-list tbody tr").removeClass("hide"):($("#daily .group-list tbody tr:not(."+t+")").addClass("hide"),$("#daily .group-list tbody tr."+t).removeClass("hide")),e=t},this.onClickFilter=function(t){var e=$(t.currentTarget).data("filter");this.applyFilter(e),t.preventDefault()},this.after("initialize",function(){$('#metrics-tabber a[data-toggle="tab"][href="#daily"]').one("show.bs.tab",this.onShowTab.bind(this)),this.on(".filters a.btn","click",this.onClickFilter),this.on("metrics:refresh",this.refresh),LL.Templates.preload(["metrics_daily"])})})}(),function(){LL.GoogleMetrics=flight.component(function(){this.refresh=function(t){this.$node.text("Loading...");var e=LL.Spinner.start(),i="/admin/metrics/google.json";t&&(i+="?refresh=1"),$.get(i,function(t){LL.Templates.fetch("metrics_google",function(e){var i=e(t);this.$node.html(i)}.bind(this))}.bind(this)).always(function(){LL.Spinner.stop(e)})},this.onShowTab=function(){this.refresh()},this.after("initialize",function(){$('#metrics-tabber a[href="#google"]').one("show.bs.tab",this.onShowTab.bind(this)),this.on("metrics:refresh",this.refresh.bind(this,!0)),LL.Templates.preload(["metrics_google"])})})}(),function(){LL.GroupDetail=flight.component(function(){this.firstRender=function(){var t=LL.Spinner.start();$.get("/admin/subscriptions.json",function(t){this.renderGroups(t)}.bind(this)).always(function(){LL.Spinner.stop(t)}.bind(this))},this.showGroup=function(t){var e=LL.Spinner.start();$.get("/groups/"+t+".json?admin=1",function(t){"ok"==t.status?this.renderGroupDetail(t):this.$node.trigger("notify:message",t)}.bind(this)).always(function(){LL.Spinner.stop(e)})},this.renderGroupDetail=function(t){t.can_close_group="Closed"!=t.state,LL.Templates.fetch("admin_group_detail",function(e){$("#group-detail-modal .modal-header h3").text(t.name),$("#group-detail-modal .group-detail").html(e(t)),$(".offline-link").moreButton(),$("#group-detail-modal").modal("show"),$.bbq.setState({g:t.id})})},this.onClickGroupName=function(t){var e=$(t.target).data("id");this.showGroup(e),t.preventDefault()},this.onClickRefund=function(t){var e=$(t.currentTarget),i=e.data("id"),n=e.data("amount"),o=confirm("Are you sure you want to refund $"+n+"?");return o?($.post("/admin/refund.json",{transaction_id:i},function(t){e.replaceWith(t.message)}),!1):!1},this.onClickCancel=function(t){var e=$(t.currentTarget),i=e.data("group-id"),n=e.data("sub-id"),o=confirm("Really cancel this subscription? The account won't go away, but automated billing will stop.");if(!o)return!1;var s=LL.Spinner.start();$.post("/admin/cancel_subscription.json",{group_id:i,subscription_id:n},function(t){e.replaceWith(t.message)}).always(function(){LL.Spinner.stop(s)}),t.preventDefault()},this.onClickCloseGroup=function(t){var e=$(t.currentTarget),i=e.data("group-id"),n=e.data("sub-id"),o=confirm("Really close this account? It'll stop any billing and close user access.");if(!o)return!1;var s=LL.Spinner.start();$.post("/admin/cancel_subscription.json",{group_id:i,subscription_id:n,close:"1"},function(t){e.replaceWith(t.message)}).always(function(){LL.Spinner.stop(s)}),t.preventDefault()},this.onSaveOffline=function(t){var e=$(t.currentTarget).closest("#offline"),i=e.data("id"),n=$("input[name=offline_amount]",e).val(),o=$("select[name=offline_cycle]",e).val(),s=$("select[name=offline_subtier]",e).val();if(!n||0==n.length)return!1;e.css("opacity","0.5");var r=LL.Spinner.start();$.post("/admin/set.json",{offline:1,group_id:i,amount:n,cycle:o,subtier:s},function(){e.css("opacity","1").replaceWith("Saved.")}.bind(this)).always(function(){LL.Spinner.stop(r)}),t.preventDefault()},this.after("initialize",function(){$("#group-container").on("click","a.group-name",this.onClickGroupName.bind(this)),$("#group-detail-modal").on("click","a.refund",this.onClickRefund.bind(this)),$("#group-detail-modal").on("click","a.close-group",this.onClickCloseGroup.bind(this)),$("#group-detail-modal").on("click","a.cancel-sub",this.onClickCancel.bind(this)),$("#group-detail-modal").on("click",".save-offline",this.onSaveOffline.bind(this)),$("#group-detail-modal").appendTo("body");var t=$.bbq.getState("g");t&&this.showGroup(t),$("#group-detail-modal").on("hidden.bs.modal",function(){$.bbq.setState({g:""})})})})}(),function(){LL.LiveMetrics=flight.component(function(){this.attributes({}),this.onMessage=function(t,e){debug(e)},this.onDestroying=function(){debug("live metrics destroying"),this.trigger("radio:unsubscribe",{channels:["/notify/admin/log"]}),this.teardown()},this.refresh=function(){this.$node.text("Loading...");var t=LL.Spinner.start();$.get("/admin/metrics/live.json",function(t){this.$node.text(JSON.stringify(t))}.bind(this)).always(function(){LL.Spinner.stop(t)})},this.onShowTab=function(){this.trigger("radio:subscribe",{channels:["/notify/admin/log"],callback:this.onMessage.bind(this)}),this.refresh()},this.after("initialize",function(){$('#metrics-tabber a[data-toggle="tab"][href="#live"]').one("show.bs.tab",this.onShowTab.bind(this)),this.on("metrics:refresh",this.refresh)})})}();var trackEvent=function(t,e,i,n){i="undefined"==typeof i?null:i;var o={hitType:"event",eventCategory:t,eventAction:e,eventLabel:i,dimension1:window.data.current_user_id,dimension2:window.data.group_slug};"undefined"!=typeof n&&(o.eventValue=n),debug(s.sprintf("trackEvent: %s, %s, %s, %%o",t,e,i),o),ga("send",o)},trackIntercomEvent=function(t,e){if("undefined"!=typeof Intercom){var i="intercom: "+t;"undefined"!=typeof e&&(i+=" - "+JSON.stringify(e)),debug(i),Intercom("trackEvent",t,e)}};LL.Analytics=function(){this.onClickHomeList=function(t,e){trackEvent("home","list",e.path)},this.onClickHomeState=function(t,e){trackEvent("home","state",e.path)},this.onSearchStart=function(t,e){trackEvent("search",e.domain,e.search)},this.onPickAutocomplete=function(t,e){trackEvent("search","choose-autocomplete",e.path)},this.onRegion=function(t,e){trackEvent("explorer","show-place",e.path.replace("//","/"))},this.onBoundaryStyle=function(t,e){trackEvent("explorer","set-boundaries",e.bounds)},this.onBaseChanged=function(t,e){trackEvent("explorer","base",e.base)},this.onLayer=function(t,e){trackEvent("explorer","set-layer",e.dataset)},this.onRequesting=function(t,e){trackEvent("page","pjax",e.href)},this.onProperty=function(t,e){trackEvent("explorer","show-property",e.path)},this.onGetNext=function(t,e){var i="undefined"==typeof e.path?null:e.path;trackEvent("surveyor","next",i)},this.onSavedSurvey=function(t){trackEvent("surveyor","saved",t.payload?t.payload.path:null)},this.onClickLink=function(t){var e=$(t.currentTarget),i=e.data("category"),n=e.data("action"),o=e.data("label");trackEvent(i,n,o)};var t=null,e=null;this.onNavbarSet=function(i,n){"undefined"!=typeof Intercom&&("map.slug"==n.key&&t!=n.value?(debug("intercom sees you lookin at mapslug "+n.value+" now"),t=n.value,Intercom("update",{map_slug:n.value})):"map.name"==n.key&&e!=n.value&&(e=n.value,Intercom("update",{map_name:n.value})))},this.after("initialize",function(){$(document).on("click","a[data-category]",this.onClickLink.bind(this)),this.on(document,"home:click:list",this.onClickHomeList),this.on(document,"home:click:state",this.onClickHomeState),this.on(document,"search:start",this.onSearchStart),this.on(document,"search:selected",this.onPickAutocomplete),this.on(document,"mapp:regions:switched",this.onRegion),this.on(document,"mapp:regions:set-boundaries",this.onBoundaryStyle),this.on(document,"mapp:dataset:set",this.onLayer),this.on(document,"page:requesting",this.onRequesting),this.on(document,"property:loaded",this.onProperty),this.on(document,"mapp:base:changed",this.onBaseChanged),this.on(document,"navbar:set",this.onNavbarSet),this.on(document,"bu:property:get-next",this.onGetNext),this.on(document,"bu:survey:saved",this.onSavedSurvey)})},function(){function t(){this.attributes({basePath:"/survey",mapSlug:!1,useTags:!1}),this.resizeMap=function(){var t=$(".navbar").height(),e=this.$node.offset().top;e!==t&&this.$node.offset({top:t});var i=$(".small-panel").height(),n=$(".survey-toolbar").outerHeight(),o=$(".survey-section").outerHeight(),s=i-n-o;$("#survey-map").height(s),this.trigger("#survey-map","bu:map:resize",!0)},this.onClickSkip=function(t){var e='Are you sure you want to mark this property as "unable to survey"?\n\nThis will remove the current property from the survey pool. Any unsaved answers will be lost.';confirm(e)&&this.trigger("bu:survey:skipped"),t.preventDefault()},this.onSurveySaved=function(){this.trigger("bu:property:set-photo",{photo:null})},this.onLeaving=function(){debug("destroying blextinUSA"),this.trigger("bu:destroy"),this.teardown()},this.after("initialize",function(){debug("initializing blexting USA"),LL.SurveyMap.attachTo("#survey-map"),LL.SurveyPano.attachTo("#survey-pano"),LL.SurveyQuestions.attachTo("#survey-tags",{url:this.attr.basePath+"/questions.json"}),LL.SurveyProperty.attachTo(this.$node,{basePath:this.attr.basePath,mapSlug:this.attr.mapSlug}),this.on(document,"pjax:beforeSend",this.onLeaving),$(window).resize(this.trigger.bind(this,"bu:small-panel:resize")),this.on(document,"bu:small-panel:resize",this.resizeMap),this.on(document,"bu:property:served","bu:small-panel:resize"),this.on(document,"bu:survey-tags:changed","bu:small-panel:resize"),this.on(document,"bu:survey:saved",this.onSurveySaved),this.$node.on("click","#skip-form",this.onClickSkip.bind(this)),this.trigger("bu:property:get-next",$.deparam.fragment())})}LL.BlextingUSA=flight.component(t)}(),window.requestServe=function(t,e){function i(t,e){o=!0,n=e}var n,o=!1;return $(document).on(t+":served",i),$(document).trigger(t+":requested",e),$(document).off(t+":served",i),o||console.error("Asynch event encountered when a synchronous event was expected."),n},LL.Mapp=function(){var t={};this.attributes({outlinePath:null,defaultStyle:null,regionVersion:null,regionLimit:"/w",dataset:"sitecontrol",leaflet:null,paraffin:null,mapSlug:!1,mapPath:!1,nearmap:window.data.nearmap_ticket?!0:!1});var e="street",i={street:"Street",satellite:"Satellite",nearmap:"Nearmap"};this.onToggleBase=function(){var t=this.attr.leaflet,e=this.attr.paraffin;if(t.hasLayer(e.baseLayers.Street)){var i=this.attr.nearmap?"nearmap":"satellite";this.$node.trigger("mapp:bar:set-base",i)}else this.$node.trigger("mapp:bar:set-base","street")},this.onSetBase=function(t,e){this.setBase(e)},this.setBase=function(t){if("undefined"!=typeof t&&t){var n=this.attr.leaflet,o=this.attr.paraffin;if(t!=e){var s=["street","satellite"];this.attr.nearmap&&s.push("nearmap");var r=(_.each(s,function(e){var s=i[e];e!=t&&n.hasLayer(o.baseLayers[s])&&n.removeLayer(o.baseLayers[s])}),i[t]);n.addLayer(o.baseLayers[r]),"satellite"==t||"nearmap"==t?$("#header a[href='#base']").parent().addClass("active"):"street"==t&&$("#header a[href='#base']").parent().removeClass("active");var a="nearmap"==t?o.baseLayers.Nearmap.options.maxZoom:18;n.options.maxZoom=a,this.$node.trigger("mapp:base:changed",{base:t}),e=t}}},this.onBaseChanged=function(t,e){var i=$("#header .subnav a[href='#base']").closest("li");"satellite"==e.base?i.addClass("active"):i.removeClass("active"),$.bbq.pushState({base:e.base})},this.onMappHashChange=function(){debug("mapp hash change");var t=$.bbq.getState("base");this.setBase(t)},this.initializeHistory=function(){var t="state"in window.history&&null!==window.history.state,e=location.pathname;$(window).bind("popstate",function(){var i=!t&&location.pathname==e;t=!0,i||this.$node.trigger("history:back",{path:location.pathname})}.bind(this))},this.onAddLegend=function(e,i){i.key?t[i.id]=i.key:delete t[i.id],n()},this.onRemoveLegend=function(e,i){delete t[i.id],n()};var n=function(){var e=[];_.each(t,function(t){_.each(t,function(t,i){e.push({color:i,label:t})})});var i=$("#mapbox .wrapper .key",this.$node);return i.exists()||($("#mapbox .wrapper",this.$node).append("<div class='key'></div>"),i=$("#mapbox .wrapper .key")),$.isEmptyObject(e)?void i.html("").hide():void LL.Templates.fetch("legend",function(t){i.html(t({colors:e})).show()})};this.onMappPropertyLoaded=function(t,e){$.bbq.pushState({p:e.path})},this.onInitialized=function(){var t=$.bbq.getState("t");t&&(debug("pane waking up to tab "+t),$("#waterfall").trigger("pane:request:show",{tab:"#"+t}))},this.onLeaving=function(){debug("destroy: mapp base"),this.$node.trigger("mapp:destroy"),this.attr.leaflet.remove(),map=null,this.teardown()},this.after("initialize",function(){debug("mapp base init"),this.on(document,"mapp:bar:toggle-base",this.onToggleBase),this.on(document,"mapp:bar:set-base",this.onSetBase),this.on(document,"pjax:beforeSend",this.onLeaving),this.on(document,"mapp:base:changed",this.onBaseChanged),this.on(document,"mapp:legend:add",this.onAddLegend),this.on(document,"mapp:legend:remove",this.onRemoveLegend),this.on(document,"mapp:initialized",this.onInitialized),this.on(document,"property:loaded",this.onMappPropertyLoaded),this.on(window,"hashchange",this.onMappHashChange),flight.component(LL.Bin).attachTo(this.node,{channels:data.channels}),flight.component(LL.MapBar).attachTo("#header"),flight.component(LL.Regions,LL.RegionColors).attachTo(this.node,{paraffin:this.attr.paraffin,leaflet:this.attr.leaflet,outlinePath:this.attr.outlinePath,outlineLayer:this.attr.paraffin.overlays.outline,chunkLayer:this.attr.paraffin.overlays.places,defaultStyle:this.attr.defaultStyle,regionVersion:this.attr.regionVersion,regionLimit:this.attr.regionLimit,dataset:this.attr.dataset,mapPath:this.attr.mapPath,mapSlug:this.attr.mapSlug}),flight.component(LL.Parcels,LL.Tiles).attachTo(this.node,{paraffin:this.attr.paraffin,leaflet:this.attr.leaflet,dataset:this.attr.dataset}),flight.component(LL.GPS).attachTo(this.node,{paraffin:this.attr.paraffin,leaflet:this.attr.leaflet}),this.attr.leaflet.attributionControl&&this.attr.leaflet.attributionControl.setPrefix(null),this.$node.trigger("mapp:initialized")})},function(){function t(){var t=null;this.attributes({}),this.onSwitchedRegions=function(){},this.onLeaving=function(){debug("leaving mcm mapp")},this.after("initialize",function(){t=this,debug("mcm mapp init"),flight.component(LL.Pane).attachTo("#waterfall"),this.on(document,"page:requesting",this.onLeaving),this.trigger("wdwot:initialized"),this.trigger("navbar:show:1",{target:"#mcm-explore"}),this.on(document,"mapp:regions:switched",this.onSwitchedRegions)})}LL.MCMMapp=flight.component(t,LL.Mapp)}(),function(){function verse(){this.attributes({countiesKey:"verse_counties",statesKey:"states_geojson",options:null,paraffin:null,leaflet:null,colorScale:null,embedded:!1});var $waterfall=null,loaded=!1,busy=!1,currentPath=null,currentCounty=null,currentId=null,currentStyle=null,lookup={},usBounds=L.latLngBounds(L.latLng(23.5,-127.3),L.latLng(48.5,-64.6)),stateScale=null;this.getCountyJSON=function(t){var e=LL.Spinner.start();localforage.getItem(this.attr.countiesKey,function(i,n){n?(this.addToLookup(n.features),LL.Spinner.stop(e),t.apply(this,[n])):$.get("/parcelverse.json",function(e){localforage.setItem(this.attr.countiesKey,e),this.addToLookup(e.features),t.apply(this,[e])}.bind(this)).always(function(){LL.Spinner.stop(e)})}.bind(this))},this.getStateJSON=function(t){var e=LL.Spinner.start();localforage.getItem(this.attr.statesKey,function(i,n){n?(LL.Spinner.stop(e),this.addToLookup(n.features),t.apply(this,[n])):$.get("/us/states.json",function(e){localforage.setItem(this.attr.statesKey,e),this.addToLookup(e.features),t.apply(this,[e])}.bind(this)).always(function(){LL.Spinner.stop(e)})}.bind(this))},this.addToLookup=function(t){_.each(t,function(t){lookup[t.properties.path]=t.properties.headline})},this.onClickShape=function(t,e){"place county"==e.data.classes?this.loadDetail(e.data.id,e.data):"place state"==e.data.classes&&this.zoomToRegion(e.data.path,e.data.headline)},this.loadDetail=function(t,e){this.trigger("pane:request:show",{tab:"#detail"}),currentId!=t&&LL.Templates.fetch(["verse_preview","verse_detail"],function(i){if("undefined"!=typeof e&&e){var n=i.verse_preview(e);$("#detail").html(n)}var o=LL.Spinner.start();currentId=t,$.bbq.setState({v:t}),$.get("/parcelverse/"+t+".json",function(t){currentCounty=t,currentCounty.admin=window.data.admin,$.extend(currentCounty,this.attr.options),_.each(t.sections,function(t){_.each(t.fields,function(t){t.value=currentCounty[t.key]}.bind(this))}.bind(this));var e=i.verse_detail(currentCounty);$("#detail").html(e),window.data.admin||$("#detail .admin-only").remove()}.bind(this)).always(function(){LL.Spinner.stop(o)})}.bind(this))},this.onHashChange=function(){var t=$.bbq.getState("v"),e=$.bbq.getState("t");!t||e&&"detail"!=e||(t=parseInt(t),this.loadDetail(t));var i=$.bbq.getState("b"),n=$.bbq.getState("s");i||(i="states"),n||(n="/us"),i=i.toLowerCase(),n=n.toLowerCase();var o=i!=currentStyle,s=n!=currentPath;currentStyle=i,currentPath=n,(o||s)&&this.zoomToRegion(currentPath)},this.onClickBump=function(t){$(t.currentTarget).attr("disabled","1");var e=$(t.currentTarget).data("key"),i=LL.Spinner.start();$.post("/admin/cache.json",{bump:e},function(e){"ok"==e.status&&($(t.currentTarget).parent().append("<p>Cleared cache, reload to see changes</p>"),$(t.currentTarget).remove())}).always(function(){LL.Spinner.stop(i)}),t.preventDefault()},this.onClickToggleBlank=function(t){$("#detail .blank").toggleClass("hide"),t.preventDefault()},this.onEdit=function(t){$("#detail .editable").editable({url:"/parcelverse.json",ajaxOptions:{type:"put"},mode:"inline",type:"text",pk:currentCounty.id}),$("#detail .edit").remove(),t.preventDefault()},this.zoomToRegion=function(t){var e={states:"States",counties:"Counties"},i=this.attr.paraffin.overlays.counties,n=this.attr.paraffin.overlays.states,o=function(){return!0},s=function(){return!0},r=n.originalStyle,a="Parcelverse",l=!1;currentPath=t;var h=t.split("/").slice(1);1==h.length?(delete e.cities,"states"==currentStyle&&(s=function(){return!1},o=function(){return!0},r=stateScale,l=!0)):2==h.length?(delete e.states,o=function(e){return e.properties.path==t},s=function(e){return 0==e.properties.path.indexOf(t)}):3==h.length?(delete e.states,delete e.counties,o=function(e){return 0==t.indexOf(e.properties.path)},s=function(e){return e.properties.path==t}):4==h.length;var c=LL.Spinner.start();this.getCountyJSON(function(t){var e=_.select(t.features,s),n={type:"FeatureCollection",features:e};i.clearLayers(),i.addData(n),LL.Spinner.stop(c),loaded=!0}),this.getStateJSON(function(e){var i=_.select(e.features,o),s={type:"FeatureCollection",features:i};n.options.interaction=l,n.clearLayers(),n.addData(s),n.setStyle(r),$("#overview h2.title").text(lookup[t]||"Parcelverse"),2==h.length&&(bounds=n.getBounds(),this.attr.leaflet.fitBounds(bounds))}),$("#overview h2.title").text(lookup[t]||"Parcelverse"),this.trigger("mapp:regions:loaded",e),this.trigger("mapp:regions:switched",{path:t,headline:a})},this.onSetBoundaries=function(t,e){currentStyle!=e.bounds&&(currentStyle=e.bounds,$.bbq.setState({b:currentStyle}),this.zoomToRegion(currentPath))},this.onRequestParent=function(){if(busy||!loaded||"/us"==currentPath)return!1;var t=currentPath.split("/"),e=t.slice(0,t.length-1).join("/");debug("zoom back camera - "+e),"/us"==e&&this.attr.leaflet.fitBounds(usBounds),this.zoomToRegion(e)},this.onSwitchedRegions=function(t,e){var i=e.path;"/us"==i?$("#mapbox .back").addClass("hide"):$("#mapbox .back").removeClass("hide"),$.bbq.setState({s:i}),$("#overview a.download").attr("href","/parcelverse.csv?path="+i)},this.onDestroy=function(){debug("destroy parcelverse"),this.$node.empty(),this.teardown()},this.cleanupStorage=function(){},this.after("initialize",function(){if(debug("parcelverse init"),$waterfall=$("#waterfall"),this.attr.paraffin.overlays.states.originalStyle=this.attr.paraffin.overlays.states.options.style,stateScale=eval("("+this.attr.colorScale+")"),flight.component(LL.MapBar).attachTo("#header"),flight.component(LL.Pane).attachTo($waterfall),LL.VerseStats||(LL.VerseStats=flight.component(verseStats,LL.StatsBase,LL.ByRegion,LL.Charts)),LL.VerseStats.attachTo("#overview.tab-pane",{initialPath:"/us"}),this.on(document,"mapp:destroy",this.onDestroy),this.on(document,"mapp:regions:switched",this.onSwitchedRegions),this.on(document,"mapp:regions:set-boundaries",this.onSetBoundaries),this.on("#mapbox.parcelverse","paraffin:click",this.onClickShape.bind(this)),this.on("#mapbox .back","click",this.onRequestParent),this.on("#overview a.bump","click",this.onClickBump),this.on(window,"hashchange",this.onHashChange),$("#detail").on("click","a.edit",this.onEdit.bind(this)),$("#detail").on("click","a.toggle-blank",this.onClickToggleBlank.bind(this)),$("#map").addClass("colored"),LL.Templates.preload(["verse_detail","verse_preview"]),this.attr.embedded){var leaf=this.attr.leaflet;leaf.whenReady(function(){leaf.scrollWheelZoom.disable()})}this.onHashChange(),this.trigger("verse:initialized")})}LL.Parcelverse=flight.component(verse)}(),function(){function t(){this.attributes({mapId:null,legend:!1,mapSlug:null,leaflet:null,paraffin:null,embedded:!1,outlinePath:null,styleHandler:!1,permissions:{},surveyable:!1});var t=null,e=null,i=[],n=!1;this.fetchMapInfo=function(){$.get(e+".json",function(e){debug(e),t=e,e.channels&&(i=e.channels,this.trigger("radio:subscribe",{channels:e.channels})),this.trigger("mapp:regions:menu",e.regions),this.trigger("sc:map:fetched",e)}.bind(this))},this.onRegionFocus=function(t,e){{var i=e.outline.properties;window.location.protocol+"//"+window.location.host+switchPath(i.path,"sc")}this.trigger("page:metadata:set",{name:{title:i.headline+" - Site Control"}}),$("#waterfall .place-name").text(i.headline),e.tile_key&&"us"==e.ds?$("#waterfall .survey-btn").attr("href","/survey/"+this.attr.mapSlug+"#s="+switchPath(e.path,"us")).removeClass("hide"):$("#waterfall .survey-btn").addClass("hide");var o=$("#header a[data-path='/sitecontrol/manage-map/export']");if(o.querystring({s:i.path}),!n){var r=s.sprintf("/m/%s/blexts.json",this.attr.mapSlug);$.post(r,{style:"counts",query:{path:i.path}},function(t){"ok"==t.status&&(t.geojson_ok?(this.trigger("bin:request:clear"),this.trigger("bin:request:fetch",{mapSlug:this.attr.mapSlug,query:{path:i.path}})):this.trigger("bin:too-many",{count:t.count,max:t.max}))}.bind(this))}},this.onTooMany=function(){n||(debug("ah too many parcels. can we use a bake?"),t&&t.render_url?(debug("yeah!"),this.switchToBaked()):debug("no :/"))},this.switchToBaked=function(){n=!0,this.trigger("bin:request:clear");var e={id:"bake",name:"Baked SC Layer",url:t.render_url,ty:"tilejson",zindex:4,interaction:!1},i=this.attr.paraffin.createTileJSON(e);return this.attr.paraffin.overlays[e.id]=i,this.attr.leaflet.addLayer(i),!0},this.onPropertyLoaded=function(){$("#search ul.nav-pills .blext-tab").first().tab("show")},this.onRegionHistory=function(t,e){$.bbq.pushState({s:e.path})},this.onSCHashChange=function(){debug("sc hash change")},this.onClickRegionLink=function(t){var e=$(t.currentTarget).data("path");this.trigger("mapp:regions:set-path",{path:e}),t.preventDefault()},this.onParcelsInit=function(){this.attr.styleHandler&&(debug("SC telling the parcel layer to color itself"),this.trigger("mapp:parcels:style",{styleHandler:this.attr.styleHandler,legend:this.attr.legend}))},this.onFetchedMap=function(t,e){this.attr.permissions.qc&&(debug("SC got map info, setting up QC bar"),LL.QCBar.attachTo("#search",{map:e,permissions:this.attr.permissions}),LL.QCAnswers.attachTo("#search",{map:e,permissions:this.attr.permissions})),this.attr.permissions.post&&(debug("ok to post, constructing Post-it widget"),LL.Post.attachTo("#search",{map:e}))},this.onSCMessage=function(t,e){if("import_progress"==e.message_type){var i=s.sprintf("import-%d",e.source.id),n=null,n=e.result.done+e.result.errors==e.result.count?s.sprintf("Done importing! Successfully loaded %d records, please reload the map to see them",e.result.done,e.result.count):s.sprintf("Importing %s: %d of %d done",e.source.name,e.result.done,e.result.count);e.result.errors>0&&(n+=s.sprintf(" (couldn't match %d)",e.result.errors)),this.trigger("notify:message",{message:n,id:i})}},this.onUpdatedRegionMenu=function(t,e){LL.Templates.fetch("region_menu",function(t){$("#overview .regions").html(t(e)),$("#overview .regions a.folder").moreButton()}.bind(this))},this.after("initialize",function(){if(debug("sc mapp init"),e="/m/"+this.attr.mapSlug,this.on(document,"mapp:parcels:initialized",this.onParcelsInit),flight.component(LL.Pane).attachTo("#waterfall"),LL.Property.attachTo("#search.tab-pane",{mapId:this.attr.mapId,mapp:!0,surveyable:this.attr.surveyable,mapSlug:this.attr.mapSlug}),flight.component(LL.Feed,LL.ByRegion).attachTo("#waterfall #feed",{mapPath:e,mapId:this.attr.mapId,itemsSelector:".feed-items"}),LL.SCStats||(LL.SCStats=flight.component(scStats,LL.StatsBase,LL.ByRegion,LL.Charts)),LL.SCStats.attachTo("#overview.tab-pane",{initialPath:this.attr.outlinePath,mapPath:e}),LL.Search.attachTo("#search-form",{ajax:!0,contextPath:this.attr.outlinePath,mapp:!0,mapId:this.attr.mapId}),flight.component(LL.Dots).attachTo("#mapbox",{paraffin:this.attr.paraffin,leaflet:this.attr.leaflet}),$("#sc-map a[href='#census']").exists()&&LL.Census.attachTo("#census.tab-pane",{}),this.attr.embedded){var t=$("#waterfall"),i=$("#sc-map.subnav");$("#layers",t).remove(),$("a[href=#layers], a[href=#census], a[href=#drawing]",i).closest("li").remove();var n=this.attr.leaflet;n.whenReady(function(){n.scrollWheelZoom.disable()})}else LL.Drawing.attachTo("#mapbox",{paraffin:this.attr.paraffin,leaflet:this.attr.leaflet,mapSlug:this.attr.mapSlug});LL.Table.attachTo("#list.tab-pane",{mapPath:e}),LL.Query.attachTo("#query.tab-pane",{mapPath:e}),this.on(document,"mapp:regions:switched",this.onRegionFocus),this.on(document,"mapp:regions:history",this.onRegionHistory),this.on(document,"mapp:regions:menu",this.onUpdatedRegionMenu),this.on(document,"property:loaded",this.onPropertyLoaded),this.on(document,"radio:received",this.onSCMessage),this.on(document,"sc:map:fetched",this.onFetchedMap),this.on(document,"bin:too-many",this.onTooMany),this.on(window,"hashchange",this.onSCHashChange),$("#overview .regions").on("click","a.region-link",this.onClickRegionLink.bind(this)),this.fetchMapInfo(),this.trigger("sc:initialized"),this.trigger("navbar:show:1",{target:"#sitecontrol-1"}),this.trigger("navbar:show:2",{target:"#sc-map"})})}LL.SCMapp=flight.component(t,LL.Mapp)}(),function(){function t(){this.attributes({leaflet:null,paraffin:null,basePath:"/survey",channels:[]});var t,e,i,n=null,o=function(t){var e=moment().unix()-t.properties.created_at_i,i=2400/(e+2400),n=.3+.7*i;return{radius:4+13*i,opacity:n,fillOpacity:n}},s=null,r={};this.getInitialPoints=function(){$.get(this.attr.basePath+"/points.json",function(t){var i=_.reject(t.points,function(t){return r[t.id]}),n=_.collect(i,function(t){var i=new L.circleMarker(L.latLng(t.centroid[1],t.centroid[0]),e);return i.feature=t,i.feature.properties=t,r[t.id]=!0,i});s.addLayers(n)}.bind(this))},this.onAdd=function(t,i){var n=i.features?i.features:[i],o=_.reject(n,function(t){return r[t.id]}),a=_.collect(o,function(t){var i=new L.circleMarker(L.latLng(t.properties.centroid[1],t.properties.centroid[0]),e);return i.feature=t,r[t.properties.id]=!0,i});s.addLayers(a)},this.startFader=function(){this.refreshStyles(),n=setTimeout(this.startFader.bind(this),6e4)},this.refreshStyles=function(){var t=this.attr.paraffin.overlays.dots;t.setStyle(t.options.style)},this.onClickDot=function(t){var e=t.layer.feature.properties;this.trigger("property:request",e)},this.onClickFeed=function(t){var e=$(t.originalEvent.target).closest("a");if(e.hasClass("item-link")){var i={path:e.attr("href")};this.trigger("property:request",i),t.preventDefault()}},this.onLeaving=function(){debug("destroy: results app"),this.trigger("mapp:destroy")},this.onDestroy=function(){debug("destroy: usaResults"),n&&clearTimeout(n),this.attr.leaflet.remove(),$("#mapbox .wrapper .map").empty(),map=null,this.teardown()},this.after("initialize",function(){debug("results app init"),flight.component(LL.Pane).attachTo("#waterfall"),flight.component(LL.Feed,LL.ByRegion).attachTo("#waterfall #feed",{mapPath:this.attr.basePath,itemsSelector:".feed-items",channels:this.attr.channels}),flight.component(LL.Bin).attachTo(this.$node,{channels:this.attr.channels}),LL.Property.attachTo("#search.tab-pane",{headline:"#search h3.address",container:"#search .results"}),LL.SurveyStats.attachTo("#overview.tab-pane",{url:this.attr.basePath+"/stats.json"}),this.on(document,"bin:add",this.onAdd),this.$node.click("a.item-link",this.onClickFeed.bind(this)),this.on(document,"pjax:beforeSend",this.onLeaving),this.on(document,"mapp:destroy",this.onDestroy);
var n=this.attr.paraffin.overlays.dots;t=n.options.style,i=function(e){return overrides=o(e),$.extend({},t,overrides)},n.options.style=i,n.on("click",this.onClickDot.bind(this)),this.startFader(),e=$.extend({},t,{radius:5,fillOpacity:.7}),s=new L.MarkerClusterGroup({maxClusterRadius:40,disableClusteringAtZoom:18}),s.on("click",this.onClickDot.bind(this)),this.attr.leaflet.addLayer(s),this.trigger("pane:request:show",{tab:"#feed"}),$("#feed").trigger("pane:request:refresh",{path:"/us"}),this.getInitialPoints()})}LL.USAResults=flight.component(t)}(),function(){function t(){this.attributes({leaflet:null,paraffin:null,outlinePath:null,scDomain:""});var t=null,e=null,i={};this.onSwitchedRegions=function(t,i){var n=i.outline.properties,o=window.location.protocol+"//"+window.location.host+switchPath(n.path,"us"),s=n.headline+": LOVELAND - Parcel data and property ownership";s+=i.parent_names?" in "+i.parent_names:"",this.trigger("page:metadata:set",{name:{title:s},property:{"og:title":n.headline,"og:url":o,"twitter:title":n.headline,"twitter:url":o}}),this.trigger("navbar:set",{key:"map.path",value:i.path}),e=i.path,$("#waterfall .place-name").text(i.outline.properties.headline),i.tile_key&&"us"==i.ds?($("#waterfall .survey-btn").attr("href","/survey#s="+switchPath(i.path,"us")).removeClass("hide"),$("#waterfall .new-map").data("path",i.path).removeClass("hide")):"/us"==i.path?($("#waterfall .survey-btn").attr("href","/survey").removeClass("hide"),$("#waterfall .new-map").data("path",i.path)):$("#waterfall .survey-btn, #waterfall .new-map").addClass("hide"),LL.Templates.fetch("data_request",function(t){$("#overview .request").remove(),i.show_form&&(this.showRequestForm(i,t),this.trigger("pane:request:show",{tab:"#overview"}))}.bind(this))},this.onRegionHistory=function(t,e){history.replaceState({},"",e.path)},this.showRequestForm=function(t,e){$.extend(t,{name:window.data.signed_in?window.data.username:null,csrf_token:$("meta[name='csrf-token']").attr("content"),requested:i[t.path]}),$("#overview").append(e(t)),$("#overview .data-request-form").on("submit",function(){var t=LL.Spinner.start(),e={};return _.each($(this).serializeArray(),function(t){e[t.name]=t.value}),$.post("/requests.json",e,function(){$("#overview .data-request-form").replaceWith("<p class='centered'>Thank you!</p>"),i[e.path]=!0}).fail(function(){var t="<div class='alert alert-info'>Hmm, we were unable to record your suggestion right now, sorry about that!</div>";$("#overview .data-request-form").append(t)}).always(function(){LL.Spinner.stop(t)}),!1})},this.onFoundGPS=function(t,e){var i=e.coords;$.get("/search/point.json?lat="+i.latitude+"&lon="+i.longitude,function(t){debug(t),"ok"==t.status&&(t.context&&this.trigger("mapp:regions:request",{path:t.context.path,zoom:16}),t.parcel&&this.trigger("property:request",{path:t.parcel.path}))}.bind(this)).fail(function(){})};var n=null,o=!1;this.onClickNewSCMap=function(t){var e=$(t.currentTarget),i=e.data("path");if("/us"==i||i.match(/^\/[a-z]{2}\/?$/))return e.tooltip({title:"Please navigate to a county or city to make a Site Control map!",trigger:"manual",container:"#overview"}).tooltip("show"),setTimeout(function(){e.tooltip("destroy")},6e3),void t.preventDefault();if(n)this.renderNewMapModal(n);else if(!o){var s=LL.Spinner.start();o=!0,$.get("/groups.json",function(t){n=t,this.renderNewMapModal(n)}.bind(this)).always(function(){LL.Spinner.stop(s),o=!1}.bind(this))}t.preventDefault()},this.renderNewMapModal=function(i){LL.Templates.fetch("new_sc_map",function(n){var o=1==i.length?i[0].slug:"",s=n({groups:i,multipleGroups:i.length>1,groupSlug:o});$(".copy-to-sc.modal").remove(),$("body").append(s);var r=$(".copy-to-sc.modal");$("a.choose-group",r).click(function(t){var e=$(t.currentTarget),i=e.data("slug");e.closest(".copy-to-sc").data("group-slug",i),e.closest(".destination-groups").text("Selected "+e.text()+"."),t.preventDefault()}),$("a.create",r).click(function(i){var n=$(i.currentTarget);n.closest(".modal").modal("hide");var o=n.closest(".modal").data("group-slug"),s=t.attr.scDomain.replace(/\/\//,"//"+o+".");window.location=s+"/maps/new?path="+e,i.preventDefault()}),r.modal("show")}.bind(this))},this.onWDWOTDestroy=function(){debug("wdwot main app destroy"),$(".copy-to-sc.modal").remove()},this.after("initialize",function(){t=this,debug("wdwot mapp init"),flight.component(LL.Pane).attachTo("#waterfall"),this.trigger("wdwot:initialized"),this.trigger("navbar:show:1",{target:"#wdwot-1"}),this.trigger("navbar:show:2",{target:"#wdwot-place"}),this.on(document,"mapp:destroy",this.onWDWOTDestroy),this.on(document,"mapp:regions:switched",this.onSwitchedRegions),this.on(document,"mapp:regions:history",this.onRegionHistory),this.on(document,"mapp:gps:found",this.onFoundGPS),this.on("#overview .new-map","click",this.onClickNewSCMap),LL.WDWOTStats||(LL.WDWOTStats=flight.component(wdwotStats,LL.StatsBase,LL.ByRegion,LL.Charts)),LL.WDWOTStats.attachTo("#overview.tab-pane",{initialPath:this.attr.outlinePath}),LL.Property.attachTo("#search.tab-pane",{}),LL.Search.attachTo("#search-form",{ajax:!0,contextPath:this.attr.outlinePath,mapp:!0}),$("#wdwot-place a[href='#query']").exists()&&($("#query.tab-pane").removeClass("hide"),LL.Query.attachTo("#query.tab-pane",{})),$("#wdwot-place a[href='#census']").exists()&&LL.Census.attachTo("#census.tab-pane",{}),LL.Table.attachTo("#list.tab-pane",{}),LL.Drawing.attachTo("#mapbox",{paraffin:this.attr.paraffin,leaflet:this.attr.leaflet}),LL.Templates.preload(["data_request"])})}LL.WDWOTMapp=flight.component(t,LL.Mapp)}(),LL.Bin=function(){var t=null,e={},i={},n={},o={},s=null;this.attributes({channels:[]}),this.onRadioReceived=function(t,e){if("blext"==e.message_type)if("create"==e.action){var i=this.find(e.id);i?(this.remove(i.id),this.add(e)):this.add(e)}else"remove"==e.action&&this.remove(e.id)},this.onRequestClear=function(){this.clear()},this.onRequestFetch=function(t,e){var i="",n={style:"geojson",query:e.query};e.mapSlug||e.mapPath?(i=e.mapPath||"/m/"+e.mapSlug,url=i+"/blexts.json"):(i="/",url=e.path+"/properties.json"),s&&(debug("bin canceling current XHR"),s.abort(),s=null),$("#mapbox .loading-parcels").removeClass("nope"),s=$.post(url,n,function(t){"error"==t.status?this.trigger("bin:too-many",{count:t.count,max:t.max}):this.add(t)}.bind(this)).fail(function(){debug("Error fetching properties: "+url)}).always(function(){s=null,$("#mapbox .loading-parcels").addClass("nope")})},this.clear=function(){return this.clearFilters(),_.each(i,function(t){t.dispose()}),n={},t.remove(),this.trigger("bin:clear"),!0},this.clearFilters=function(){return _.each(o,function(t){t.filterAll()}),_.each(i,function(t){t.filterAll()}),!0},this.reapplyFilters=function(){return _.each(i,function(t,e){t.filterFunction(n[e])}),!0},this.size=function(){return crossfilter.size()},this.add=function(t){return"FeatureCollection"==t.type?(this.trigger("bin:add",t),!0):"Feature"==t.type?(this.trigger("bin:add",t),!0):(debug("Oops, don't know how to add "+JSON.stringify(t)),!1)},this.remove=function(t){var i=$.type(t);if("number"==i||"string"==i){o.id.filter(t);var n=o.id.top(1/0);return n.length>0&&this.trigger("bin:remove",t),o.id.remove(),o.id.filterAll(),delete e[t],t}};var r=function(t){return"tags"==t?function(t){return t.properties.tags||[]}:function(e){return e.properties.fields?e.properties.fields[t]:""}},a=function(t,e){return"tags"==t?function(t){return _.intersection(e,t).length>0}:function(t){return _.contains(e,t)}};this.setFilters=function(e){for(var o in i)e[o]||i[o].dispose();for(var s in e){var l=(r(s),a(s,e[s]));i[s]=t.dimension(),n[s]=filterFunction(l)}return!0},this.filtered=function(){var t=o.created_at.top(1/0);return{type:"FeatureCollection",features:t}},this.all=function(){this.clearFilters();var t=o.created_at.top(1/0);return this.reapplyFilters(),t};this.find=function(t){return e[t]},this.recent=function(t){var e=o.created_at.top(t);return o.filterAll(),e},this.onDestroy=function(){debug("destroy: parcelbin & unsubscribing"),this.trigger("radio:unsubscribe",{channels:this.attr.channels}),this.teardown()},this.after("initialize",function(){t=crossfilter([]),o.id=t.dimension(function(t){return t.properties.id}),o.created_at=t.dimension(function(t){return t.properties.created_at_i}),this.on(document,"radio:received",this.onRadioReceived),this.on(document,"bin:request:clear",this.onRequestClear),this.on(document,"bin:request:fetch",this.onRequestFetch),this.on(document,"mapp:destroy",this.onDestroy),this.trigger("radio:subscribe",{channels:this.attr.channels}),this.trigger("bin:initialized")})},LL.Billing=function(){this.attributes({hasSub:!1,subId:!1,clientToken:!1,currentPlan:!1,currentCycle:!1,offer:!1,cardToken:!1,cardInfo:!1,showWallet:!1,canCancel:!1});var t=!1,e=null,i=null,n=null;this.onCardUpdated=function(t){"ok"==t.status?$("p.summary").text(t.message):$("#wallet").trigger("wallet:message",{lines:[t.message]})},this.onCardChosen=function(t,e){if(this.attr.hasSub){var i=LL.Spinner.start();$.ajax(s.sprintf("/account/subscriptions/%d.json",this.attr.subId),{method:"PUT",data:{payment_method_token:e.cardToken},success:this.onCardUpdated.bind(this)}).always(function(){LL.Spinner.stop(i)})}else cardToken=e.cardToken,$("#billing .cards .create-sub").removeClass("hide")},this.onClickChangePlan=function(t){$(".plans",this.$node).slideToggle(),t.preventDefault()},this.onClickPlan=function(t){var o=$(t.target).closest("a").data("tier");if(e=o,n=$(t.target).closest(".plan").data("name"),$(".plan a.btn i.fa",this.$node).addClass("hide"),$(s.sprintf(".plan[data-tier=%s] a.btn i.fa",o),this.$node).removeClass("hide"),"annual"==this.attr.currentCycle)i=this.attr.currentCycle;else{var r=$(".cycles",this.$node);r.is(":visible")||r.slideDown()}e&&i&&this.showConfirmation(),t.preventDefault()},this.onClickCycle=function(t){i=$(t.currentTarget).attr("data-cycle"),$(".cycles a.btn.cycle i.fa",this.$node).addClass("hide"),$(s.sprintf(".cycles a.btn.cycle[data-cycle=%s] i.fa",i),this.$node).removeClass("hide"),e&&i&&(e!=this.attr.currentPlan||i!=this.attr.currentCycle)&&this.showConfirmation(),t.preventDefault()},this.showConfirmation=function(){var t=s.sprintf("You are choosing the <b>%s</b> plan on the <b>%s</b> billing schedule. Charges are applied immediately and prorated based on the time you've used.",n,i);$(".confirm-message",this.$node).html(t),$(".confirm",this.$node).is(":visible")||$(".confirm",this.$node).slideDown()},this.onClickConfirmChange=function(n){if(t)return!1;t=!0;var o=$(n.currentTarget);o.text("Working...").attr("disabled","1");var s=LL.Spinner.start();$.ajax("/account/subscriptions/update.json",{method:"PUT",data:{plan:e,cycle:i},success:function(t){"ok"==t.status?($(".confirm-message").text("We've successfully applied these changes. Please reload the page to see them in effect."),$(".confirm-change").remove(),o.text("Thank you!"),$("#plan > p.lead, #plan .plans, #plan .cycles").slideUp()):($(".confirm-message").text("There was an error :"+t.message),o.text("Confirm These Changes").removeAttr("disabled"))}}).fail(function(){$(".confirm-message").text("We had a problem saving these changes, sorry!"),$(".confirm-change").removeAttr("disabled")}).always(function(){LL.Spinner.stop(s)}),n.preventDefault()},this.onClickSubscribe=function(e){if(t)return!1;t=!0,$(e.currentTarget).attr("disabled","1");var i=LL.Spinner.start();$.ajax("/account/subscriptions.json",{method:"POST",data:{card_token:cardToken,plan:offer?offer.plan:currentPlan,offer:offer},success:function(t){"ok"==t.status?($(".summary").text("Congratulations, we've successfully subscribed your account! Thank you!"),$(".create-sub").remove(),window.location.reload()):($(".summary").text("There was an error creating your subscription."),$(".create-sub").removeAttr("disabled"))}}).fail(function(){$(".summary").text("There was an error creating your subscription."),$(".create-sub").removeAttr("disabled")}).always(function(){LL.Spinner.stop(i)}),e.preventDefault()},this.onLeaving=function(){debug("destroy: billing"),this.teardown()},this.after("initialize",function(){this.on(document,"pjax:beforeSend",this.onLeaving),this.on("a.yes","click",this.onClickPlan),this.on("a.cycle","click",this.onClickCycle),this.on("a.change-plan","click",this.onClickChangePlan),this.on("a.confirm-change","click",this.onClickConfirmChange),this.attr.showWallet&&(flight.component(LL.Wallet).attachTo("#wallet",{clientToken:this.attr.clientToken,cardInfo:this.attr.cardInfo,originalCardToken:this.attr.cardToken,cardClass:"col-md-6"}),this.on("wallet:chosen",this.onCardChosen)),this.on("#billing .cards .create-sub","click",this.onClickSubscribe),debug("initializing Billing")})},LL.Importer=function(){this.attributes({basePath:"/maps/new",mapRoot:!1});var t=null;this.onClickType=function(t){var e=$(t.currentTarget);if(t.preventDefault(),!e.attr("disabled")){var i=e.data("type");$("#types .type").removeClass("active"),e.addClass("active");var n="esri"==i||"socrata"==i||"enigma"==i||"accela"==i,o=n?"api":i,s=$("#"+o+".source");$(".source:not(#"+i+")").slideUp(),s.removeClass("hide").hide().slideDown(),$(".subsection:not(."+i+")",s).addClass("hide"),$(".subsection."+i,s).removeClass("hide"),$("input[name=subtype]").val(n?i:"")}};var e=function(t){return t.length>0&&t.match(/^http/)};this.onClickPostURL=function(t){t.preventDefault();var i=$("#api input[name=url]").val(),n=$("#api input[name=subtype]").val();if(e(i)){var o=$("#post-url");o.text("Connecting...").attr("disabled","true");var s=LL.Spinner.start();$.post(this.attr.basePath+"/import-2.json",{url:i,type:n},function(t){"ok"==t.status?(debug(t),this.showPreview(t),o.removeAttr("disabled").off("click").text("Successfully connected!")):(this.trigger("notify:message",{message:t.message}),o.removeAttr("disabled"))}.bind(this)).fail(function(){$("#post-url").text("Oops, there was a problem loading this data set").removeAttr("disabled")}.bind(this)).always(function(){LL.Spinner.stop(s)}.bind(this))}},this.showPreview=function(t){LL.Templates.fetch("import_preview",function(e){if(t.orderlySample=_.collect(t.sample,function(e){return _.collect(t.header,function(t){return e[t.key]})}),$("#preview .table-wrapper").html(e(t)),$("#preview").data("id",t.id).fadeIn(),t.parcel_guess){var i=t.parcel_guess.key;$(".preview th[data-column='"+i+"'] .pin").addClass("active"),this.guessCity(i)}this.attr.newMap&&$("#preview .map_def").removeClass("hide")}.bind(this))},this.onClickPin=function(t){if($("#preview").hasClass("too-big"))return!1;$(".preview .pin").removeClass("active"),$(t.target).addClass("active");var e=$(t.target).parent().data("column");return this.guessCity(e),!1},this.onClickCityGuess=function(e){var i=$(e.target).closest("h3");$(".guess h3 > .fa").addClass("hide"),$(".fa",i).removeClass("hide"),$("#finish").removeAttr("disabled"),t=$(e.target).data("path"),e.stopPropagation()},this.initUpload=function(){$("#fileupload").fileupload({autoUpload:!0,url:this.attr.basePath+"/import-2.json",processQueue:[{action:"validate",always:!0,acceptFileTypes:/(\.)(csv|xls|xlsx|shp)$/i}],drop:function(){},add:function(t,e){$("#finish").attr("disabled","1"),$("#upload-target .fa").replaceWith("<i class='fa fa-refresh fa-spin'/>"),$("#upload-target .btn h3").text("Uploading...");e.submit().success(function(t){"ok"==t.status?($("#upload-target .fa").replaceWith("<i class='fa fa-check'/>"),$("#upload-target .btn h3").text("Success!"),$("#upload-target h3.hint").slideUp(),this.showPreview(t)):($("#upload-target .fa").replaceWith("<i class='fa fa-meh-o'/>"),$("#upload-target .btn h3").text("Select a File"),$("#upload-target .hint").text(t.message))}.bind(this)).error(function(t,e,i){debug(i),$("#upload-target .fa").replaceWith("<i class='fa fa-bomb'/>"),this.trigger("notify:message",result),$("#upload-target .btn h3").text("Select a File"),$("#upload-target .hint").text("Oh my, that didn't work.")}.bind(this)).complete(function(){})}.bind(this)})},this.grabColumns=function(){return _.collect($("th[data-column]"),function(t){return $(t).data("column")})},this.guessCity=function(t){var e=_.collect($("#preview thead th"),function(t){return $(t).data("column")}),i=_.indexOf(e,t);if(-1!=i){var n=$("#preview tr > td:nth-child("+(i+1)+")").slice(0,3),o=_.collect(n,function(t){return $(t).text()});$.post(this.attr.basePath+"/import-guess.json",{pins:o},function(t){"ok"==t.status?(debug(t.guesses),LL.Templates.fetch("import_guess",function(e){$("#preview .guess").html(e(t))})):this.trigger("notify:message",t)}.bind(this))}};var i=function(e){var i="<div class='centered'><p class='lead'>We've successfully started your import! It may take several minutes to complete for large datasets.</p><a href='"+e.path+"' class='btn btn-primary btn-lg'>Go to your map</a></div>";$("#importer #finish").fadeOut().replaceWith(i).fadeIn(),trackIntercomEvent("upload-data",{where:t,map_path:e.path})};this.onClickFinish=function(e){if($(e.currentTarget).attr("disabled"))return!1;$(e.currentTarget).attr("disabled","1");var n=$("#preview").data("id"),o=$(".pin.active").closest("th").data("column"),s=this.grabColumns(),r={ss_id:n,parcel_column:o,column_keys:s,root_path:t};return $.post(this.attr.basePath+"/import-3.json",r,i).fail(function(){$(".messages",this.$node).text("There was an error finishing this upload!").fadeIn(),$("#finish",this.$node).removeAttr("disabled")}.bind(this)),!1},this.onSubmitPaste=function(t){var e=$("input#tag").val(),i=$("input#list").val();0==e.length?(alert("You need to specify a tag for these properties!"),t.preventDefault()):0==i.length?(alert("Enter a list of parcel numbers please. They look like '16006256.'"),t.preventDefault()):-1!=e.indexOf(",")&&(alert("Please only enter one tag (it may not contain commas)"),t.preventDefault())},this.onClickDBConnectUNUSED=function(t){var e=$(t.target).data("table");$.post("#{@base_path}/import-4",{table:e},function(t){t.num_rows=numberWithCommas(t.num_rows),$("#db > h3").text(e),$("#db .table-wrapper").html(tableTemplate(t)),$("#db #db-preview").fadeIn(),t.parcel_guess&&$(".preview th[data-column='"+t.parcel_guess+"'] .pin").addClass("active")}),t.preventDefault()},this.onLeaving=function(){debug("destroy: importer"),this.teardown()},this.after("initialize",function(){this.on(document,"pjax:beforeSend",this.onLeaving),this.on("#types .type","click",this.onClickType),this.on("#finish","click",this.onClickFinish),$("#preview").on("click","table .pin",this.onClickPin.bind(this)),$("#preview").on("click",".guess a",this.onClickCityGuess.bind(this)),this.on("form#paste_form","submit",this.onSubmitPaste),this.on("#api #post-url","click",this.onClickPostURL),debug("initializing Importer"),t=this.attr.mapRoot,this.initUpload()})},LL.RegionEditor=function(){this.attributes({regions:{},mapPath:null,flags:{}});var t=null;this.editableTitles=function(){$(".folder .editable.title",this.$node).each(function(t,e){var i=$(e).closest(".folder").data("key");$el.editable({mode:"inline",type:"text",url:this.attr.mapPath+"/settings/regions/"+i+".json",inputclass:"form-control input-med",ajaxOptions:{method:"PUT",dataType:"json"},emptytext:"Enter a title for the folder"}).on("save",function(){}.bind(this))})},this.makePaths=function(){var t={};return $(".folder",this.$node).each(function(t,e){var i=$(".title",e).text(),n=[];$(".contents",e).each(function(t,e){var i=$(e).data("path");n.push(i)}),o[i]=n}),t},this.onClickAddFolder=function(){},this.onClickRemove=function(t){var e=$(t.currentTarget).closest("tr.region"),i=e.closest(".folder").data("key"),n=e.data("path");return debug(n),"true"==e.attr("data-pending")?void t.preventDefault():(e.attr("data-pending","true"),e.css("opacity","0.5"),$.ajax({url:this.attr.mapPath+"/settings/regions/"+i+".json",type:"DELETE",data:{path:n},success:function(t){"ok"==t.status?e.fadeOut():(e.css("opacity","1"),$("td.name",e).append("<span class='error'>"+t.message+"</span>"))}.bind(this)}),void t.preventDefault())},this.onClickSave=function(t){t.preventDefault()},this.after("initialize",function(){t=this.attr.regions;var e=this.attr.flags;e.rename_folders&&this.editableTitles(),e.add_folders&&this.on(".add-folder","click",this.onClickAddFolder),e.library&&$(".library .more-btn").moreButton(),e.reorder&&$(".folder .contents > tbody",this.$node).sortable({handle:".handle"}),this.on(".contents .region .remove","click",this.onClickRemove),this.on(".save","click",this.onClickSave)})},LL.Source=function(){this.attributes({definition:null,mapPath:null,basePath:""}),this.onClickRemove=function(t){var e=$(t.currentTarget),i=this.attr.definition.id,n=confirm("Are you sure you want to remove this source? If you created and own it, it will be deleted for everyone and there's no undo. If it's a shared dataset, it will only be unlinked from your map.");n&&(e.attr("disabled","true"),this.removeSource(i)),t.preventDefault()},this.removeSource=function(t){this.$node.css("opacity",.5),$.ajax({async:!0,type:"DELETE",url:this.attr.basePath+"/sources/"+t+".json",cache:!1,success:function(){this.$node.fadeOut().delay(1e3).remove()}.bind(this),error:function(){this.$node.css("opacity",1)}.bind(this)})},this.onClickSave=function(t){this.saveChanges(),t.stopPropagation()},this.onClickCancel=function(t){$(".edit",this.$node).trigger("more:hide"),t.stopPropagation()},this.showNotice=function(){$(".edit-source .notice",this.$node).remove(),$(".edit-source",this.$node).append("<p class='notice'>"+response.message+"</p>")},this.saveChanges=function(){var t={};$(".edit-source input[type=text]",this.$node).each(function(e,i){var n=$(i).data("key"),o=$(i).val();t[n]=o}),$(".edit-source input[type=checkbox]",this.$node).each(function(e,i){var n=$(i).data("key"),o=$(i).is(":checked")?"1":"0";t[n]=o});var e=$(".save",this.$node),i=$(".edit",this.$node);e.text("Saving..."),$.ajax({async:!0,type:"PUT",url:"/sources/"+this.attr.definition.id+".json",data:t,cache:!1,success:function(t){"ok"==t.status?(e.text("Saved!"),$(".source-name",this.$node).text(t.source.name),setTimeout(function(){i.trigger("more:hide"),e.text("Save Changes")},2e3)):(this.showNotice(t.message),e.text("Save Changes"))}.bind(this),error:function(){this.showNotice("We couldn't save these changes!"),e.text("Save Changes")}.bind(this)})},this.after("initialize",function(){var t=this.attr.definition;t.id=t.id||t.type.toLowerCase();var e=".source[data-id="+this.attr.definition.id+"] ";this.on(e+" .save","click",this.onClickSave),this.on(e+" .remove","click",this.onClickRemove),this.on(e+" .cancel","click",this.onClickCancel),(this.attr.definition.permissions.update||this.attr.definition.permissions.destroy)&&$(".edit",this.$node).removeClass("hide").moreButton(),LL.Templates.preload(["source"])})},LL.SourceBrowser=function(){this.attributes({basePath:"",sourceData:{},maxSources:!1}),this.setup=function(){this.attr.sourceData.sources?this.render(this.attr.sourceData):this.fetchSources()},this.fetchSources=function(){var t=LL.Spinner.start();$.get(this.attr.basePath+"/sources.json",function(t){"ok"==t.status&&(t.basePath=this.attr.basePath,this.render(t))}.bind(this)).always(function(){LL.Spinner.stop(t)}.bind(this))},this.render=function(t){LL.Templates.fetch("source_browser",function(e){var i=e(t);if(this.$node.html(i),this.postRender(),_.some(t.sources.map,function(t){return"Survey"==t.type})){var n=this.$node.closest(".row");$(".create-survey",n).hide()}}.bind(this))},this.onClickSource=function(t){t.preventDefault();var e=$(t.currentTarget),i=e.data("id"),n=e.data("name"),o=e.data("group");if(debug("you clicked src "+i+" / "+n),this.attr.basePath.length>0){var r=confirm(s.sprintf("Would you like to add '%s' from %s to this map?",n,o));if(!r)return;$.post(this.attr.basePath+"/sources/add/"+i+".json",{},function(t){"ok"==t.status?(this.trigger("source:added",t.source),e.fadeOut().delay(1e3).remove()):this.trigger("notify:message",{message:t.message})}.bind(this))}},this.postRender=function(){$(".source-options > a.btn").moreButton()},this.onLeaving=function(){debug("source browser destroying"),this.trigger("source-browser:destroy"),this.$node.empty(),this.teardown()},this.after("initialize",function(){debug("source browser init"),this.on(document,"pjax:beforeSend",this.onLeaving),this.$node.on("click","a.source-option",this.onClickSource.bind(this)),LL.Templates.preload(["source_browser","source_option"]),this.setup()})},LL.SourceEditor=function(){this.attributes({basePath:"",mapPath:null,sourceData:{},maxSources:!1}),this.setup=function(){this.attr.sourceData.sources?this.render(this.attr.sourceData):this.fetch()},this.fetch=function(){var t=LL.Spinner.start();$.get(this.attr.basePath+"/sources.json",function(t){"ok"==t.status&&this.render(t)}.bind(this)).always(function(){LL.Spinner.stop(t)}.bind(this)),this.createInterface(data)},this.render=function(t){_.each(t.sources.map,function(t){t.mapPath=this.attr.mapPath,t.admin=window.data.admin}.bind(this)),LL.Templates.fetch("source_editor",function(e){this.$node.html(e(t)),this.postRender(t.sources.map)}.bind(this))},this.onAddedSource=function(t,e){LL.Templates.fetch("source",function(t){$(".source-index",this.$node).append(t(e)),this.postRender([e])}.bind(this))},this.postRender=function(t){_.each(t,function(t){var e=t.id||t.type.toLowerCase(),i=$(".source[data-id="+e+"]");flight.component(LL.Source).attachTo(i,{definition:t,basePath:this.attr.basePath,mapPath:this.attr.mapPath})}.bind(this))},this.onLeaving=function(){debug("source editor destroying"),this.trigger("source-editor:destroy"),this.$node.empty(),this.teardown()},this.after("initialize",function(){this.on(document,"pjax:beforeSend",this.onLeaving),this.on(document,"source:added",this.onAddedSource),LL.Templates.preload(["source_editor","source","column_editor"]),this.setup()})},LL.StyleEditor=function(){this.attributes({options:[],rules:[],mapPath:null,predicates:{}});var t=[],e=[],i=null,n=null;this.buildOptions=function(){var t=[],e={};return _.each(this.attr.options,function(i){var n=[];_.each(i.filters,function(t){t.id;n.push({id:t.key,text:t.label}),t.checkboxes&&(e[t.key]=_.map(t.checkboxes,function(t,e){return{id:e,text:t}}))}),t.push({text:i.name,children:n})}),debug(t),debug(e),{keys:t,values:e}},this.getFieldOptions=function(t){t.callback({results:i})},this.buildValueOptions=function(t){var e=$(".field",t).val();return n[e]||[]},this.buildPredicateOptions=function(t){var e=$(".field",t).val(),i=this.attr.predicates["tags"==e?"tags":"fields"],n=_.map(i,function(t){return{id:t,text:t}});return n},this.onFieldChanged=function(t,e){var i=$(e.currentTarget).val(),t=$(e.currentTarget).closest(".rule"),n=$(".predicate",t),o=$(".value",t);if(n.data("select2")){var s=n.data("select2").dataAdapter,r=o.data("select2").dataAdapter;s.setData(this.buildPredicateOptions(t)),r.setData(this.buildValueOptions(t))}var a="tags"==i?"contains":"is";n.val(a).trigger("change"),o.val(null).trigger("change")},this.randomColor=function(){return chroma.hsv(Math.round(360*Math.random()),1,.7).hex()},this.renderEditor=function(){for(var t in e)"default"!=e[t].predicate&&this.addRule(e[t]);0==e.length&&this.addRule({})},this.rulesFromControls=function(){var t=[];return $("#rules .rule",this.$node).each(function(e,i){t.push({field:$(".field",i).val(),predicate:$(".predicate",i).val(),value:$(".value",i).val(),fill:$(".color",i).val()})}),t.push({predicate:"default",fill:$("#default-rule .color").val()}),t},this.onClickAddRule=function(t){this.addRule({}),t.preventDefault()},this.addRule=function(t){var e=$.extend({},t,{color:t.fill||this.randomColor()});LL.Templates.fetch("color_rule",function(t){this.renderRule(t,e)}.bind(this))},this.renderRule=function(t,e){var n=t(e);$("#rules",this.$node).append(n);var o=$("#rules .rule:last-child",this.$node),s={allowClear:!1,minimumResultsForSearch:15,width:"off"};$(".field",o).select2($.extend({},s,{data:i,placeholder:"Data field name"})).on("change",this.onFieldChanged.bind(this,o)).val(e.field).trigger("change"),$(".predicate",o).select2($.extend({},s,{data:this.buildPredicateOptions.bind(this,o)})).val(e.predicate).trigger("change");var r=$.extend({},s,{data:this.buildValueOptions.bind(this,o),placeholder:"a certain value"});$(".value",o).select2(r).val(e.value).trigger("change"),$("input[type=minicolors]",o).minicolors({inline:!1,theme:"bootstrap"})},this.onClickSave=function(){var t=this.rulesFromControls();debug(t);var e={rules:JSON.stringify(t)};return trackIntercomEvent("save-styles",{map_path:this.attr.mapPath}),$.post(this.attr.mapPath+"/settings/colors.json",e,this.onSaved.bind(this)),!1},this.onSaved=function(t){"ok"==t.status?window.location=this.attr.mapPath:debug(t)},this.onClickRemoveRule=function(t){var e=$(t.currentTarget).closest(".rule");return e.remove(),!1},this.onClickClone=function(t){var e=($(t.currentTarget).data("id"),$(t.currentTarget).data("slug")),i=LL.Spinner.start();$("#clone-more").css("opacity",.5),$.get("/m/"+e+"/settings/colors.json",function(t){"ok"==t.status&&_.each(t.rules,function(t){this.addRule(t)}.bind(this))}.bind(this)).always(function(){LL.Spinner.stop(i),$("#clone-more").css("opacity",1)}.bind(this))},this.after("initialize",function(){e=this.attr.rules,t=this.attr.options;var o=this.buildOptions();i=o.keys,n=o.values,this.on("a.save-styles","click",this.onClickSave),$("#style-sidebar .btn.clone-styles").on("click",this.onClickClone.bind(this)),this.$node.on("click","a.add-rule",this.onClickAddRule.bind(this)),this.$node.on("click","a.remove-rule",this.onClickRemoveRule.bind(this)),$("#rules",this.$node).sortable({handle:".handle"}),$("#default-rule input[type=minicolors]").minicolors({inline:!1,theme:"bootstrap"}),LL.Templates.preload(["color_rule"]),this.renderEditor()})},LL.SurveyEditor=function(){this.attributes({questions:[],mapPath:null,sourceId:!1,readOnly:!1,defaultQuestions:[]});var t=null,e=[],i=!1,n=!1;this.loadQ=function(t){$(".questions",this.$node).empty(),n=t,n&&(e=this.attr.defaultQuestions);for(var i in e)this.addQuestion(e[i]);0==$(".question",this.$node).length&&this.addQuestion(),this.updateNext()},this.onClickSave=function(){return this.save(),!1},this.save=function(){var o=this.formatSurvey();e=o,i?alert("You can't leave a question or answer blank."):(t||trackIntercomEvent("create-survey",{map_path:this.attr.mapPath,num_questions:n?null:e.length}),$.ajax({type:"POST",url:this.attr.mapPath?this.attr.mapPath+"/settings/survey.json":"/maps/new/survey.json",data:{source_id:t,map_name:$("#edit-survey input[name=map_name]").val(),survey_type:n?"default":"custom",questions:JSON.stringify(o)},success:this.onSaved.bind(this)}))},this.removeQuestion=function(t){t.remove()},this.addQuestion=function(t){$("#question-form .questions").append(this.attr.templates.question());var e=$(".questions .question").last(),i=null;if(t){if($("input[name=text]",e).val(t.question),$("input[name=column]",e).val(t.column),"TEXTAREA"==t.answers)$("select.question-type",e).val("text"),$(".multi",e).addClass("hide");else for(var n in t.answers){var o=t.answers[n];this.addAnswer(e,o)}t.disambiguation&&(i=t.disambiguation,e.data("disambiguation",t.disambiguation))}else this.addAnswer(e),this.addAnswer(e);e.attr("data-guid",i||guid()),$(".answers",e).sortable({})},this.addAnswer=function(t,e){$(".answers",t).append(this.attr.templates.answer());var i=$(".answers .answer",t).last();e&&($("input[name=label]",i).val(e.label),$("input[name=value]",i).val(e.value),e.next&&$("select.set-next-question",i).attr("data-column",e.next))},this.removeAnswer=function(t){t.remove()},this.setNext=function(t){var e=$(t.currentTarget),i=e.val();n=!1,e.data("guid",i)},this.updateNext=function(){$(".set-next-question",this.$node).empty(),$(".set-next-question",this.$node).append('<option value="default">Continue to next question</option>'),$(".question",this.$node).each(function(t,e){var i=$(e).data("guid"),n=$(e).data("disambiguation"),o=n||$("input[name=column]",e).val(),r=$("input[name=text]",e).val();if(debug("Adding "+o+" to each dropdown"),$(".number",$(e)).text(t+1),r.length>0){var a=$(".question",this.$node).slice(0,t);$(".set-next-question",a).append(s.sprintf("<option value='%s' data-column='%s'>%s</option>",i,o,r))}$(".set-next-question[data-column='"+o+"']").each(function(t,e){debug("for "+o+" we're pointing the nexts to it"),$(e).data("guid",i)})}),$("select.set-next-question",this.$node).each(function(t,e){var i=$(e).closest(".question"),n=$(e).closest(".answer"),o=$("input[name=text]",i).val(),s=$("input[name=label]",n).val(),r=$(e).data("column"),a=$(e).data("guid");if(a)debug("select.next-question in "+o+" / "+s+" has guid "+a),$(e).val(a);else if(r){debug("select.next-q for "+o+" / "+s+" has column set "+r);var l=$("option[data-column='"+r+"']",e);a=l.attr("value"),$(e).val(a)}})},this.changeQuestionType=function(t,e){"multiple"==t?$(".multi",e).removeClass("hide"):"text"==t&&$(".multi",e).addClass("hide")
},this.fail=function(t,e,n,o){alert(t),i=!0,$(e.currentTarget).focus().on(n,function(t){o(t)&&(i=!1)})},this.formatSurvey=function(){var t=[];return $(".questions .question",this.$node).each(function(e,i){var n=$("input[name=text]",i).val(),o=$("input[name=column]",i).val(),s=$(i).data("disambiguation")||$(i).data("guid"),r={question:n,column:o,answers:[]};s&&(r.disambiguation=s),"multiple"==$("select.question-type",i).val()?$(".answer",i).each(function(t,e){var i=$("input[name=label]",e).val(),n=$("input[name=value]",e).val(),o={label:i,value:n},s=$("select.set-next-question",e).val();if("default"!=s){var a=$(".question[data-guid='"+s+"']");if(a.exists()){var l=a.data("disambiguation")||s,h=$("input[name=column]",a).val();o.next=l||h}}i.length>0&&r.answers.push(o)}):r.answers="TEXTAREA",r.question.length>0&&r.answers.length>0&&t.push(r)}),t},this.onSaved=function(e){"ok"==e.status?(t=e.source_id,$("#edit-survey .save-survey").removeClass("btn-primary").addClass("btn-success").text("Saved!"),$("#edit-survey .view-map").removeClass("btn-default").addClass("btn-primary").removeClass("hide"),setTimeout(function(){$("#edit-survey .save-survey").removeClass("btn-success").addClass("btn-primary").text("Save Survey")},1e4)):$("#edit-survey .save-survey").removeClass("btn-primary").addClass("btn-warning").text(e.message)},this.onChangeText=function(t){var e=t.target.value;n=!1;var i=$(t.target).attr("name");if(""===e)return void this.fail("This can't be left blank.",t,"change",function(t){return!(""===t.target.value)});if("label"==i||"text"==i){var o=e;$(t.target).next("input[name=column], input[name=value]").val(o),this.updateNext()}},this.after("initialize",function(){t=this.attr.sourceId,LL.Templates.fetch(["survey_question","survey_answer"],function(t){this.attr.templates={question:t.survey_question,answer:t.survey_answer},e=this.attr.questions||[],this.loadQ()}.bind(this)),$("#edit-survey .btn.new-survey").click(function(){e=[],this.loadQ(!1)}.bind(this)),$("#edit-survey .btn.use-mcm").click(function(){this.loadQ(!0)}.bind(this)),$("#edit-survey .btn.reset-survey").click(function(){e=this.attr.questions,this.loadQ()}.bind(this)),$("#edit-survey .btn.clone-survey").click(function(t){var e=$(t.currentTarget).data("id"),i=LL.Spinner.start();$("#clone-more").css("opacity",.5),$.post(this.attr.mapPath+"/settings/clone_survey.json",{from:e},function(t){"ok"==t.status&&location.reload()}).always(function(){LL.Spinner.stop(i),$("#clone-more").css("opacity",1)}.bind(this))}.bind(this)),this.attr.readOnly?$("#edit-survey .btn.save-survey").attr("disabled","1").text("Saving is disabled"):$("#edit-survey .btn.save-survey").click(this.onClickSave.bind(this)),$(".questions",this.$node).on("change",'input.form-control[type="text"]',this.onChangeText.bind(this)),$(".questions",this.$node).on("change",".question-type",function(t){var e=$(t.currentTarget).val(),i=$(t.currentTarget).closest(".question");n=!1,this.changeQuestionType(e,i)}.bind(this)),$("#question-form").on("click",".add-question",function(){n=!1,this.addQuestion(),this.updateNext()}.bind(this)),$("#question-form").on("click",".add-answer",function(t){n=!1,this.addAnswer($(t.target).closest(".question"))}.bind(this)),$("#question-form").on("click",".remove-question",function(t){var e=confirm("Really remove this question?");return e&&(n=!1,this.removeQuestion($(t.currentTarget).closest(".question"),!0)),!1}.bind(this)),$("#question-form").on("click",".remove-answer",function(t){n=!1,this.removeAnswer($(t.currentTarget).closest(".answer"))}.bind(this)),$("#question-form").on("change",".set-next-question",this.setNext.bind(this)),$("#question-form .questions").sortable({stop:function(){this.updateNext()}.bind(this)})})},LL.FeedFilters=function(){this.attributes({}),this.after("initialize",function(){})},LL.HashState=function(){var t="m";this.attributes({leaflet:null}),this.parseHash=function(t){var e=t.split("/");if(3==e.length){var i=parseInt(e[0],10),n=parseFloat(e[1]),o=parseFloat(e[2]);return isNaN(i)||isNaN(n)||isNaN(o)?!1:{center:new L.LatLng(n,o),zoom:i}}return!1},this.formatHash=function(t){var e=t.getCenter(),i=t.getZoom(),n=Math.max(0,Math.ceil(Math.log(i)/Math.LN2));return[i,e.lat.toFixed(n),e.lng.toFixed(n)].join("/")},this.onMapMove=function(){if(this.movingMap||0===this.attr.leaflet.getZoom())return!1;var e=this.formatHash(this.attr.leaflet);if(this.lastHash!=e){this.lastHash=e;var i={};i[t]=e,$.bbq.setState(i)}},this.changeDefer=100,this.onHashChange=function(){if(debug("hashstate.hashchange"),!this.changeTimeout){var t=this;this.changeTimeout=setTimeout(function(){t.changeTimeout=null},this.changeDefer)}},this.onDestroy=function(){debug("hashstate destroying"),this.off(window,"hashchange",this.onHashChange),this.attr.leaflet.off("moveend")},this.after("initialize",function(){debug("hashstate hello"),this.lastHash=null,this.movingMap=!1,this.on(window,"hashchange",this.onHashChange),this.attr.leaflet.on("moveend",this.onMapMove.bind(this)),this.on("mapp:destroy",this.onDestroy)})},$.bbq.setState=function(t){var e=$.param.fragment(location.href,t);window.location.replace(e)},function(t){t.fn.moreButton=function(e){return this.each(function(){function i(t){return t?"fa-caret-down":"fa-caret-right"}function n(){var e=t(".more-caret",r);if(debug("decorating "+a+" with show="+h+" and the caret class is "+i(h)),!e.exists()){var n=i(h),o="&nbsp;<i class='fa "+n+" more-caret'/>";r.append(o)}}function o(t){h=!h,s(h),t.preventDefault()}function s(){h?l.removeClass("hide").hide().slideDown():l.slideUp(),t("i.fa.more-caret",r).attr("class","fa more-caret "+i(h))}var r=t(this),a=r.attr("href"),l=t(a),h=!1,c=t.extend({},t.fn.moreButton.defaults,e);return this.onHide=function(){h=!1,s()},c.show=c.show||l.exists()&&!l.hasClass("hide"),c.show?(h=!0,l.removeClass("hide")):(h=!1,l.addClass("hide")),n(),r.click(o),r.on("more:hide",this.onHide.bind(this)),this})},t.fn.moreButton.defaults={show:!1}}(jQuery),LL.Dots=function(){this.attributes({paraffin:null,leaflet:null,layerID:"users"});var t=null,e=null;this.onMessage=function(i,n){if("user_position"==n.message_type){var o=n.user.id,s={type:"Feature",id:o,geometry:{type:"Point",coordinates:[n.position.lon,n.position.lat]},properties:{id:n.user.id,name:n.user.name,updated_at:moment().format("h:mm a, MMM Do"),classes:"track",email:n.user.email,phone:n.user.phone}};if(!this.attr.paraffin.overlays.users){var r={color:"#000",fill:!0,fillColor:"#00a0dd",radius:8,weight:2,opacity:.7,fillOpacity:.7};e=this.attr.paraffin.createGeoJSON({id:this.attr.layerID,name:"User Tracks",ty:"geojson",elements:[],style:r,zindex:10,interaction:!0,template:"<b>{{name}}</b><br/>Updated {{updated_at}}"}),$("#map").on("paraffin:click",this.onClickDot.bind(this)),this.attr.paraffin.overlays[this.attr.layerID]=e,this.attr.leaflet.addLayer(e)}if(!t){var a="<b>{{name}}</b><br/>Updated {{updated_at}}";t=Handlebars.compile(a)}var l=(_.pluck(e._layers,"feature"),_.filter(e._layers,function(t){return t.feature.id==o}));if(l.length>0){var i=l[0],h=L.latLng(n.position.lat,n.position.lon);i.setLatLng(h),i.feature.properties=s.properties,i._popup&&(i._popup.setLatLng(h),i._popup.setContent(t(s.properties)))}else newFeature=e.addData(s)}},this.onClickDot=function(e,i){if(i.layer.parent.paraffinId==this.attr.layerID){i.layer.popup||(i.layer.popup=new L.Popup);var n=i.layer.popup,o=i.originalEvent.latlng;n.setLatLng(o),n.setContent(t(i.feature.properties)),this.attr.leaflet.openPopup(n)}},this.after("initialize",function(){debug("dots starting up"),this.on(document,"radio:received",this.onMessage)})},function(){function t(){var t={},e=0,i=!1;this.drawControl=null,this.activated=!1,this.attributes({leaflet:null,paraffin:null,parcelLayerID:"tiles",mapSlug:!1}),this.onToggleDrawing=function(){this.activated?this.deactivate():(this.activate(),this.startPolygon())},this.activate=function(){return window.data.signed_in?(this.drawControl||this.createControl(),this.attr.leaflet.addControl(this.drawControl),void(this.activated=!0)):(alert("You need to be signed in so we can record what you draw, sorry!"),!1)},this.deactivate=function(){var t=$(this.drawControl.getContainer()).parent();t.exists()&&this.attr.leaflet.removeControl(this.drawControl),this.activated=!1,$("a.map-control[href=#drawing]").parent().removeClass("active")},this.showConfirmation=function(i){var n={id:e+1,shape:i.layer.toGeoJSON(),description:"Save your neighborhood shape",mapSlug:this.attr.mapSlug};LL.Templates.fetch("neighborhood_confirm",function(i){var o=$(i(n));$("body").append(o),$(o).modal("show").on("hidden.bs.modal",function(){$(".save-hood.modal").remove(),this.deactivate()}.bind(this)),$("input[name=name]",o).focus(),t[n.id]=n,e++,this.on(".save-hood.modal .save","click",this.onClickSave),this.on(".save-hood.modal .remove","click",this.onClickRemove)}.bind(this))},this.onSaved=function(t){var e=$(".save-hood[data-id="+t.id+"]");if("ok"!=t.status)return void $(".modal-body",e).append("<i>"+t.message+"</i><br/>");if(t.map_slug)this.trigger("mapp:regions:request",{path:t.path}),t.map_regions&&this.trigger("mapp:regions:menu",t.map_regions),e.modal("hide");else{var i=s.sprintf("Saved! <a href='%s'>You can see it here</a> and find all of your neighborhoods later on your profile page.",t.path);$(".modal-body",e).html(i),$(".modal-footer",e).remove()}},this.setMouseHandling=function(t){var e=map.overlays[this.attr.parcelLayerID];if(e)for(var i in e._layers)e._layers[i].muted=!t},this.createControl=function(){var t=this,e=new L.FeatureGroup;this.drawControl=new L.Control.Draw({position:"topleft",draw:{polyline:!1,circle:!1,marker:!1,rectangle:!1,polygon:{allowIntersection:!1,drawError:{color:"#e16000",message:"<strong>Oh snap!<strong> you can't draw that!"},shapeOptions:{color:"#0080aa"}}},edit:{featureGroup:e}}),this.attr.leaflet.on("draw:created",function(i){e.addLayer(i.layer),t.showConfirmation(i)}).on("draw:drawstart",function(){t.setMouseHandling(!1)}).on("draw:drawstop",function(){t.setMouseHandling(!0)})},this.startPolygon=function(){this.drawControl._toolbars.draw._modes.polygon&&this.drawControl._toolbars.draw._modes.polygon.handler.enable()},this.onClickSave=function(e){if(i)return!1;e.preventDefault();var n=$(e.currentTarget).data("id"),o=$(".save-hood input[name=name]").val(),s=$(".save-hood textarea").val(),r=$(e.currentTarget).data("map"),a=t[n];return o.length<2?!1:(opts={id:a.id,name:o,description:s,shape:JSON.stringify(a.shape),map_id:r},$(".save-hood .modal-footer a").attr("disabled","1"),void this.doSave(opts))},this.doSave=function(t){i=!0;var e=LL.Spinner.start();t.map_id&&trackIntercomEvent("draw-focus",{map_slug:t.map_id,name:t.name}),$.post("/neighborhoods.json",t,this.onSaved.bind(this)).fail(function(){debug("Uhh error saving neighborhood")}).always(function(){$(".save-hood .modal-footer a").removeAttr("disabled"),LL.Spinner.stop(e),i=!1})},this.onClickRemove=function(e){var i=$(e.currentTarget).data("id");return this.attr.leaflet.removeLayer(t[i].shape),delete t[i],$(e.currentTarget).closest(".modal").modal("hide"),e.preventDefault(),!1},this.onDestroy=function(){debug("destroy: drawing"),this.teardown()},this.after("initialize",function(){this.on(document,"mapp:bar:toggle-drawing",this.onToggleDrawing),this.on(document,"mapp:destroy",this.onDestroy),LL.Templates.preload("neighborhood_confirm")})}LL.Drawing=flight.component(t)}(),LL.GPS=function(){this.attributes({paraffin:null,leaflet:null,layerID:"marker"});var t=null,e=null;this.onClickGPS=function(t){t.preventDefault(),this.getGPS()},this.getGPS=function(){if(navigator.geolocation){var t=LL.Spinner.start();navigator.geolocation.getCurrentPosition(function(e){LL.Spinner.stop(t),this.trigger("mapp:gps:found",e)}.bind(this),function(){LL.Spinner.stop(t),this.trigger("mapp:gps:fail")}.bind(this),{enableHighAccuracy:!0})}},this.handleFound=function(e,i){var n=i.coords;t=n;var o=new L.LatLng(n.latitude,n.longitude),s=n.heading;this.setMarker(o,s),this.attr.leaflet.setView(o,16)},this.ensureMarkerLayer=function(){if(!paraffin.overlays[this.attr.layerID]){var t=new L.GeoJSON(this.attr.paraffin.emptyGeoJSON,{style:LL.Palette.leafletStyle("marker")});this.attr.paraffin.overlays[this.attr.layerID]=t,this.attr.leaflet.addLayer(t)}},this.setMarker=function(t){e?e.setLatLng(t):(e=new L.Marker(t),this.attr.leaflet.addLayer(e))},this.after("initialize",function(){this.on("#mapbox .gps","click",this.onClickGPS),this.on(document,"mapp:gps:found",this.handleFound);var t=$.bbq.getState("gps");"1"==t&&this.getGPS()})},LL.MapBar=function(){var t=null;this.moveToNavbar=function(){$("#mapbar").appendTo("#header #sc-map")},this.onClickBase=function(t){$(t.currentTarget).parent().toggleClass("active"),this.trigger("mapp:bar:toggle-base"),t.stopPropagation()},this.onClickPencil=function(t){$(t.currentTarget).parent().toggleClass("active"),this.trigger("mapp:bar:toggle-drawing"),t.stopPropagation()},this.onClickGPS=function(t){this.trigger("mapp:bar:click-gps"),t.stopPropagation()},this.onRegionsLoaded=function(t,e){var i=_.map(e,function(t,e){return{key:e,name:t}});if(i.length>0){var n=Handlebars.compile("{{#list}}<li><a href='#' class='boundary' data-set='{{key}}' 'data-skip-pjax'=1>{{name}}</a></li>{{/list}}");$(".boundaries ul",this.$node).html(n({list:i})),$(".boundaries",this.$node).parent().show(),this.on($(".boundaries li > a"),"click",this.onClickBoundary)}else $(".boundaries",this.$node).parent().hide()},this.onClickBoundary=function(t){if(t.currentTarget&&"a"==t.currentTarget.localName&&$(t.currentTarget).hasClass("boundary")){var e=$(t.currentTarget).data("set");debug("choosing boundaryset "+e),this.trigger("mapp:regions:set-boundaries",{bounds:e})}},this.onLeaving=function(){debug("destroy: mapbar"),this.teardown()},this.after("initialize",function(){t=this,this.on("a.map-control[href='#base']","click",this.onClickBase),this.on("a.map-control[href='#drawing']","click",this.onClickPencil),this.on("a.map-control[href='#gps']","click",this.onClickGPS),this.on(document,"mapp:regions:loaded",this.onRegionsLoaded),this.on(document,"mapp:destroy",this.onLeaving),this.moveToNavbar()})},function(){LL.Memory={set:function(t,e){debug("memory saving: %o",t),$.post("/preferences.json",{data:t},function(t){"ok"==t.status&&"function"==typeof e&&e.apply(window,[t])})},get:function(t,e){debug("memory get: %s",t),$.get("/preferences.json?key="+t,function(){"function"==typeof e&&e.apply(window,[result])})},clear:function(){$.ajax({url:"/preferences.json",method:"delete",data:{},success:function(){}})}}}(),LL.ParcelColors=function(){{var t="#75B08A",e="#F0E797",i="#FF9D84",n="#FF5460";chroma.scale([n,i,e,t]).mode("lab")}this.after("initialize",function(){debug("parcel colors initializing"),LL.Templates.preload("parcel_legend")})},LL.Parcels=function(){var originalFillOpacity=null,currentTileKey=null,highlightLayer=null,currentBase="street",ogStyle={},opacity={street:.6,satellite:.3,nearmap:.3},highlightStyle={color:"#707",fillColor:"none",weight:4,fillOpacity:0};this.attributes({paraffin:null,leaflet:null,tileLayerID:"sitecontrol",loadMap:!0});var zoomToBlext=function(t){if(highlightLayer){var e=_.filter(highlightLayer._layers,function(e){return e.feature.id==t});this.attr.leaflet.fitBounds(e[0].getBounds())}};this.onBinClear=function(){highlightLayer&&highlightLayer.clearLayers()},this.onBinAdd=function(t,e){this.attr.loadMap&&(this.ensureHighlightLayer(),highlightLayer.addData(e),this.trigger("pane:request:hide"))},this.onBinRemove=function(){if(this.attr.loadMap&&highlightLayer){var t=_.filter(highlightLayer._layers,function(t){return t.feature.id==id});_.each(t,function(t){highlightLayer.removeLayer(t)})}},this.onBinUpdate=function(){},this.onPropertyLoaded=function(t,e){if(e.geometry){var i=this.attr.leaflet,n=this.attr.paraffin.overlays;n.focus||(n.focus=new L.GeoJSON(this.attr.paraffin.emptyGeoJSON,{style:highlightStyle}),i.addLayer(n.focus)),n.focus.clearLayers(),n.focus.addData(e.geometry);var o=n.focus.getBounds();i.getZoom()<14?i.setView(L.latLng(e.centroid[1],e.centroid[0]),16):i.getBounds().contains(o)||i.panInsideBounds(o,{duration:.5})}},this.ensureHighlightLayer=function(){if(!highlightLayer){var t={elements:this.attr.paraffin.emptyGeoJSON,style:highlightStyle,interaction:!0,id:"highlights"};highlightLayer=this.attr.paraffin.createGeoJSON(t),this.attr.paraffin.overlays.highlights=highlightLayer,this.attr.leaflet.addLayer(this.attr.paraffin.overlays.highlights)}},this.highlightParcel=function(t){if(!this.attr.paraffin.overlays.search){var e={style:function(){return{color:"#909",fillColor:"none",weight:4,fillOpacity:0}}};this.attr.paraffin.overlays.search=new L.GeoJSON(this.attr.paraffin.emptyGeoJSON,e),this.attr.leaflet.addLayer(this.attr.paraffin.overlays.search)}this.attr.paraffin.overlays.search.clearLayers(),this.attr.paraffin.overlays.search.addData(t)},this.onSwitchedDataset=function(){},this.onClickParcelGJ=function(t,e){debug("click geojson"),"geojson"==e.layerType&&e.layer.parent&&"highlights"==e.layer.parent.paraffinId&&this.trigger("property:request",$.extend({},e.data,{pathTemplate:this.attr.pathTemplate}))},this.onSetParcelStyle=function(e,o){if(o.styleHandler){this.ensureHighlightLayer();var sh=eval("("+o.styleHandler+")");ogStyle="object"==typeof highlightLayer.options.style?highlightLayer.options.style:{},$.extend(ogStyle,{fillOpacity:opacity[currentBase]});var wrapped=function(t){var e=sh(t);return $.extend({},ogStyle||{},e)};highlightLayer.options.style=wrapped,highlightLayer.setStyle(wrapped)}o.legend&&this.trigger("mapp:legend:add",{id:highlightLayer.paraffinId,key:o.legend})},this.onBaseChanged=function(t,e){currentBase=e.base;var i=opacity[currentBase];debug(s.sprintf("switching to %f for %s",i,currentBase)),this.ensureHighlightLayer(),ogStyle.fillOpacity=i,highlightLayer.setStyle(highlightLayer.options.style)},this.onTooMany=function(){},this.onDestroy=function(){debug("destroy: parcels.js"),this.teardown()},this.after("initialize",function(){return this.attr.leaflet&&this.attr.paraffin?(this.on(document,"property:loaded",this.onPropertyLoaded),this.on(document,"paraffin:click",this.onClickParcelGJ),this.on(document,"mapp:dataset:switched",this.onSwitchedDataset),this.on(document,"mapp:base:changed",this.onBaseChanged),this.on(document,"mapp:parcels:style",this.onSetParcelStyle),this.on(document,"mapp:destroy",this.onDestroy),this.on(document,"bin:add",this.onBinAdd),this.on(document,"bin:remove",this.onBinRemove),this.on(document,"bin:change",this.onBinUpdate),this.on(document,"bin:clear",this.onBinClear),this.on(document,"bin:too-many",this.onTooMany),void this.trigger("mapp:parcels:initialized")):void debug("Hey! you have to initialize the parcels with leaflet and paraffin at least")})},LL.RegionColors=function(){var resourceId="color-bundle-v1",nearOpacity=.3,farOpacity=.7,opacity=farOpacity,currentSH=null;this.attributes({mapSlug:!1,mapPath:!1}),this.scoreFeature=function(t,e){var i=switchPath(e.path,"us"),n=t[i]||t[e.path];return n=n?n:0,Math.max(Math.min(n,1),0)},this.onSwitchedForColors=function(t,e){this.setOpacity(e.tile_key?nearOpacity:farOpacity);var i=this.attr.mapPath?{path:this.attr.mapPath,extras:"&path="+switchPath(e.path,"us"),style:e.style}:{path:e.path,style:e.style,extras:""};amplify.request(resourceId,i,function(t){"error"==t.status?debug(t):this.trigger("mapp:regions:received-colors",t)}.bind(this))},this.onReceivedColors=function(t,e){this.colorMap(e)},this.setOpacity=function(t){opacity=t,this.attr.chunkLayer.options.style.fillOpacity=opacity},this.colorMap=function(data){var o=this.attr.chunkLayer,color,useSH=!0;if(useSH&&data.styleHandler){var sh=eval("("+data.styleHandler+")"),wrapped=function(t){var e=switchPath(t.properties.path,"us"),i=data.data[e]||data.data[t.properties.path];return i=i?i:0,t.properties[data.property]=Math.max(Math.min(i,1),0),overrides=sh(t),$.extend({},o.options.style||{},overrides)};o.setStyle(wrapped)}data&&data.key&&this.trigger("mapp:legend:add",data)},this.onZoomEnd=function(){var t=this.attr.leaflet;els=$("path.place:not(.outline)"),t.getZoom()>13?els.hide():els.show()},this.after("initialize",function(){debug("hoodcolors initializing"),this.on(document,"mapp:regions:switched",this.onSwitchedForColors),this.on(document,"mapp:regions:received-colors",this.onReceivedColors),this.on(document,"mapp:zoomend",this.onZoomEnd),this.on(this.attr.leaflet,"zoomend",this.onZoomEnd),amplify.request.define(resourceId,"ajax",{url:"{path}/colors.json?style={style}{extras}",dataType:"json",type:"GET",cache:!0})})},LL.RegionColors.schemes={},LL.HoodLegend=function(){this.attributes({labels:{structure:["Structure","Lot"],condition:["Good","Suggest Demo"],occupancy:["Occupied","Unoccupied"],fire:["No Fire Damage","Fire Damage"],boarding:["OK","Needs Boarding"],"lot-dumping":["No Dumping","Dumping"]}});this.after("initialize",function(){})},LL.Regions=function(){var t=null,e=null,i=null,n=null,o=!1,r=L.latLngBounds(L.latLng(23.5,-127.3),L.latLng(48.5,-64.6)),a=L.latLngBounds(L.latLng(-90,-200),L.latLng(90,200)),l=null,h=null,c=null;this.attributes({paraffin:null,leaflet:null,outlinePath:null,outlineLayer:null,chunkLayer:null,defaultStyle:null,dataset:null,regionVersion:null,regionLimit:null,mapSlug:!1,mapPath:!1}),this.setOutline=function(t){if(this.attr.outlineLayer.clearLayers(),t&&t.geometry){this.attr.outlineLayer.addData(t);for(var e in this.attr.outlineLayer._layers){var i=this.attr.outlineLayer._layers[e];$(i._path).attr("class",$(i._path).attr("class")+" outline")}}},this.setChunks=function(t,e){this.attr.chunkLayer.clearLayers(),"undefined"!=typeof e&&e&&(this.attr.chunkLayer.template=e),"undefined"!=typeof t&&t&&this.attr.chunkLayer.addData(t)},this.zoomToChild=function(t){this.trigger("mapp:regions:switching");var e=null,i=null;if(t.toGeoJSON)i=t.toGeoJSON(),e=i.properties.path;else{i={type:"FeatureCollection",features:[]};for(var n in t){var o=t[n].toGeoJSON();i.features.push(o),e=o.properties.path}}this.setOutline(i),this.fitOutlineBounds(),this.trigger("mapp:regions:set-path",{path:e})},this.onPathRequested=function(e,i){i.path!=t&&(t=i.path,this.setChunks(null),this.beginLoadingRegion(i.path,!0,i.zoom))},this.fitOutlineBounds=function(){var e=this.attr.outlineLayer,i=null;if("/us"==t)i=r;else{if("/w"==t)return;if(e.toGeoJSON)i=e.getBounds();else for(var n in e)i=i?i.extend(e[n].getBounds()):e[n].getBounds()}i._northEast&&this.attr.leaflet.fitBounds(i)},this.zoomToParent=function(){return c?("none"==h&&(h="neighborhoods"),void this.beginLoadingRegion(c.parent,!0)):void debug("No current bundle so no parent :O")},this.zoomToRegion=function(n,o,s){debug("zoom zoom"),c=n,t=n.path,t=switchPath(t,e),l=n.styles,this.trigger("mapp:regions:loaded",n.styles),this.setOutline(n.outline),"undefined"!=typeof s&&$.isNumeric(s)?this.attr.leaflet.setZoom(s):"undefined"!=typeof s&&s===!1||(n.extent?this.attr.paraffin.setExtent(n.extent):this.fitOutlineBounds()),$.isEmptyObject(n.children)?(this.setChunks(),this.trigger("mapp:regions:switched",n)):this.setStyle(h||this.attr.defaultStyle),o&&history.pushState&&this.trigger("mapp:regions:history",{path:n.path}),$.bbq.setState({b:h}),"undefined"!=typeof s&&s===!1&&this.trigger("mapp:zoomend"),i!=n.ds&&LL.Strings.fetch(n.ds,function(t){i=n.ds,this.trigger("mapp:dataset:switched",t)}.bind(this))},this.setStyle=function(t){var e=_.keys(l);if(l[t])h=t;else if(e.length>0){var i=["neighborhoods","admin"];h=_.find(i,function(t){return l[t]})||e[0]}var n=c.children[h];n?(this.setChunks(n.geojson,n.template),c.style=h,this.trigger("mapp:regions:switched",c)):debug("Weird, we really thought there would be things for "+useStyle+" here, but no"),$.bbq.setState({b:h})},this.onSetBoundaries=function(t,e){this.setStyle(e.bounds)},this.onClickRegion=function(t){if(o)return!1;t.layer.feature&&this.zoomToChild(t.layer);for(var e in map.utfLayers)map.utfLayers[e].muted=!1},this.onRequestParent=function(){return o?!1:void this.zoomToParent()},this.onPropertyLoad=function(e,i){debug("helo hello");var n=i.path.match(/^(.+)\/(\d+)$/);if(n&&t){var o=switchPath(n[1],"us"),s=switchPath(t,"us"),r=/neighborhoods|tracts/;0==s.indexOf(o)||s.match(r)||this.trigger("mapp:regions:set-path",{path:o,zoom:15})}},this.beginLoadingRegion=function(t,i,r){var a=this,l=this.attr.mapSlug?s.sprintf("map_id=%s",this.attr.mapSlug):"";this.trigger("mapp:regions:switching");var h=LL.Spinner.start();o=!0,amplify.request({resourceId:n,data:{path:switchPath(t,e),query:l},success:function(t){return"error"==t.status?void debug(t):(a.zoomToRegion(t,i,r),o=!1,void LL.Spinner.stop(h))},error:function(){o=!1,LL.Spinner.stop(h)}})},this.onSwitchedRegions=function(t,e){e.parent&&this.attr.regionLimit!=e.outline.properties.path?$("#mapbox .back").removeClass("hide"):$("#mapbox .back").addClass("hide")},this.onRequestRegion=function(t,e){e.path&&this.beginLoadingRegion(e.path,!0,e.zoom)},this.onRegionsHashChange=function(){h=$.bbq.getState("b")},this.onHistoryBack=function(){},this.onChooseLayer=function(i,n){debug("Region handler sees you want a layer "+n.dataset),e=n.ds;var o=this.attr.leaflet.getZoom();this.beginLoadingRegion(t,!0,o)},this.onDestroy=function(){debug("destroy: regions"),this.teardown()},this.loadInitialRegion=function(){var t=$.bbq.getState("s")||this.attr.outlinePath,e=$.bbq.getState("p");this.beginLoadingRegion(t,!1,!e)},this.after("initialize",function(){debug("region manager init"),e=window.data.ds,this.on(document,"mapp:regions:parent",this.onRequestParent),this.on(document,"mapp:regions:set-path",this.onPathRequested),this.on(document,"mapp:regions:set-boundaries",this.onSetBoundaries),this.on(document,"mapp:regions:switched",this.onSwitchedRegions),this.on(document,"mapp:regions:request",this.onRequestRegion),this.on(document,"mapp:dataset:set",this.onChooseLayer),this.on(document,"mapp:destroy",this.onDestroy),this.on(document,"property:loaded",this.onPropertyLoad),this.on(window,"hashchange",this.onRegionsHashChange),this.on(window,"popstate",this.onHistoryBack),this.on("#mapbox .back","click",this.onRequestParent),n="boundary-bundle-v"+this.attr.regionVersion,amplify.request.define(n,"ajax",{url:"{path}/boundaries.json?{query}",dataType:"json",type:"GET",cache:!0}),e=window.data.ds_lookup[this.attr.dataset],this.attr.leaflet.setMaxBounds(a),this.loadInitialRegion(),this.attr.chunkLayer.on("click",this.onClickRegion.bind(this))})},LL.Tiles=function(){this.attributes({paraffin:null,leaflet:null,tileLayerID:"tiles",dataset:null});var t=null,e=null;this.onSwitchedDataset=function(t,e){this.trigger("navbar:set",{key:"map.auction",value:e.auction}),LL.Templates.fetch("layer_info",function(t){e.attribution=this.currentAttribution;var i=["monkey","sheep","taxes15"],n=i.indexOf(e.dataset)>-1,o=t(e),s=$("#overview .auction-info");n?(s.html(o),s.fitVids(),$("h2",s).remove()):s.empty(),$("#layer-info").html(o),$("#layer-info").fitVids(),"sitecontrol"==e.dataset||n?($("#overview .layer-name span").text(""),$("#overview .layer-name").addClass("hide")):($("#overview .layer-name span").text(e.name),$("#overview .layer-name").removeClass("hide"))}.bind(this))},this.onClickLayerMore=function(t){$("#waterfall").trigger("pane:request:show",{tab:"#layers"}),t.preventDefault()},this.onClickDataset=function(t){var e=$(t.currentTarget),i=e.data("key"),n=e.text(),o=window.data.ds_lookup[i];debug("triggering switch to "+i+" / "+n),this.trigger("mapp:dataset:set",{dataset:i,ds:o,label:n}),t.preventDefault()},this.onRegionSwitchedForLayers=function(t,e){var i={datasets:_.collect(e.datasets,function(t,e){return{dataset:e,label:t}})};LL.Templates.fetch(["layer_list","layer_info"],function(t){$("#layer-list").html(t.layer_list(i)),$("#layer-list a.dataset").click(this.onClickDataset.bind(this)),this.currentAttribution=e.attribution,e.attribution?$("#layer-info .attribution").html(e.attribution).removeClass("hide"):$("#layer-info .attribution").html("").addClass("hide")}.bind(this))},this.onRegionSwitched=function(i,n){var o=this.attr.paraffin.overlays[this.attr.tileLayerID];if(n.path_template&&(e=n.path_template.replace(/{{id}}/g,"{{fid}}")),n.tile_key==t);else if(n.tile_key&&n.tile_layer){debug("swapping out parcel tiles for:"),debug(n.tile_layer),this.removeTileLayer(o);var s=this.attr.paraffin.createTileJSON(n.tile_layer);this.attr.paraffin.overlays[this.attr.tileLayerID]=s,this.attr.leaflet.addLayer(s),t=n.tile_key,this.trigger("mapp:legend:add",n.tile_layer)}else this.removeTileLayer(o),this.trigger("mapp:legend:remove",{id:this.attr.tileLayerID})},this.removeTileLayer=function(e){"undefined"!=typeof e&&e&&(e._layers&&_.each(e._layers,function(t){this.attr.leaflet.removeLayer(t)}.bind(this)),this.attr.leaflet.removeLayer(e),delete this.attr.paraffin.overlays[this.attr.tileLayerID],t=null)},this.onClickParcelTJ=function(t,i){"tilejson"==i.layerType&&i.layer.paraffinId==this.attr.tileLayerID&&this.trigger("property:request",$.extend(i.data,{pathTemplate:e}))},this.after("initialize",function(){debug("LL.Tiles initializing"),this.on(document,"paraffin:click",this.onClickParcelTJ),this.on(document,"mapp:regions:switched",this.onRegionSwitched),this.on(document,"mapp:regions:switched",this.onRegionSwitchedForLayers),this.on(document,"mapp:dataset:set",this.onSwitchedDataset),this.on("#overview .layer-name a","click",this.onClickLayerMore),LL.Templates.preload(["layer_list","layer_info","legend"])})},LL.Metadata=function(){var t=null,e="#pjax-metadata",i=["title","path","group.slug","group.name","map.slug","map.name","map.surveyable"],n=Handlebars.compile("<meta {{attr}}='{{key}}' content='{{value}}' dynamic='1'/>");this.attributes({}),this.readTagsFromContent=function(){$("head meta[dynamic]").remove();var i=$(e+" meta");i.each(function(e,i){var n=$(i).attr("content"),o=$(i).attr("property"),s=$(i).attr("name"),r=o?"property":"name",a=o?o:s;t.applyTag(r,a,n)}),$(e+" meta[property=notice]").remove()},this.applyTag=function(e,o,s){if("notice"==o)this.trigger("notify:message",{message:s});else if(_.contains(i,o))t.trigger("navbar:set",{key:o,value:s});else{var r=$("head meta["+e+"='"+o+"']");if(0==r.length){var a=n({attr:e,key:o,value:s});$("head").append(a)}else r.attr("content",s)}},this.onSetMeta=function(e,i){_.each(["name","property"],function(e){_.each(i[e],function(i,n){t.applyTag(e,n,i)})})},this.onNewPage=function(){this.readTagsFromContent()},this.after("initialize",function(){t=this,this.on(document,"page:loaded",this.onNewPage),this.on(document,"page:metadata:set",this.onSetMeta),_.each(i,function(e){var i=$("meta[property='"+e+"']");i.exists()&&t.trigger("navbar:set",{key:e,value:i.attr("content")})})})},$(document).ready(function(){flight.component(LL.NavBar).attachTo("#header")}),LL.NavBar=function(){this.onClickHamburger=function(t){var e=!$("#header").hasClass("show");this.showMobileHeader(e),t.stopPropagation()},this.showMobileHeader=function(t){t?($("#header").addClass("show"),$("#boterham").addClass("opened"),$("#header .nav.level-1").each(function(t,e){var i=$(e).data("path"),n=$(".level-0 li a[data-path='"+i+"']"),o=n.closest("li");$(e).appendTo(o)}),$("#header .subnav").each(function(t,e){var i="#"+$(e).attr("id"),n=$(".level-1 li a[data-subnav='"+i+"']"),o=n.closest("li");$(e).appendTo(o)}),$("#header .city_list a").removeClass("lead")):($("#header").removeClass("show"),$("#boterham").removeClass("opened"),$("#header .level-1, #header .subnav").appendTo("#header > nav"))},this.onClickLevel0=function(t){var e=$(t.currentTarget),i=(e.hasClass("active"),e.attr("data-level-1")),n=e.attr("data-skip-pjax");t.metaKey||t.altKey||t.shiftKey||t.ctrlKey||n||(i?this.trigger("navbar:show:1",{target:i}):this.trigger("navbar:hide:1"))},this.onShowLevel1=function(t,e){var i=e.target,n=$(i);$("ul.level-1").removeClass("show"),n.addClass("show"),$(".subnav").removeClass("show"),$("body").addClass("with-level-1").removeClass("with-level-2")},this.onHideLevel1=function(){this.trigger("navbar:hide:2"),$("ul.level-1").removeClass("show"),$("body").removeClass("with-level-1")},this.onClickLevel1=function(t){var e=$(t.currentTarget).data("subnav");if(e){var i=$(e),n=i.hasClass("show");this.trigger("navbar:hide:2",{target:e}),n||this.trigger("navbar:show:2",{target:e});var o=normalizeURL(window.location.href),s=normalizeURL($(t.currentTarget).attr("href"));return o==s?(t.stopPropagation(),!1):void 0}},this.onShowLevel2=function(t,e){this.trigger("navbar:hide:2"),$("body").addClass("with-level-1").addClass("with-level-2"),$(e.target).addClass("show")},this.onHideLevel2=function(){$(".subnav").removeClass("show"),$("body").removeClass("with-level-2")},this.onClickLevel2=function(t){var e=$(t.currentTarget).attr("href");this.trigger("navbar:click:2",{href:e,target:t.currentTarget}),this.showMobileHeader(!1);var i=window.location.pathname,n=e,o=e?e.match(/^([^#]*)#?(.*)$/):null;
o&&(n=o[1]),("#"==e[0]||i==n)&&t.preventDefault()},this.onRequesting=function(){this.showMobileHeader(!1)},this.setupPJAX=function(){$(document).pjax("a:not([data-remote]):not([data-skip-pjax]):not([target])","#pjax-container",{timeout:2e4}).on("pjax:start",function(t){if(t.relatedTarget){var e=document.createElement("a");e.href=t.relatedTarget.baseURI,$(".modal.in").modal("hide"),$(".modal-backdrop").remove(),this.trigger("page:requesting",{href:e.pathname,target:t.relatedTarget})}}.bind(this)).on("pjax:success",function(){$("#pjax-container").scrollTop(0)}.bind(this)).on("pjax:send",function(t,e,i){i.spinId=LL.Spinner.start()}.bind(this)).on("pjax:end",function(t,e,i){this.trigger("page:loaded"),LL.Spinner.stop(i.spinId)}.bind(this))},this.onSet=function(t,e){if("title"==e.key)$("head title").text(e.value);else if("path"==e.key)this.applyPath(e.value);else{var i=$("#header *[data-listen='"+e.key+"']");i.each(function(t,i){var n=$(i),o=n.data("attr"),s=n.data("template"),r=n.data("default"),a=e.value||r;a&&"false"!=a?(s&&(s=Handlebars.compile(s),a=s(e)),"text"==o?n.text(a).removeClass("hide").show():n.attr(o,a).removeClass("hide").show(),n.removeClass("hide").show().closest("li").removeClass("hide").show()):n.hide().closest("li").hide()})}},this.applyPath=function(t){var e=null,i=null;if(!t)return $(".level-0 li, .level-1 li, .subnav li",this.$node).removeClass("active"),$(".level-1, .subnav").removeClass("show"),void $("body").removeClass("with-level-1").removeClass("with-level-2");if($("#header .level-0 > li").removeClass("active"),$("#header .level-0 > li > a").each(function(i,n){var o=$(n).attr("data-path");0==t.indexOf(o)&&($(n).parent().addClass("active"),e=$(n).data("level-1"))}),$("#header .level-1").removeClass("show"),$("#header .level-1 > li").removeClass("active"),e){var n=$("#header "+e+".level-1");n.addClass("show"),$("#header "+e+".level-1 > li > a").each(function(e,n){var o=$(n).attr("data-path");0==t.indexOf(o)&&($(n).parent().addClass("active"),i=$(n).data("subnav"))}),$("body").addClass("with-level-1")}else $("body").removeClass("with-level-1");if($("#header .subnav").removeClass("show"),$("#header .subnav li a:not(.map-control)").parent().removeClass("active"),i){var n=$("#header "+i+".subnav");n.addClass("show"),$("li > a",n).each(function(e,i){var n=$(i).attr("data-path");0==t.indexOf(n)&&$(i).parent().addClass("active")}),$("body").addClass("with-level-2")}else $("body").removeClass("with-level-2")};var t=null;this.onTouchStart=function(e){var i=e.originalEvent.touches[0];t=i.pageX},this.onTouchMove=function(e){var i=e.originalEvent.touches[0],n=i.pageX-t;-15>n&&(this.showMobileHeader(!1),e.preventDefault())},this.onClickForCities=function(t){var e=$(t.target).closest("a.toggle-all-cities");if(e.exists()){var i=e.closest(".city_list"),n=$(".other",i),o=$(".fa",e),s=$("span.txt",e);n.is(":visible")?(n.slideUp(),o.attr("class","fa fa-caret-right"),s.text("More Places")):(n.removeClass("hide").hide().slideDown(),o.attr("class","fa fa-caret-down"),s.text("Fewer Places")),t.preventDefault()}},this.after("initialize",function(){this.on($("a#boterham"),"click",this.onClickHamburger),this.on("ul.level-0 a","click",this.onClickLevel0),this.on($("ul.level-1 a[data-subnav]"),"click",this.onClickLevel1),this.on($(".subnav > ul > li > a"),"click",this.onClickLevel2),this.on(document,"navbar:show:1",this.onShowLevel1),this.on(document,"navbar:hide:1",this.onHideLevel1),this.on(document,"navbar:show:2",this.onShowLevel2),this.on(document,"navbar:hide:2",this.onHideLevel2),this.on("#header","page:requesting",this.onRequesting),this.on(document,"navbar:set",this.onSet),this.on("#header","touchstart",this.onTouchStart),this.on("#header","touchmove",this.onTouchMove),this.on(document,"click",this.onClickForCities),this.setupPJAX();var t="#header";flight.component(LL.Radio).attachTo(t),flight.component(LL.Metadata).attachTo(t),flight.component(LL.Notify).attachTo(t),"undefined"!=typeof ga&&flight.component(LL.Analytics).attachTo(t),this.trigger("page:requesting",{href:window.location.pathname})})},LL.Notify=function(){this.attributes({timeout:10});var t=null,e=0,i=1,n=[],o={};this.addBox=function(){e=1,LL.Templates.fetch("notify",function(i){this.$node.append(i({})),t=$("#notify"),$(".close",t).click(this.onClickClose.bind(this)),e=2,this.trigger("notify:ready")}.bind(this))},this.onReady=function(){for(;n.length>0;){var t=n.shift();this.renderMessage(t)}},this.onRadioMessage=function(t,e){"info"==e.message_type&&this.trigger("notify:message",e)},this.onMessage=function(t,o){o.id=o.id||i++,0==e?(n.push(o),this.addBox()):1==e?n.push(o):this.renderMessage(o)},this.renderMessage=function(e){o[e.id]&&(clearTimeout(o[e.id]),this.removeMessage(e.id,!1));var i=this.itemTemplate(e);$(".messages",t).append(i),t.addClass("show");var n=this.removeMessage.bind(this,e.id);o[e.id]=setTimeout(n,1e3*this.attr.timeout)},this.removeMessage=function(e,i){var n=$(".item[data-id='"+e+"']",t);delete o[e],"undefined"==typeof i&&(i=!0);var s=function(){n.remove(),0==$(".item",t).length&&t.removeClass("show")};i?n.fadeOut(500,s):s()},this.onClickClose=function(){t.removeClass("show")},this.after("initialize",function(){this.on(document,"notify:message",this.onMessage),this.on(document,"notify:ready",this.onReady),this.on(document,"radio:received",this.onRadioMessage),this.itemTemplate=Handlebars.compile("<div class='item' data-id='{{id}}'>{{message}}</div>")})},LL.Pane=function(){var t=[];this.onLevel2Click=function(e,i){var n="#"+$.param.fragment(i.href);_.contains(t,n)&&(this.trigger("pane:request:show",{tab:n,target:i.target}),e.preventDefault(),e.stopPropagation())},this.onRequestShow=function(t,e){if(e&&e.tab){var i=e.tab;$("body").addClass("with-waterfall"),$("#waterfall > .tab-content > .tab-pane.active:not("+i+")").trigger("pane:hide"),$("#waterfall > .tab-content > .tab-pane:not("+i+")").removeClass("active in");var n=$(i,this.$node);n.addClass("active in").trigger("pane:show");var o=null;if(e.target)o=$(e.target).data("path");else{var s=new RegExp(i+"$"),r=_.find($(".subnav.show a"),function(t){return $(t).attr("href").match(s)});r&&(o=$(r).data("path"))}o&&this.trigger("navbar:set",{key:"path",value:o})}$("#waterfall").addClass("show")},this.onShowed=function(t){var e=$(t.target).attr("id");$.bbq.setState({t:e})},this.onRequestHide=function(){this.$node.removeClass("show"),$.bbq.removeState("t")},this.detectTabs=function(){t=_.collect($("#waterfall > .tab-content > .tab-pane"),function(t){return"#"+$(t).attr("id")})};var e=null,i=null;this.onTouchStart=function(t){var n=t.originalEvent.touches[0];e=n.pageX,i=n.pageY,this.$node.hasClass("show")||(this.trigger("pane:request:show"),t.preventDefault())},this.onTouchMove=function(t){var n=t.originalEvent.touches[0],o=n.pageX-e,s=n.pageY-i;o>20&&Math.abs(s)<10&&(this.trigger("pane:request:hide"),t.preventDefault())},this.onClickClose=function(){this.trigger("pane:request:hide")},this.after("initialize",function(){this.$node.data("loading-html","<div class='centered'><i class='fa fa-spinner fa-spin big'></div>"),this.detectTabs(),this.on("#header","navbar:click:2",this.onLevel2Click),this.on(document,"pane:request:show",this.onRequestShow),this.on(document,"pane:request:hide",this.onRequestHide),this.on("touchstart",this.onTouchStart),this.on("touchmove",this.onTouchMove),this.on("pane:show",this.onShowed),this.on(".close","click",this.onClickClose),$("body").addClass("with-waterfall"),this.trigger("pane:initialized")})},LL.ByRegion=function(){var t=null,e=null,i=null,n=null;this.attributes({}),this.onBRPaneShow=function(){e!=t&&(t=e,i=n,this.trigger("pane:request:refresh",n))},this.onBRSwitchedRegions=function(o,s){e=s.path,n=s,this.$node.is(":visible")&&(t=e,i=n,this.trigger("pane:request:refresh",s))},this.after("initialize",function(){this.on("pane:show",this.onBRPaneShow),this.on(document,"mapp:regions:switched",this.onBRSwitchedRegions)})},function(){function t(){this.attributes({});var t=null,e=null,i="subjects",n={},o=["subjects","tabulations","data"];this.onCensusRegion=function(e,i){$(".subnav a[href='#census']").parent();i.census||($(".place-name",this.$node).text(i.headline),t.html("We have no census data to show here."))},this.onRequestRefresh=function(o,s){debug("census explorer wants to refresh its situation"),e=s.path,t.spinline();var r=$.extend({},{category:i},n[i]||{});this.fetch(r)},this.onClickSub=function(t){var e=$(t.currentTarget),i=e.closest("ul").data("cat");if("topics"==i){var n=e.data("topic");this.fetch({category:"tabulations",topic:n},e)}else if("subjects"==i){var o=e.data("subject");this.fetch({category:"tabulations",subject:o},e)}else if("tabulations"==i){var s=e.data("tabulation"),r="B"+s;this.fetch({category:"data",table:r},e)}return t.preventDefault(),!1},this.fetch=function(o,r){var a=i;i=o.category,n[o.category]=o;var l=LL.Spinner.start(),h=this;$.get(s.sprintf("%s/census.json",e),o,function(e){"ok"==e.status?LL.Templates.fetch("census",function(n){e.crumbs=h.crumbsForCategory(i);var o=n(e);t.html(o),$("ul[data-cat]",h.$node).children().exists()||$("ul[data-cat]",h.$node).replaceWith("Sorry, we have nothing to display for this.")}):(i=a,"undefined"!=typeof r&&(r.css("opacity","0.5").tooltip({title:"Sorry, we can't show this table here",trigger:"manual"}).tooltip("show"),setTimeout(function(){r.tooltip("hide")},5e3)),t.html(e.message))}).always(function(){LL.Spinner.stop(l)})},this.crumbsForCategory=function(t){var e=o.indexOf(t);return-1==e?[]:o.slice(0,e+1)},this.onClickCategory=function(t){var e=$(t.currentTarget).data("cat"),i=n[e];i&&this.fetch(i)},this.onDestroy=function(){debug("destroy: census explorer"),this.teardown()},this.after("initialize",function(){t=$(".census-container",this.$node),this.on(document,"mapp:regions:switched",this.onCensusRegion),this.on("pane:request:refresh",this.onRequestRefresh),this.on(document,"mapp:destroy",this.onDestroy),this.$node.on("click","ul[data-cat] > li > a",this.onClickSub.bind(this)),this.$node.on("click","ul.categories a",this.onClickCategory.bind(this)),LL.Templates.preload("census")})}LL.Census=flight.component(t,LL.ByRegion)}(),LL.Charts=function(){this.initChart=function(t,e){var i=$.extend(e,{});t.attr("data-key",e.key),flight.component(LL.Pie).attachTo(t,i)},this.updateCharts=function(t){$(".pie",this.$node).each(function(){updateChart(id,t.stats[id])})},this.after("initialize",function(){})},LL.Feed=function(){this.attributes({mapPath:!0,itemsSelector:".feed-items",channels:[]});var t=!0,e=/^(\d+(?: [A-z])?) ([A-z ]+)$/,i=!1,n=null,o={},r=null,a=!1,l=!1;this.humanizeQA=function(t,e){return"undefined"==typeof e?t:e},this.onRequestRefresh=function(t,e){n=e.path,i?(this.clearFeed(),this.fetchPage()):LL.Templates.fetch("waterfall_item",function(){this.fetchPage(),i=!0}.bind(this))},this.fetchPage=function(){if(!a){a=!0;var t=this.attr.mapPath+"/blexts.json",e={style:"feed",query:$.extend({},o,{path:n,before:r})},s=!i;s&&this.$items.spinline(),$("a#fetch",this.$node).text("Loading...").hide().attr("disabled","true"),$.post(t,e,function(t){s&&(this.$items.empty(),0==t.results.length&&this.showHint()),"ok"==t.status&&(r=t.earliest_id,this.addBlextsToFeed(t.results),t.last_page&&(debug("hit last page of results"),$("a#fetch",this.$node).remove()))}.bind(this)).always(function(){$("a#fetch",this.$node).text("More").show().removeAttr("disabled"),a=!1}.bind(this))}},this.showHint=function(){LL.Templates.fetch("new_map_hint",function(t){var e={mapPath:this.attr.mapPath};this.$items.html(t(e))}.bind(this))},this.clearFeed=function(){r=null,this.$items.empty()},this.addWaterfallItem=function(i,n){LL.Templates.fetch("waterfall_item",function(o){i.image&&i.image_date&&window.data.sitecontrol&&(i.image.thumb="/assets/icons/house_thumb.jpg");var s=o(i),r=null,a=$(".feed-item[data-id='"+i.id+"']",this.$node);if(a.exists())a.replaceWith(s);else if("undefined"!=typeof n&&n)this.$items.append(s);else{var l=this.$node.scrollTop();this.$items.prepend(s);var h=$(".waterfall-item:first-child",this.$items).height()+10;t&&l>0&&this.$node.scrollTop(l+h)}var c=i.address.match(e),u=i.address;c&&(u=c[2]+" "+c[1]),r=$(".feed-item[data-id='"+i.id+"']",this.$node),r.attr("data-sort-address",u),i.element=r}.bind(this))},this.addBlextToFeed=function(t,e){return t.answers=_.map(t.fields,function(t,e){var i=this.humanizeQA(e),n=this.humanizeQA(e,t);return{key:i,val:n}}.bind(this)),this.addWaterfallItem(t,e),!0},this.addBlextsToFeed=function(t){if(t){for(var e=0;e<t.length;e++)this.addBlextToFeed(t[e],!0);this.layzr=new Layzr({container:"#feed"})}},this.onMessage=function(t,e){"blext"==e.message_type&&("remove"==e.action?$(s.sprintf(".feed-item[data-id='%s']",e.properties.id),this.$node).remove():(this.addBlextToFeed(e.properties,!1),this.layzr=new Layzr({container:"#feed"})))},this.onClickFetch=function(t){this.fetchPage(),t.preventDefault()},this.onQueryChanged=function(t,e){o=e,this.$node.is(":visible")?(this.clearFeed(),this.fetchPage()):l=!0},this.onScroll=function(){if(!a&&$("a#fetch",this.$node).exists()){var t=this.$node.scrollTop(),e=this.$node.get(0).scrollHeight,i=$("#waterfall").height();t+i>e-300&&!a&&this.fetchPage()}},this.onClickItem=function(t){var e=$(t.currentTarget).attr("href"),i=$(t.currentTarget).closest(".feed-item").data("id");this.trigger("property:request",{path:e,blextId:i}),t.preventDefault()},this.onDestroy=function(){debug("destroy: feed"),this.$node.off("click"),this.teardown(),this.$node.trigger("radio:unsubscribe",{channels:this.attr.channels})},this.after("initialize",function(){this.on(document,"radio:received",this.onMessage),this.on("#fetch","click",this.onClickFetch),this.on("pane:request:refresh",this.onRequestRefresh),this.on(this.$node,"scroll",this.onScroll),this.on(document,"mapp:destroy",this.onDestroy),this.on(document,"query:changed",this.onQueryChanged),this.$node.on("click","a.item-link",this.onClickItem.bind(this)),this.trigger("radio:subscribe",{channels:this.attr.channels}),LL.Templates.preload("waterfall_item"),this.$items=$(this.attr.itemsSelector,this.$node),this.trigger("feed:initialized")})},LL.Inbox=function(){this.onShown=function(){$("#moderation.modal .modal-body").html("Loading..."),$.get(scInfo.map_path+"/queue.json",function(t){var e=Mustache.to_html(modTemplate,t);$("#moderation.modal .modal-body").html(e)})},this.onFlag=function(t){var e=$(this).closest(".queue-item"),i=parseInt(e.data("id")),n=$(this).data("status");$.post(scInfo.map_path+"/moderate.json",{id:i,status:n},function(){e.css({"mouse-events":"none",opacity:"0.3"})}),t.stopPropagation()},this.onClickReply=function(t){var e=$(this).closest(".queue-item, .item");$("textarea.reply-box",e).removeClass("hide").slideDown(),t.stopPropagation()},this.onReplyKeyup=function(t){if(13==t.keyCode){var e=$(this),i=e.val(),n=e.closest(".queue-item, .item"),o=parseInt(n.data("id")),s=n.data("type");if(i.length>4){e.css("opacity","0.3");var r={type:s,body:i};r["comment"==s?"comment_id":"blext_id"]=o,$.post(scInfo.map_path+"/reply.json",r,function(t){e.replaceWith("<p>"+t.message+"</p>")})}t.stopPropagation()}},this.after("initialize",function(){this.on("a.reply","click",this.onClickReply),this.on("textarea.reply-box","keyup",this.onReplyKeyup)})},function(){function t(){this.attributes({titleKey:{structure:"Structure",condition:"Condition",occupancy:"Occupancy"},legendOrders:{structure:["structures","lots"],condition:["good","fair","poor","sugg. demo"],occupancy:["occupied","maybe","unoccupied"]}}),this.showStatSubset=function(t,e){var i={rows:[{label:"properties",all:e.overall_stats.num_parcels,matched:e.stats.total_properties}]},n=_.without(_.keys(t),"path","colorKey");t.colorKey&&n.push(t.colorKey);var o;for(var s in n){var r=n[s];for(var a in e.overall_stats[r]){if(e.stats[r][a]&&e.stats.total_properties>0){var l=e.stats[r][a],h=r==t.colorKey?e.stats.total_properties:e.overall_stats.total_properties;o=Math.round(100*l/h)+"%"}else o=null;var c={label:r+" = "+a,all:e.overall_stats[r][a],matched:e.stats[r][a],percent:o};i.rows.push(c)}}},this.after("initialize",function(){debug("mcm stats initializing")})}LL.MCMStats=flight.component(t,LL.ByRegion,LL.Charts)}(),function(){function t(){this.attributes({mapPath:!1});var t=null,e=null,i=null;this.onRequestRefresh=function(t,n){debug("query engine wants to refresh its situation"),e=n.path,i||this.loadAvailable(e)},this.applyDynamicFilters=function(){var t=this.buildQuery();debug(t),this.trigger("query:changed",t),this.trigger("bin:request:clear"),this.trigger("bin:request:fetch",{mapPath:this.attr.mapPath,query:t,style:"geojson"})},this.onClickPreview=function(t){var e=this.buildQuery();this.getCounts(e),trackIntercomEvent("query",{map_path:this.attr.mapPath}),t.preventDefault()},this.getCounts=function(t){var i={style:"counts",query:t},n=this.attr.mapPath?this.attr.mapPath+"/blexts.json":e+"/list.json";$.post(n,i,function(t){debug(t),"ok"==t.status&&(t.geojson_ok?($(".preview-message",this.$node).text("Found "+numberWithCommas(t.count)+" results."),$("a.search",this.$node).removeAttr("disabled")):0==t.count?($(".preview-message",this.$node).text("There would be no results for this search."),$("a.search",this.$node).attr("disabled","1")):($(".preview-message",this.$node).text(s.sprintf("Found %s results, but we can only display %s on the map.",numberWithCommas(t.count),numberWithCommas(t.max_geojson))),$("a.search",this.$node).attr("disabled","1")))}.bind(this))},this.onClickSearch=function(t){this.applyDynamicFilters(),t.preventDefault()},this.buildQuery=function(){var i={path:e};return $("section",t).each(function(t,e){var n=$(e).data("source-key");$(":checked",e).each(function(t,e){var o=$(e).data("key"),s=$(e).data("value");i[n]||(i[n]={}),i[n][o]||(i[n][o]=[]),i[n][o].push(s)}),$(".options.range.active .filter-range",e).each(function(t,e){var o=$(e).data("key"),s=$(e).slider("values",0),r=$(e).slider("values",1);i[n]||(i[n]={}),i[n][o]={min:s,max:r}})}),i},this.onClickClear=function(t){this.clearInterface(),this.applyDynamicFilters(),t.preventDefault()},this.clearInterface=function(){$("input[type=checkbox]",t).removeAttr("checked"),$("input[type=text]",t).val(""),$("input.filter-value",t).removeClass("active").val(""),$(".options.range",t).removeClass("active"),$(".preview-message",t).empty()},this.loadAvailable=function(e){t.spinline();var n=(this.attr.mapPath||e)+"/filters.json";$.get(n,function(t){i=t,this.renderFilters(t)}.bind(this))},this.renderFilters=function(e){return"undefined"!=typeof e&&e?void LL.Templates.fetch("filterland",function(i){t.html(i(e)),this.postRender()}.bind(this)):void t.html("")},this.postRender=function(){$(".filter-range",this.$node).each(function(t,e){this.setupSlider(e)}.bind(this))},this.setupSlider=function(t){var e=$(t),i=e.closest("section[data-source-key]"),n=e.closest(".field"),o=i.data("source-key"),r=e.data("key"),a=parseFloat(e.data("min")),l=parseFloat(e.data("max")),h=$("input[data-key='"+r+"']",n),c=1;5>l-a&&(c=(l-a)/20),console.log(s.sprintf("got a range %s.%s with range %f - %f, step %f",o,r,a,l,c)),e.slider({range:!0,min:a,max:l,step:c,values:[a,l],slide:function(t,i){h.val(i.values[0]+" - "+i.values[1]),h.addClass("active"),e.closest(".options").addClass("active")}}),$(".clear-range",n).click(function(){$(".options.range",n).removeClass("active")}.bind(this))},this.onDestroy=function(){debug("destroy: query engine"),this.$node.off("click","a.clear"),this.$node.off("click","a.preview"),this.$node.off("click","a.search"),this.teardown()},this.after("initialize",function(){t=$(".query-container",this.$node),this.on("pane:request:refresh",this.onRequestRefresh),this.on(document,"mapp:destroy",this.onDestroy),this.$node.on("click","a.preview",this.onClickPreview.bind(this)),this.$node.on("click","a.search",this.onClickSearch.bind(this)),this.$node.on("click","a.clear",this.onClickClear.bind(this)),LL.Templates.preload("filterland")})}LL.Query=flight.component(t,LL.ByRegion)}(),LL.StatsBase=function(){this.attributes({initialPath:null,maxGeoJSON:5e3});var t=null,e=null;this.startLoading=function(i){var n=$("#waterfall").data("loading-html");t.html(n);var o=this;e&&(debug("stats canceling current xhr"),e.abort(),e=null),e=$.get(i,function(t){o.renderData(t,i)}).fail(function(){t.html("<p>The charts are unavailable or being generated right now. Please check back later!</p>")}).always(function(){e=null})},this.clearData=function(){t.html("")},this.transformData=function(t,e){var i=e.strings,n=e.formats?e.formats.currency:{};if(!t)return t;var o=_.collect(t.numeric,function(t,e){var o=i[e]||e,s=null;return _.contains(n,e)?s="$":$.isPlainObject(o)&&o.one&&(o=1==t?o.one:o.other),{key:e,value:t,label:o,prefix:s}});o=_.reject(o,function(t){return 0==t.value});var r=_.collect(t.charts||{},function(e,n){var o=i[n]||n,r={key:n,title:s.titleize(o),data:e,labels:i};return t.chart_colors&&t.chart_colors[n]&&(r.colors=t.chart_colors[n]),r}),a=this.attr.maxGeoJSON,l=_.collect(t.lists||{},function(t,e){var n="top_owners"==e;return{key:e,title:i[e]||e,items:_.collect(t.slice(0,26),function(t){return{name:t[0],count:t[1],isOwner:n,ownerLink:t[1]<=a}}),hidden:_.collect(t.slice(26,100),function(t){return{name:t[0],count:t[1],isOwner:n,ownerLink:t[1]<=a}})}});return{numeric:o,lists:l,charts:r,legendCharts:t.legend_charts}},this.renderData=function(e,i){var n=this;if(!e)return void this.clearData();var o=i.match(/^\/([a-z0-9-]+)/),s=null;return o?(s="m"==o[1]||"parcelverse"==o[1]?"us":o[1],void LL.Strings.fetch(s,function(i){var o=n.transformData(e,i);LL.Templates.fetch("stats",function(e){t.html(e(o)),n.postRender(o)})})):void debug("Hmm, stats renderData can't get ds for: "+i)},this.postRender=function(t){var e=this;$("a.owner-name",this.$node).click(this.onClickOwner.bind(this)),$("a.owner-name.too-many").tooltip({trigger:"click",title:s.sprintf("Sorry, we can only load %s results on the map. You might try again after choosing a smaller neighborhood or zip code",numberWithCommas(this.attr.maxGeoJSON))});var i,n=t.charts.length;i=1==n?"single":n%3==0?"thirds":"half",$(".pie-container",this.$node).addClass(i),_.each(t.charts,function(t){var i=$(".pie[data-key='"+t.key+"']",e.$node);flight.component(LL.Pie).attachTo(i,t)}),t.legendCharts&&($("#mapbox .key").remove(),$(".legend-item .legend-color",this.$node).each(function(t,e){var i=$(e).css("background-color"),n=chroma(i).luminance();.4>n&&$(e).addClass("inverse")})),$("tbody.hidden-owners",this.$node).hide(),$(".hideshow",this.$node).on("click",function(){$("tbody.hidden-owners",this.$node).slideToggle();var t=$(".hideshow",this.$node).data("hidden");$(".hideshow",this.$node).val(t?"Show Less":"Show More"),$(".hideshow",this.$node).data("hidden",!t)})},this.onClickOwner=function(t){var e=$(t.currentTarget),i=e.data("name"),n=e.data("count");n<=this.attr.maxGeoJSON?("[No owner name listed]"==i&&(i=""),debug("highlight owner: "+i),this.highlightOwner(i)):($("a.owner-name.too-many").not(e).tooltip("hide"),setTimeout(function(){e.tooltip("hide")},6e3)),t.preventDefault()},this.highlightOwner=function(t){this.trigger("bin:request:clear"),this.trigger("bin:request:fetch",{path:this.currentPath,query:{parcel:{owner:t}}}),this.currentOwner=t,$.bbq.setState({o:t})},this.after("initialize",function(){debug("statsbase init"),this.currentOwner=null,this.currentPath=this.attr.initialPath,t=$(".stats-container",this.$node),LL.Templates.preload("stats")})},function(){function t(){function t(t){return function(e,i,n,o){Handsontable.renderers.TextRenderer.apply(this,arguments),t.columns[o].color&&(i.className=t.columns[o].color)}}this.attributes({mapPath:""});var e=null,i=null,n=!1,o=null,s=null,r=null,a=!1;this.onRequestRefresh=function(t,i){this.trigger("table:load",i),e&&setTimeout(function(){e.render()},500)},this.onSwitchedRegions=function(t,e){o=null,s=e;var i=$(".subnav a[href='#list']").parent();e.tile_key&&"otfr"!=e.ds?i.removeClass("hide"):(i.addClass("hide"),this.$node.is(":visible")&&this.trigger("pane:request:show",{tab:"#overview"}))},this.onQueryChanged=function(t,e){debug("table sees new query:"),debug(e),r=e,this.$node.is(":visible")?this.trigger("table:load"):a=!0},this.onPage=function(t,e){o=e.page,this.trigger("table:load",{})},this.onShow=function(){$("#waterfall").addClass("wide"),a&&this.trigger("table:load",s)},this.onHide=function(){$("#waterfall").removeClass("wide")},this.onClear=function(){o=null,r=null,s=null,e&&(e.destroy(),e=null)},this.onLoad=function(t,e){s=e.path?e:s,a=!1,n?(this.loadSC(),trackIntercomEvent("view-list",{map_path:this.attr.mapPath,where:s.path})):this.loadWDWOT(s)},this.loadSC=function(){var t=this.attr.mapPath+"/blexts.json",e=$.extend({page:o,path:s.path},r||{}),i={style:"table",query:e},n=LL.Spinner.start();$.post(t,i,this.onTableData.bind(this)).always(function(){LL.Spinner.stop(n)}.bind(this))},this.loadWDWOT=function(t){t.path&&this.renderTable(t);var e=t.path+"/list.json",i={page:o};e+="?"+$.param(i);var n=LL.Spinner.start();$.get(e,this.onTableData.bind(this)).always(function(){LL.Spinner.stop(n)}.bind(this))},this.onTableData=function(t){this.updateControls(t),e?e.loadData(t.table):this.renderTable(t)},this.updateControls=function(t){$.extend(t,{page:t.offset/t.limit+1,totalPages:Math.max(1,Math.ceil(t.count/t.limit))}),t.showPrev=t.page>1?t.page-1:!1,t.showNext=t.page<t.totalPages?t.page+1:!1,t.querying=r&&!$.isEmptyObject(_.omit(r,"path")),LL.Templates.fetch("list_controls",function(e){$(".list-controls",this.$node).html(e(t)),$(".list-controls a[data-page]",this.$node).click(function(t){var e=$(t.target).data("page");this.trigger("table:page",{page:e})}.bind(this)),$(".list-controls .csv-disabled").popover({trigger:"click",placement:"top",title:"Download CSV",html:!0,content:"Downloads are available to paid Site Control customers. Please sign in if you have an account, or <a href='https://sitecontrol.us'>sign up today</a>!"})}.bind(this))},this.renderTable=function(n){var o=_.collect(n.columns,function(){return{type:"text",readOnly:!0}}),s=_.pluck(n.columns,"label"),r={data:n.table||[],minSpareRows:0,contextMenu:!1,colHeaders:s,columns:o,currentRowClassName:"currentRow",currentColClassName:"currentCol",cells:function(){return{renderer:t(n)}}};e=i.handsontable(r).handsontable("getInstance")},this.onDestroy=function(){debug("destroy: list/table"),this.trigger("table:clear"),this.teardown()},this.after("initialize",function(){debug("hello hot table"),i=$(".hot",this.$node),n=this.attr.mapPath.length>0,this.on("pane:show",this.onShow),this.on("pane:hide",this.onHide),this.on("table:clear",this.onClear),this.on("table:load",this.onLoad),this.on("table:page",this.onPage),this.on("pane:request:refresh",this.onRequestRefresh),this.on(document,"query:changed",this.onQueryChanged),this.on(document,"mapp:destroy",this.onDestroy),this.on(document,"mapp:regions:switched",this.onSwitchedRegions),LL.Templates.preload(["table","list_controls"])})}LL.Table=flight.component(t,LL.ByRegion)}(),LL.Pie=function(){this.attributes({data:null,title:!1,colors:{},labels:{},toggle:!1});var t=null;this.initChart=function(){var e=this.transformChartData(this.attr.data);t=new Highcharts.Chart({chart:{animation:!1,renderTo:this.node,type:"pie",margin:[0,0,0,0],spacing:[0,0,0,0],marginRight:230,plotBackgroundColor:"none"},title:this.attr.title?{text:this.attr.title,style:{fontSize:"14px",fontFamily:"lato, sans-serif",fontWeight:"bold"},floating:!1,align:"left",x:148}:!1,legend:{align:"left",verticalAlign:"top",borderWidth:0,itemMarginBottom:4,x:140,y:18,layout:"vertical",itemStyle:{fontSize:"13px",fontWeight:"normal",fontFamily:"lato, sans-serif"},labelFormatter:function(){return this.name+"<span class='legend-num'>: "+numberWithCommas(this.y)+"</span>"}},tooltip:{enabled:!1},plotOptions:{pie:{allowPointSelect:!1,shadow:!1,dataLabels:{enabled:!1},showInLegend:!0}},series:[{type:"pie",name:this.attr.title,data:e,animation:!0,states:{hover:{enabled:!1}},point:{events:{legendItemClick:function(){return!1}}}}]}),$(".highcharts-background",this.$node).attr("fill","none"),this.updateChartLayout()},this.onSetData=function(t,e){this.updateChart(e)},this.updateChart=function(e){this.attr.data=e;var i=transformChartData(e);t.series[0].setData(i,!0,!0),t.redraw()},this.updateChartLayout=function(){this.$node.width();t&&(t.reflow(),t.redraw())},this.transformChartData=function(t){var e=this,i=_.map(t,function(t,i){var n=e.attr.labels[i]||i;$.isPlainObject(n)&&n.one&&(n=1==t?n.one:n.other);var o={name:n,y:t};return e.attr.colors&&e.attr.colors[i]&&(o.color=e.attr.colors[i]),o});return i=_.reject(i,function(t){return t.name&&0==t.name.length}),i=_.sortBy(i,function(){var t=0;return t})},this.onDestroy=function(){debug("destroy: pie chart"),this.teardown()},this.after("initialize",function(){var t=this;this.on("chart:set-data",this.onSetData),this.on(document,"mapp:destroy",this.onDestroy),$(window).resize(function(){t.updateChartLayout()}),this.initChart()})},function(){function t(){this.attributes({map:!1,navSel:".property-detail > ul.nav",containerSel:".property-detail .tab-content"});var t=!1,e=null,i=null,n="<li><a href='#add-content' data-toggle='tab' class='btn-sm add-content'><i class='fa fa-plus-circle'/> Add Post</a></li>",o={name:"Freehand Tagging",permissions:{post:!0,tag:!0},tags:[]};this.preprocess=function(){debug("post widget preprocessing...")},this.onPropertyLoaded=function(o,s){debug("Post widget adding tab for new property "+s.headline),t=!1,e=null,i=s,$(this.attr.navSel,this.$node).append(n)},this.onPropertyTabChanged=function(t){var e=$(t.target);e.hasClass("add-content")&&this.ensureTabContent()},this.ensureTabContent=function(){t||LL.Templates.fetch("add_content",function(t){var e=_.filter(this.attr.map.sources,function(){return!0}),n={map:this.attr.map,path:i.path,sources:e};n.sources&&0!=n.sources.length||(n.sources=[o]);var s=t(n);$(this.attr.containerSel,this.$node).append(s),this.postRender()}.bind(this))},this.postRender=function(){e=$(this.attr.containerSel+" #add-content",this.$node),$(".source-btn",e).moreButton(),_.each(this.attr.map.sources,function(t){if(t.survey){var i=$(".add-to-source[data-id="+t.id+"] .survey",e);LL.SurveyQuestions.attachTo(i,{questions:t.questions,skip:!1})}}.bind(this)),$(".add-to-source .editable.tags").each(function(t,n){var o=$(n).data("source");LL.Tags.attachTo(n,{map:this.attr.map,source:this.attr.map.sources[o],path:i.path,blank:"Enter new tag(s) for this parcel"}),$(n).on("save",function(){e.trigger("property:request",{path:i.path})})}.bind(this)),t=!0},this.onSubmitSurvey=function(t,n){$("#add-content",this.$node).css("opacity",.5),$("#submit-form .text",this.$node).text("Sending...").attr("disabled","1"),$.post("/blexts.json",{map_id:this.attr.map.id,spec:i.spec,fields:n.answers,images:n.images},function(){$("#add-content .survey",this.$node).trigger("bu:destroy"),$("#add-content",this.$node).html("<div class='centered'>Successfully posted your survey!</div>"),e.trigger("property:request",{path:i.path})}.bind(this)).error(function(){}.bind(this)).always(function(){$("#add-content",this.$node).css("opacity",1)}.bind(this))},this.onSavedTag=function(t){debug("success!"),debug(t)},this.onDestroying=function(){debug("post-component destroying itself");var t={"show.bs.tab":[this.attr.navSel]},e=this;_.each(t,function(t,i){debug(" - removing "+i+" handler on "+i+": "+t),_.each(t,function(t){e.$node.off(i,t)})}),this.teardown()},this.after("initialize",function(){this.on(document,"property:loaded",this.onPropertyLoaded),this.on(document,"mapp:destroy",this.onDestroying),this.on(document,"bu:survey:submit",this.onSubmitSurvey),this.$node.on("show.bs.tab",this.attr.navSel,this.onPropertyTabChanged.bind(this)),this.preprocess(),LL.Templates.preload(["add_content"])})}LL.Post=flight.component(t)}(),function(){function t(){var t="",e=!1,i=null,n=null,o=null;this.attributes({headline:"#search > h3.address",container:"#search .search-results",spec:{},path:"",threads:[],standalone:!1,mapId:!1,mapSlug:!1,surveyable:!1}),this.onPropertyRequested=function(t,e){this.loadProperty(e)},this.loadProperty=function(i){var n="#"+this.$node.attr("id");this.trigger("pane:request:show",{tab:n}),e||(e=!0,i.path?this.loadDetails(i.path):(t=Handlebars.compile(i.pathTemplate),this.loadDetails(i)))},this.transform=function(t){t.numThreads=t.threads&&t.threads.length>0?t.threads.length:!1;var e=$.extend({},t),i=function(t){return function(e,i){return $.extend({key:i,value:e},"undefined"==typeof t?{}:{mapId:t.map_id,blextId:t.id})}};return e.fields=_.collect(t.fields,i()),_.each(e.blexts,function(t){t.originalFields=t.fields,t.fields=_.collect(t.fields,i(t)),t.tags||(t.tags=[]),t.image&&t.image_date&&window.data.sitecontrol&&(t.image.medium="/assets/icons/house_medium.jpg")}),(e.mapId=this.attr.mapId)&&(e.path+="?map_id="+e.mapId),e
},this.render=function(t){var e=$(this.attr.container),i=this.transform(t),n={formatLabel:function(e){var i=e.key;return t.blext_key&&e.mapId&&t.blext_key[e.mapId]&&t.blext_key[e.mapId][i]?t.blext_key[e.mapId][i]:t.key&&t.key[i]?t.key[i]:s.titleize(i)},formatValue:function(e){var i=e.key+"."+e.value;return t.blext_key&&e.mapId&&t.blext_key[e.mapId]&&t.blext_key[e.mapId][i]?t.blext_key[e.mapId][i]:"string"==typeof e.value&&e.value.match(/^(http|https):\/\//)?s.sprintf("<a href='%s' target='loveland_ext'>External link</a>",e.value):e.value}};LL.Templates.fetch(["property_detail","property_fields","property_field_row","property_foldout"],function(o){Handlebars.registerHelper(n);var s=i.headline;$(this.attr.headline).html(s),e.html(o.property_detail(i)),this.postRender(i,t),Handlebars.unregisterHelper("formatLabel"),Handlebars.unregisterHelper("formatValue")}.bind(this))},this.postRender=function(t,e){$(".foldout-title",this.$node).click(function(t){$(".property-foldout",this.$node).toggleClass("hide");var e=$(".property-foldout",this.$node).is(":visible")?"fa-caret-down":"fa-caret-right";return $(".fa",t.target).attr("class","fa "+e),!1}.bind(this)),window.data.sitecontrol&&$("a[href=#property-talk]",this.$node).parent().hide(),$(".footnotes a",this.$node).attr("target","loveland_ext"),$(".birdseye-buttons .btn",this.$node).click(this.onClickRotateOblique.bind(this)),this.setPageTitle(e.headline),this.setupDiscussion(t.threads||[]),this.trigger("property:loaded",e)},this.setPageTitle=function(t){var e=null;"undefined"!=typeof t&&t?(n=t,i||(i=document.title),e=t+" - "+i):i&&(e=i,i=null),e&&this.trigger("navbar:set",{key:"title",value:e})},this.onSwitchedRegions=function(t,e){i=null,o=e.path},this.onClickRotateOblique=function(t){var e=$(".birdseye-buttons",this.$node),i=e.data("base-url"),n=parseInt(e.data("angle")),o=parseInt($(t.currentTarget).data("increment"));n=(n+o)%360;var s=i+"?angle="+n;return $("img.streetview",this.$node).attr("src",s),e.data("angle",n),!1},this.loadDetails=function(i){var n,r,a=null;"string"==typeof i?n=i:$.isPlainObject(i)?n=t(i):(a=i,n=t({fid:a})),r=n+".json",r=r.replace(/^\/sc\//,"/us/").replace(/_/g,"-"),this.attr.mapId&&(r+="?map_id="+this.attr.mapId);var l=LL.Spinner.start();$.get(r,function(t){if("ok"==t.status){this.spec=t.spec,this.path=t.path;var e="us"!=(t.spec.country||"us");t.surveyorPath=this.attr.mapId?this.attr.surveyable?s.sprintf("/survey/%s#p=%s&s=%s",this.attr.mapSlug,this.path,o):!1:e?!1:s.sprintf("/survey#p=%s&s=%s",this.path,o),this.render(t)}}.bind(this)).always(function(){LL.Spinner.stop(l),e=!1})},this.setupDiscussion=function(t){var e=this,i=$(".threads");LL.Templates.fetch(["thread","reply","talk_box"],function(n){if(0==t.length&&i.append("<p>There's no discussion on this property yet.</p>"),_.each(t,function(t){i.append(n.thread(t));var o=$(".thread[data-parent='"+t.id+"']");$("a.reply-button",o).click(function(t){var i=$(t.currentTarget).closest(".reply-container"),n=i.data("parent");LL.TalkBox.addTo(n,{ajax:!0,spec:e.spec})})}),window.data.signed_in){$(".new-thread-container").append(n.talk_box({}));var o=$(".new-thread-container .talk-box");LL.TalkBox.attachTo(o,{ajax:!0,spec:e.spec})}})},this.onAddedComment=function(t,e){LL.Templates.fetch("reply",function(t){var i=t(e);if(e.parent_id){var n=$(".thread[data-parent="+e.parent_id+"]",this.$node),o=$(".reply-container",n);$(i).insertBefore(o)}else $(".threads",this.$node).append(i)}.bind(this))},this.onHashChange=function(){var t=$.bbq.getState("p");t&&this.path!=t&&this.trigger("property:request",{path:t})},this.onLeaving=function(){this.trigger("property:destroy")},this.onPaneShow=function(){this.setPageTitle(n)},this.onPaneHide=function(){debug("hiding property pane"),$.bbq.removeState("p"),this.setPageTitle(!1)},this.onDestroyRequest=function(){debug("destroy: property"),$(".foldout-title",this.$node).off("click"),$(this.attr.container).empty(),$(this.attr.headline).text(""),this.$node.attr("data-id",""),this.attr.standalone&&map&&(map.map.remove(),map=null),this.teardown()},this.after("initialize",function(){this.spec=this.attr.spec,this.path=this.attr.path,debug("property view initializing"),this.$node.attr("data-id",this.attr.spec.id),this.on("pane:hide",this.onPaneHide),this.on("pane:show",this.onPaneShow),this.on(document,"property:request",this.onPropertyRequested),this.on(document,"property:destroy",this.onDestroyRequest),this.on(document,"mapp:regions:switched",this.onSwitchedRegions),this.on(document,"mapp:destroy",this.onDestroyRequest),this.on(window,"hashchange",this.onHashChange),this.attr.standalone&&this.on(document,"page:requesting",this.onLeaving),this.on(document,"talk:comment:add",this.onAddedComment),LL.Templates.preload(["property_detail","property_fields","property_foldout"])})}LL.Property=flight.component(t),LL.Property.RE=/^\/([a-z0-9-]+)\/([a-z]{2})\/(?:(?:(.+)\/)?)(.+)\/([0-9]+)$/i}(),function(){LL.QCAnswers=flight.component(function(){this.attributes({map:!1,blank:"(Blank)"});var t=null,e=null,i=null,n=null;const o=0,r=1,a=2;this.onQCShow=function(n,o){t&&this.removeInterface(),t=o.blextId,currentBlext=o.blext,e=o.tabPane,i=$(".blext-fields table.fields",e);var s=this.currentSource();s&&(("Survey"==s.type||"MCM Survey"==s.type)&&(this.disambiguate(),this.makeFieldsEditable(),this.updateDeps()),s.permissions.tag&&this.makeTagsEditable()),this.sortAnswers()},this.currentSource=function(){return this.attr.map.sources[currentBlext.source_id]};var l=function(t){var e=n.colToDisambig;return e&&e[t]?e[t]:t},h=function(t){var e=n.disambigToCol;return e&&e[t]?e[t]:t};this.makeFieldsEditable=function(t){var e=this,i=function(){var t=$(this).data("name"),i=l(t),n=e.answerOptions[i];return n=_.collect(n,function(t){return{value:t.value,text:t.label}}),n.unshift({value:"",text:e.attr.blank}),n},n=this.answerElements(t);n.each(function(t,i){var n=$(i).data("name"),o=l(n),s=e.answerOptions[o]&&e.answerOptions[o].length>0?"select":"textarea";$(i).data("type",s)}),n.editable({mode:"inline",url:this.attr.map.path+"/blexts.json",source:i,inputclass:"form-control input-med",ajaxOptions:{method:"PUT",dataType:"json"},emptytext:e.attr.blank}).on("save",function(t,e){debug("editable saved: "+e.response.key+" = "+e.response.newValue),this.updateDeps(e.response)}.bind(this))},this.makeTagsEditable=function(){var t=$(".fields tr[data-key=tags]",this.$node),e=$("td.value",t),i=$("span.editable",e);t.removeClass("hide"),LL.Tags.attachTo(i,{map:this.attr.map,source:this.currentSource(),blextId:currentBlext.id,blank:this.attr.blank})},this.sortAnswers=function(){var t=function(t,e){var i=$(t).data("key"),n=$(e).data("key");i=l(i),n=l(n);var o=this.ordering[i],s=this.ordering[n];return s>o?-1:o>s?1:0},e=$("tr",i).get(),n=$("tbody",i).get(0);e.sort(t.bind(this));for(var o=0;o<e.length;o++)n.appendChild(e[o])},this.answerElements=function(t){var e=".field .value > span.editable";return"undefined"!=typeof t&&(e+=s.sprintf("[data-name='%s']",t)),$(e,i)},this.disambiguate=function(t){currentBlext&&(this.colToDisambig={},"undefined"==typeof t&&(t=currentBlext.originalFields),this.walkQuestions(t,function(t){t.disambiguation&&(debug("tagging "+t.column+" as "+t.disambiguation+" really"),this.colToDisambig[t.column]=t.disambiguation)}.bind(this)))},this.walkQuestions=function(t,e){for(var i=0,n=this.attr.map.questions[i],o=null,s=null;n;){e.apply(this,[n,i]);var r=n.disambiguation||n.column;if(o=null,s=t[n.column],"string"==typeof n.answers)i+=1;else if(s&&(o=_.findWhere(n.answers,{value:s}),o&&(i=o.next?o.next.index:i+1)),!o){var a=_.collect(n.answers,function(t){return t.next?t.next.index:-1});if(a=_.reject(_.uniq(a),function(t){return-1===t}),1==a.length)i=a[0],debug("only one possible next-question for "+r+" so going there: "+i);else{debug("there are "+a.length+" possible next-questions here and we don't know which to choose...");var l=_.findIndex(this.attr.map.questions.slice(i+1),function(e){return"undefined"!=typeof t[e.column]});-1!=l?(l+=i+1,debug("  well the next answered one for this blext is "+l+" so going there "),i=l):(debug("can't find an implicit question to go to next, so falling out"),i="bye!")}}n=this.attr.map.questions[i]}},this.updateDeps=function(t){var e=this.answerElements(),n=e.editable("getValue");"undefined"!=typeof t&&(n[t.key]=t.newValue,this.disambiguate(n)),this.dependencies={},_.each(n,function(t,e){var i=l(e);this.dependencies[i]=t&&t.length>0?a:o}.bind(this)),this.walkQuestions(n,function(t){var e=t.disambiguation||t.column;this.dependencies[e]=r}.bind(this)),debug(this.dependencies),_.each(this.dependencies,function(t,e){var n=this.disambigToCol[e]||e,l=$(s.sprintf("tr[data-key='%s']",n),i);t==a?l.addClass("danger"):t==r?l.exists()?l.removeClass("danger"):this.addBlankQuestion(e):t==o&&l.removeClass("danger")}.bind(this))},this.addBlankQuestion=function(e,n){debug("inserting editable question row for "+e);var o=this,s=h(e),r=_.where(this.attr.map.questions,{column:s})[0],a={key:s,value:n,mapId:this.attr.map.id,blextId:t},l={formatLabel:function(){return r.question},formatValue:function(t){var e=_.where(r.answers,{value:t.value})[0];return e?e.label:o.attr.blank}};LL.Templates.fetch("property_field_row",function(t){Handlebars.registerHelper(l);var n=t(a);Handlebars.unregisterHelper("formatLabel"),Handlebars.unregisterHelper("formatValue"),i.append(n),this.makeFieldsEditable(e),this.sortAnswers()}.bind(this))},this.onQCHide=function(){this.removeInterface()},this.removeInterface=function(){if(t){var n=this.answerElements();n.editable("destroy"),n.addClass("editable"),t=null,e=i=null}},this.onDestroying=function(){debug("qc answers destroying"),this.teardown()},this.after("initialize",function(){this.on(document,"qc:show",this.onQCShow),this.on(document,"qc:hide",this.onQCHide),this.on(document,"mapp:destroy",this.onDestroying),n=this,this.disambigToCol={},this.answerOptions=_.object(_.collect(this.attr.map.questions,function(t){var e=t.disambiguation||t.column;return t.disambiguation&&(this.disambigToCol[t.disambiguation]=t.column),"string"==typeof t.answers?[e,[]]:[e,t.answers]}.bind(this))),this.ordering=_.object(_.collect(this.attr.map.questions||[],function(t,e){return[t.disambiguation||t.column,e]})),this.ordering.tags=(this.attr.map.questions||[]).length})})}(),function(){function t(){this.attributes({map:!1,container:"#qc-bar-seat",onClass:"btn-info",offClass:"btn-default",permissions:{}});var t=!1,e=null,i=null,n=null,o=null,r=null,a=!1,l=null;this.onClickFlag=function(t){var e=$(t.currentTarget).data("type");this.doFlag(o,e,$(t.currentTarget)),t.preventDefault()},this.doFlag=function(t,e,i){$("#property-content .item.active"),$("#qc-bar");i.hasClass(this.attr.onClass)&&(e="normal"),$.ajax({async:!0,type:"POST",url:"/blexts/"+t+"/flag.json",cache:!1,data:{id:t,type:e},success:this.onFlagged.bind(this),error:function(){}})},this.onFlagged=function(t){"ok"==t.status&&($("a.btn[data-type]",this.$node).removeClass(this.attr.onClass),$("a.btn[data-type='"+t.blext_status+"']").addClass(this.attr.onClass))},this.onClickRemove=function(t){this.doRemove(),t.preventDefault()},this.doRemove=function(){var t=$(".nav a[data-blext-id="+o+"]",this.$node);n.css("opacity",.3),$.ajax({async:!0,type:"DELETE",url:"/blexts/"+o+".json",cache:!1,data:{},success:this.onRemoved.bind(this,{id:o,tab:t,pane:n}),error:function(){i.trigger("notify:message",{message:"We couldn't remove that post, sorry."}),pane.css("opacity",1)}.bind(this)})},this.onRemoved=function(t){var e=$("li:first-child a",t.tab.closest(".nav"));this.hide(),t.tab.remove(),t.pane.remove(),e.tab("show"),$("#property-basic",this.$node).addClass("active in"),$(s.sprintf("#feed .feed-item[data-id='%s']",t.id)).remove()},this.onClickNext=function(t,e){var i=$("#feed .feed-item[data-id='"+o+"']"),n=("next"==t?i.nextAll:i.prevAll).bind(i),s=n(".feed-item").first(),r=s.data("path"),a=s.data("id");this.trigger("property:request",{path:r,blextId:a}),e.preventDefault()},this.onClickPhotoAction=function(t){var e=$(t.currentTarget),i=e.closest(".blext-image"),o=$(".blext-image",n),s=_.indexOf(o,i.get(0)),r={index:s,verb:e.data("action"),angle:e.data("angle")};return this.doPhotoAction(r,i),!1},this.doPhotoAction=function(t,e){if("replace"==t.verb)return void this.startReplacing(t);var i={remove:function(){e.fadeOut()},replace:function(t){var i=$("img",e);i.attr("src",t.image.medium+"?t="+moment().unix())},rotate:function(t){var i=$("img",e);i.attr("src",t.image.medium+"?t="+moment().unix())},reorder:function(){}},n=LL.Spinner.start();$.post("/blexts/"+o+"/photo.json",t,function(e){"ok"==e.status?i[t.verb].apply(this,[e]):debug(e)}.bind(this)).error(function(t){debug(t)}.bind(this)).always(function(){LL.Spinner.stop(n)})},this.startReplacing=function(){};var h=null;this.configUploader=function(t){var e=$("input.image-uploader",i);if(e.hasClass("imp"))return void e.fileupload("option","url","/blexts/"+t+"/photo.json").addClass("imp");var o=null;if(!h){var s="{{#each images}}<div class='property-image blext-image'><a href='{{original}}' target='blexts'><img src='{{medium}}'/></a></div>{{/each}}";h=Handlebars.compile(s)}e.fileupload({fileInput:e,url:"/blexts/"+t+"/photo.json",paramName:"images[]",singleFileUploads:!1,processQueue:[],formData:{verb:"add"}}).on("fileuploadadd",function(t,e){o=LL.Spinner.start(),e.submit()}).on("fileuploaddone",function(t,e){var i=h(e.result);$(".property-images",n).append(i)}).on("fileuploadalways",function(){LL.Spinner.stop(o)})},this.onClickUpload=function(t){return $(".image-uploader",i).click(),t.preventDefault(),!1};this.setupSortable=function(){var t=$(".blext-image",this.$node);return void $(".handle",t).hide()},this.updateArrows=function(){var t=$("#feed .feed-item[data-id='"+o+"']");if(!t.exists())return void $("a.prev, a.next",i).attr("disabled","1");var e=t.prevAll(".feed-item").first(),n=t.nextAll(".feed-item").first();e.exists()?$("a.prev",i).removeAttr("disabled"):$("a.prev",i).attr("disabled","1"),n.exists()?$("a.next",i).removeAttr("disabled"):$("a.next",i).attr("disabled","1")},this.updateColors=function(t){$("a[data-type]",i).removeClass(this.attr.onClass).addClass(this.attr.offClass),$("a[data-type='"+t+"']",i).removeClass(this.attr.offClass).addClass(this.attr.onClass)},this.onQCPropertyRequested=function(t,e){r=e.blextId},this.onQCPropertyLoaded=function(t,i){a=!1,e=$(this.attr.container,this.$node),l=i,r&&(debug("opening right up to "+r),$(s.sprintf("ul.nav a[data-blext-id='%s']",r),this.$node).tab("show"),r=null)},this.onPropertyTabChanged=function(t){var e=$(t.target);if(e.hasClass("blext-tab")){var i=e.data("blext-id"),n=e.data("blext-status");debug("looking at blext "+i+" now"),this.showForBlext(i,n)}else this.hide()},this.showForBlext=function(n,o){a?this.activate(n):LL.Templates.fetch("qc_bar",function(s){e.html(s({show:t})),i=$("#qc-bar",e),a=!0,this.activate(n,o)}.bind(this))},this.activate=function(e){o=e,this.updateArrows(),n=$(".tab-pane#property-blext-"+e,this.$node),this.attr.permissions.qc_photos&&($(".qc-buttons",this.$node).remove(),LL.Templates.fetch("qc_photos",function(t){var e=t({});$(".blext-image",n).append(e),this.setupSortable()}.bind(this)));var s=_.findWhere(l.blexts,{id:e});return s?(this.updateColors(s.status),this.configUploader(e),t&&i.fadeIn(),void i.trigger("qc:show",{blextId:e,tabPane:n,blext:s})):void debug("qcbar couldn't find the requested blext in currentProperty.blexts!")},this.hide=function(){o=null,n=null,i&&(t&&i.fadeOut(),i.trigger("qc:hide")),$(".qc-buttons",this.$node).remove()},this.onDestroying=function(){debug("qc bar destroying");var t={click:["#qc-bar .approve, .flag, .revisit","#qc-bar .remove","#qc-bar .next","#qc-bar .prev"],"shown.bs.tab":[".property-detail ul.nav"]},e=this;_.each(t,function(t,i){debug(" - removing click handler on "+i+": "+t),_.each(t,function(t){e.$node.off(i,t)})}),this.teardown()},this.after("initialize",function(){t=this.attr.map.qc,this.on(document,"property:request",this.onQCPropertyRequested),this.on(document,"property:loaded",this.onQCPropertyLoaded),this.on(document,"mapp:destroy",this.onDestroying),this.$node.on("click","#qc-bar .approve, .flag, .revisit",this.onClickFlag.bind(this)),this.$node.on("click","#qc-bar .remove",this.onClickRemove.bind(this)),this.$node.on("click","#qc-bar .upload",this.onClickUpload.bind(this)),this.$node.on("click","#qc-bar .next",this.onClickNext.bind(this,"next")),this.$node.on("click","#qc-bar .prev",this.onClickNext.bind(this,"prev")),this.$node.on("shown.bs.tab",".property-detail ul.nav",this.onPropertyTabChanged.bind(this)),this.$node.on("click",".property-detail .qc-buttons a",this.onClickPhotoAction.bind(this)),LL.Templates.preload(["qc_bar","qc_photos"])})}LL.QCBar=flight.component(t)}(),LL.Radio=function(){this.attributes({});var t=!1;this.connected=!1,this.client=null;var e=this,i={};this.onMessage=function(t){e.trigger("radio:received",t)},this.incrementChannel=function(t,e){"undefined"==typeof i[t]&&(i[t]=0),i[t]+=e,i[t]<=0?(this.client.unsubscribe(n(t)),delete i[t]):1==i[t]&&1==e&&this.client.subscribe(n(t),this.onMessage),$.isEmptyObject(i)&&this.disconnect()};var n=function(t){return"/"+window.data.env+t};this.onSubscribe=function(i,n){t&&(this.connected||this.connect(),debug("radio subscribe: "+n.channels.join(", ")),_.each(n.channels,function(t){e.incrementChannel(t,1)}))},this.onUnsubscribe=function(i,n){t&&(debug("radio unsub: "+n.channels.join(", ")),_.each(n.channels,function(t){e.incrementChannel(t,-1)}))},this.connect=function(){if(!t)return void debug("Radio trying to connect but doesn't have faye.js loaded");if(this.connected)return void debug("radio already connected, ignoring");var e=data.faye_protocol+"://"+data.faye_host+":"+data.faye_port+"/faye";this.client=new Faye.Client(e),debug("radio connecting"),this.client.addExtension({outgoing:function(t,e){return"/meta/subscribe"!==t.channel?e(t):(t.ext=t.ext||{},t.ext.user_id=data.current_user_id,t.ext.session_id=data.session_id,t.ext.csrf_token=$('meta[name="csrf-token"]').attr("content"),void e(t))}}),this.connected=!0,this.trigger("radio:connected")},this.disconnect=function(){this.connected&&(debug("radio disconnecting"),i={},this.connected=!1,this.trigger("radio:disconnected"))},this.after("initialize",function(){e=this,t="undefined"!=typeof Faye,this.on(document,"radio:subscribe",this.onSubscribe),this.on(document,"radio:unsubscribe",this.onUnsubscribe)})},function(){function t(){this.attributes({placeholder:"Find an address or place",domain:["places","parcels"],contextPath:!1,mapp:!1,follow:!0,resultsDiv:"",mapId:!1}),this.contextPath=null,this.headlineToPath={};var t=null,e={};this.makeTypeahead=function(){t=new Bloodhound({identify:function(t){return debug(t.path),t.path},datumTokenizer:function(t){return t},queryTokenizer:function(t){return t},remote:{url:"places"==this.attr.domain?"/search/places.json":"/search.json",prepare:function(t,e){var i={query:t,context:this.contextPath};return e.url=e.url+"?"+$.param(i),e}.bind(this),transform:function(t){return t}}}),LL.Templates.fetch(["search_not_found","search_result","search_pending","search_footer"],function(i){this.$search.typeahead({minLength:3},{name:"search",source:t,limit:20,display:"headline",highlight:!0,templates:{notFound:i.search_not_found,pending:i.search_pending,suggestion:i.search_result,footer:i.search_footer}}).on("typeahead:selected",function(t,e){return this.trigger("search:selected",e),this.attr.mapp?(this.trigger("parcel"==e.category?"property:request":"mapp:regions:request",e),this.$search.typeahead("val","")):this.attr.follow&&(window.location=e.path),t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!1}.bind(this)).on("typeahead:render",function(){var t=_.rest(arguments,1),i=[];if(_.each(t,function(t){if(e[t.path]){var n=e[t.path];n!==!0&&$("img[data-path='"+t.path+"']",this.$form).attr("src",n)}else t.image||(e[t.path]=!0,i.push(t.path))}.bind(this)),0!=i.length){var n={paths:i};$.get("/search/images.json?"+$.param(n),function(t){"ok"==t.status&&_.each(t.images,function(t,i){e[i]=t,$("img[data-path='"+i+"']",this.$form).attr("src",t)}.bind(this))}.bind(this))}}.bind(this))}.bind(this))},this.onClickResult=function(t){return t.preventDefault(),!1},this.onKeypress=function(t){13==t.keyCode||27==t.keyCode&&this.trigger("search:escape")},this.onPaste=function(){setTimeout(function(){var t=this.$search.val();debug("pasted '"+t+"'")}.bind(this),100)},this.onSwitchedRegions=function(t,e){this.contextPath=e.outline?e.outline.properties.path:e.path},this.onClickAllResults=function(t){var e={query:this.$search.typeahead("val"),context:this.contextPath,map_id:this.attr.mapId};return window.location="/search?"+$.param(e),t.preventDefault(),!1},this.onDestroy=function(){debug("destroy: search"),e={},this.$search.typeahead("destroy"),this.teardown()},this.after("initialize",function(){this.contextPath=this.attr.contextPath,this.$form=this.$node,this.$search=$("input[name=search]",this.$form),this.$search.attr("placeholder",this.attr.placeholder);var t="#"+this.$node.attr("id");this.on(document,"mapp:regions:switched",this.onSwitchedRegions),this.on(t+" input[name=search]","keypress",this.onKeypress),this.on(t+" input[name=search]","paste",this.onPaste),this.on(document,"mapp:destroy",this.onDestroy),this.$form.on("click",".tt-menu a.all-results",this.onClickAllResults.bind(this)),this.$form.on("click",".tt-menu a:not(.all-results)",this.onClickResult.bind(this)),this.makeTypeahead(),LL.Templates.preload(["search_not_found","search_result","search_pending","search_footer"])})}LL.Search=flight.component(t)}(),LL.Signup=function(){this.attributes({signedIn:!1,mySubscriptions:[],groupDetails:null,selectedPlan:null,selectedCycle:null,planMatrix:{},offer:null,originalCardToken:null,clientToken:null});var t=!1,e=null,i=null,n=null,o=null,r=null,a=null,l=null,h=null;this.showCurrent=function(){var t=this.attr.groupDetails;t?(t.limits={users:this.attr.planMatrix[t.tier].users,maps:this.attr.planMatrix[t.tier].maps},LL.Templates.fetch("signup_group_details",function(e){var i=e(t);$("#existing").html(i).removeClass("hide"),this.highlightTier(t.tier)}.bind(this))):this.attr.mySubscriptions.length>0&&$("#existing .debug",this.$node).text(JSON.stringify(this.attr.mySubscriptions))},this.initialState=function(){var t=$.bbq.getState("p");if($(".step.disabled input",this.$node).attr("disabled","1"),t)o=t;else{if(!this.attr.offer)return;o=this.attr.offer.subtier,r=this.attr.offer.plan,debug(s.sprintf("starting page off with plan %s and cycle %s",o,r))}if(this.attr.offer){this.overrideDisplayPrices(o,r,this.attr.offer.price),this.highlightTier(this.attr.offer.subtier),this.trigger("signup:proceed",{section:"#cycle",noScroll:!0});var e=$("#cycle a.cycle[data-cycle="+r+"]");e.addClass("active"),$(".fa",e).removeClass("hide"),this.usingOffer()&&($("#plans a.yes:not(.active), #cycle a.cycle:not(.active)").addClass("disabled"),this.attr.offer.price||$("#cycle").hide()),this.trigger("signup:proceed",{section:"#signin",noScroll:!0})}t&&$(s.sprintf("#plans a.yes[data-tier='%s']",o),this.$node).trigger("click")},this.overrideDisplayPrices=function(t,e,i){var n=$(s.sprintf("#signup .price[data-tier='%s'][data-cycle='%s']",t,e));n.each(function(t,e){var n=$(e).text(),o=s.sprintf("<s>%s</s> <b>$%s</b>",n,numberWithCommas(i));$(e).html(o)})},this.onClickPlan=function(t){if(this.usingOffer())return void t.preventDefault();var e=$(t.target).closest("a").data("tier");o=e,this.highlightTier(e),trackEvent("subscription","plan",o);var i=this.checkLimits();i?LL.Templates.fetch("downgrade_warning",function(t){var e=t(i);$("#downgrade .warnings").html(e),this.trigger("signup:proceed",{section:"#downgrade"})}.bind(this)):($("#downgrade").is(":visible")&&$("#downgrade").slideUp(),this.trigger("signup:proceed",{section:"#cycle"})),t.stopPropagation()},this.onClickCycle=function(t){var e=$(t.currentTarget).attr("data-cycle");r=e;var i=$("#cycle a.cycle"),n=$("#cycle a.cycle[data-cycle="+e+"]");i.removeClass("active"),$(".fa",i).addClass("hide"),n.addClass("active"),$(".fa",n).removeClass("hide"),trackEvent("subscription","cycle",r),this.trigger("signup:proceed",{section:"#signin"}),t.stopPropagation()},this.onClickTrialProceed=function(t){trackEvent("subscription","trial"),this.trigger("signup:proceed",{section:"#signin"}),t.stopPropagation()},this.highlightTier=function(t){var e=$("#plans a.yes"),i=$("#plans a.yes[data-tier="+t+"]");e.removeClass("active"),$(".fa",e).addClass("hide"),i.addClass("active"),$(".fa",i).removeClass("hide")},this.highlightStep=function(){},this.onProceed=function(t,e){if("#cycle"==e.section)"trial"==o?($("#cycle .choose-cycle").addClass("hide"),$("#cycle .trial-note").removeClass("hide"),r="monthly"):($("#cycle .choose-cycle").removeClass("hide"),$("#cycle .trial-note").addClass("hide"));else if("#signin"==e.section){if(l){var i=$(e.section,this.$node);return i.removeClass("disabled").removeClass("hide"),void this.trigger("signup:proceed",$.extend({},e,{section:"#card"}))}}else if("#card"==e.section){if(this.usingOffer()&&!this.attr.offer.price)return $("#card").is(":visible")&&$("#card").slideUp(),void this.trigger("signup:proceed",$.extend({},e,{section:"#group"}));this.ensureWallet()}else"#summary"==e.section&&($("#plans a.btn, #cycle a.btn").attr("disabled","1"),this.showSummary());"#summary"!=e.section&&$("#summary").addClass("disabled");var i=$(e.section,this.$node);if(i.removeClass("disabled").removeClass("hide"),$("input",i).removeAttr("disabled"),!e.noScroll){var n=i.get(0).offsetTop-80;$("#pjax-container").delay(400).animate({scrollTop:n},800)}},this.onGroupContinue=function(t){var e=$("input#group_name").val();this.validateGroupName(e,{valid:function(){a={name:e},$(t.currentTarget).html("<i class='fa fa-check-circle'/> Looks good!").addClass("active"),$("input#group_name").attr("disabled","true"),trackEvent("subscription","group_name",e),this.trigger("signup:proceed",{section:"#summary"})}.bind(this),error:function(e){$(t.target).html("<i class='fa fa-meh-o'/> "+e).removeClass("active"),$("input#group_name").removeAttr("disabled")}}),t.stopPropagation()},this.validateGroupName=function(t,e){var i=!0,n=null;t.length<2&&(i=!1,n="Sorry, we need you to enter something"),i?e.valid.apply(this):e.error.apply(this,[n])},this.checkLimits=function(){var t=this.attr.planMatrix[r],e=this.attr.groupDetails;if(e){debug("Checking limits:"),debug(t),debug(e);var i=null;return t.users&&t.users<e.users&&(i||(i={}),i.extraUsers=e.users-t.users),t.maps&&t.maps<e.maps&&(i||(i={}),i.extraMaps=e.maps-t.maps),i}},this.onSignIn=function(t){{var e=$(".sign_in_container input[name=email]",this.$node).val(),i=$(".sign_in_container input[name=password]",this.$node).val();$("input[name=agree]",this.$node).val()}$("#signin .forms").addClass("disabled");var n=LL.Spinner.start();trackEvent("subscription","passport","login"),$.post("/users/sign_in.json",{email:e,password:i},this.onSignedIn.bind(this)).always(function(){LL.Spinner.stop(n)}),t.stopPropagation()},this.onSignUp=function(t){var e=$(".sign_up_container input[name=name]",this.$node).val(),i=$(".sign_up_container input[name=email]",this.$node).val(),n=$(".sign_up_container input[name=password]",this.$node).val(),o=$("input[name=agree]",this.$node).val();$("#signin .forms").addClass("disabled");var s=LL.Spinner.start();trackEvent("subscription","passport","register"),$.post("/users.json",{"user[name]":e,"user[email]":i,"user[password]":n,agree:o},this.onSignedIn.bind(this)).always(function(){LL.Spinner.stop(s)}),t.stopPropagation()},this.onSignedIn=function(t){var e=$("#signin .forms");t.token?(h=t.token,l=!0,window.data.signed_in=!0,window.data.current_user_id=t.id,window.data.username=t.name,$("#signin .copy").slideUp(),e.css("opacity","0").delay(500).html("<h3 class='centered'><i class='fa fa-thumbs-up'/> You are now signed in as "+t.name+"</h3>").removeClass("disabled").css("opacity","1"),this.trigger("signup:proceed",{section:"#card"})):($("#signin .copy").removeClass("hide").text("Oops, we weren't able to sign you in, please try again. The system says: "+t.message),e.removeClass("disabled"))},this.ensureWallet=function(){$("#wallet").hasClass("loaded")||flight.component(LL.Wallet).attachTo("#wallet",{clientToken:e,authToken:h,originalCardToken:this.attr.originalCardToken,addCardTitle:"Add a Card"})},this.onClickSignIn=function(t){$(".sign_in_container").removeClass("hide"),$(".sign_up_container").addClass("hide"),t.preventDefault()},this.onClickSignUp=function(t){$(".sign_up_container").removeClass("hide"),$(".sign_in_container").addClass("hide"),t.preventDefault()},this.onSigninKeypress=function(t){if(13==t.keyCode){var e=$(t.target).closest(".sign_in_container, .sign_up_container");$("a.btn",e).click(),t.stopPropagation()}},this.onCardChosen=function(t,n){e=n.clientToken,debug(n.card),i=n.card,trackEvent("subscription","billing"),this.trigger("signup:proceed",{section:"#group"})},this.onDowngradeAnyway=function(t){this.trigger("signup:proceed",{section:"#card"}),t.stopPropagation()},this.usingOffer=function(){return this.attr.offer&&r==this.attr.offer.plan&&o==this.attr.offer.subtier},this.showSummary=function(){var t=this.attr.planMatrix[r].subtiers[o],e={group:a.name,verb:this.attr.groupDetails?"switching to":"signing up for",plan:o,planName:t.name,card:i,cycle:"annual"==r?"a year":"monthly"};n=this.usingOffer()?this.attr.offer.price:t.price,n>0&&(e.price=n,e.trial="trial"==o,e.trialEnds=moment().add(14,"days").format("MMMM D, YYYY")),LL.Templates.fetch("signup_summary",function(t){$("#summary .info").html(t(e))}.bind(this))},this.onLeaving=function(){debug("signup page onLeaving"),this.trigger("signup:destroy")},this.onComplete=function(t){$(t.target).addClass("disabled"),this.submitOrder()},this.submitOrder=function(){if(!t){t=!0;var s={plan:r,subtier:o,group:a,client_token:e,card_token:i?i.token:null,token:h,offer:this.usingOffer()?this.attr.offer:null},l=LL.Spinner.start();trackEvent("subscription","finish",n),$.post("/account/subscriptions.json",s,function(t){if("ok"==t.status)$(".errors",this.$node).empty().addClass("hide"),window.location=t.path;else{var e=[t.message].concat(t.errors||[]);$(".errors",this.$node).html(e.join("<br/>")).removeClass("hide")}}.bind(this)).always(function(){LL.Spinner.stop(l),t=!1}.bind(this))}},this.after("initialize",function(){o=this.attr.selectedPlan,r=this.attr.selectedCycle,a=this.attr.groupDetails,l=this.attr.signedIn,e=this.attr.clientToken,this.on(document,"pjax:beforeSend",this.onLeaving),this.on("signup:proceed",this.onProceed),this.on("a.yes","click",this.onClickPlan),this.on("a.cycle","click",this.onClickCycle),this.on("a.trial-proceed","click",this.onClickTrialProceed),this.on("#group .continue","click",this.onGroupContinue),this.on("#signin input","keypress",this.onSigninKeypress),this.on("#signin .btn.signin","click",this.onSignIn),this.on("#signin .btn.signup","click",this.onSignUp),this.on("#downgrade .anyway","click",this.onDowngradeAnyway),this.on("#summary .complete","click",this.onComplete),this.on(".sign_in_link","click",this.onClickSignIn),this.on(".sign_up_link","click",this.onClickSignUp),this.on("wallet:chosen",this.onCardChosen),LL.Templates.preload(["signup_summary","signup_group_details","downgrade_warning"]),trackEvent("subscription","welcome"),this.showCurrent(),this.initialState()})},function(t){t.fn.spinline=function(){var e="<div class='centered'><i class='fa fa-spinner fa-spin big'></div>";return this.each(function(){return t(this).html(e),this})}}(jQuery),function(){var t=1,e="#spinner",i=6e4,n={};LL.Spinner={start:function(){var o=t++;return $(e).addClass("loading"),n[o]=setTimeout(this.spinTimeout.bind(this,o),i),o},stop:function(t){"undefined"!=typeof t&&t&&(n[t]&&(clearTimeout(n[t]),delete n[t]),0==_.size(n)&&$(e).removeClass("loading"))},spinTimeout:function(t){this.stop(t)}}}(),LL.StoryMap=function(){this.attributes({mapId:null}),this.template=null,this.addSlide=function(t,e,i){$(".storymap-slides").append(this.template);var n=$(".storymap-slides .slide_template").last();t&&i&&(n.data("blext",{address:t,lat:e[0],"long":e[1],image:i}),$(".address",n).text(t),$(".blext-photo",n).attr("src",i))},this.saveMap=function(){var t=this.generateMap();$.ajax({type:"POST",url:"/m/"+this.attr.mapId+"/storymap",data:t}),$(".submit-storymap").removeAttr("disabled")},this.generateMap=function(){var t=[],e=$("select.map-type :selected");e.hasClass("mapbox")?e="mapbox:"+$("input.mapbox").val():(e=e.val(),e=e.slice(0,e.indexOf(" ")));var i={type:"overview"},n=$('.overview-slide input[name="text"]').val()||"",o=$('.overview-slide input[name="image-url"]').val();o&&(i.media={url:o}),i.text={text:n,headline:""},t.push(i),$(".slide_template").each(function(e,i){i=$(i);
var n=i.data("text"),o=i.data("media"),s={location:{lat:i.data("blext").lat,lon:i.data("blext")["long"]}};s.media=o&&!$.isEmptyObject(o)?o:{url:i.data("blext").image},s.text={headline:$('input[name="headline"]',i).val()||"",text:n||""},t.push(s)}.bind(this));var s={width:1200,height:1200,storymap:{language:"US",map_type:e,map_as_image:!1,slides:t}};return{storymap:s}},this.removeSlide=function(t){var e=$(t).closest(".slide_template");e.fadeOut(300,function(){$("a.remove-slide i",e).toggleClass("fa-remove").toggleClass("fa-plus"),$("a.remove-slide span",e).text("Replace Slide"),e.prependTo($(".removed")).show()})},this.replaceSlide=function(t){var e=$(t).closest(".slide_template");e.fadeOut(300,function(){$("a.remove-slide i",e).toggleClass("fa-remove").toggleClass("fa-plus"),$("a.remove-slide span",e).text("Delete Slide"),e.prependTo($(".storymap-slides")).show()})},this.load=function(){$("#storymap-form").data("items").forEach(function(t){this.addSlide(t.address,t.centroid,t.image.thumb)}.bind(this))},this.showSlideOpts=function(t){this.saveSlideOpts(),$(".slide_template").removeClass("bg-primary"),t.addClass("bg-primary");var e=t.data("text"),i=t.data("media");$(".slide-options").show(),$(".slide-text-tab").addClass("active"),$(".slide-text").show(),$(".slide-options").data("slide",t),$(".slide-options textarea").val(e?e:""),i?($('#slide-media input[name="url"]').val(i.url),$('#slide-media input[name="caption"]').val(i.caption),$('#slide-media input[name="credit"]').val(i.credit)):$("#slide-media input").val("")},this.saveSlideOpts=function(){var t=$(".slide-options").data("slide");if(t){var e={};$("#slide-media input").each(function(t,i){$(i).val()&&(e[$(i).attr("name")]=$(i).val())}),t.data("media",e),t.data("text",$(".slide-options textarea").val())}},this.after("initialize",function(){LL.Templates.fetch("slide_template",function(t){this.template=t(),this.load(),$(".slide_template").on("click",function(t){$(".slide-text").hide(),$(".slide-media").hide(),this.showSlideOpts($(t.currentTarget))}.bind(this))}.bind(this)),$(".storymap-options").scroll(function(){$(".map-options").css("top",$(this).scrollTop())}),$(".storymap-slides").on("click","a.remove-slide",function(t){this.removeSlide(t.currentTarget)}.bind(this)),$(".removed").on("click","a.remove-slide",function(t){this.replaceSlide(t.currentTarget)}.bind(this)),$(".submit-storymap").on("click",function(){this.generateMap()}.bind(this)),$(".save-storymap").on("click",function(){this.saveMap()}.bind(this)),$("#storymap-form .storymap-slides").sortable({receive:function(t,e){e.item.remove()}}),$("#overview-image").fileupload({url:"/m/"+this.attr.mapId+"/storymap.json",sequentialUploads:!0,add:function(t,e){{var i=e.files[0].name;e.submit().success(function(){$("#overview-image").attr("title","Uploaded "+i)})}}}),$(".map-type").on("change",function(){$("option:selected",this).hasClass("mapbox")?$("input.mapbox").show():$("input.mapbox").hide()}),$(".slide-text, .slide-media").on("change",function(){this.saveSlideOpts()}.bind(this))})},function(){var t=this,e=1,i=!1,n=null,o={},s={};LL.Strings={initialize:function(){n="strings-v"+e,amplify.request.define(n,"ajax",{url:"/{ds}/strings.json",dataType:"json",type:"GET",cache:!0}),i=!0},fetch:function(e,r){return i||this.initialize(),o[e]?(s[e]||(s[e]=[]),void s[e].push(r)):(o[e]=!0,void amplify.request({resourceId:n,data:{ds:e},success:function(e,i){"ok"==i.status&&(r.apply(t,[i]),o[e]=!1,_.each(s[e]||[],function(e){e.apply(t,[i])}),s[e]=[])}.bind(this,e),error:function(t){o[t]=!1}.bind(this,e)}))}}}(),function(){LL.Tags=flight.component(function(){this.attributes({blank:"(Blank)",map:null,source:!1,blextId:!1,path:!1,save:!1});var t;this.setup=function(){var e=$.extend({},this.$node.data(),{pk:this.attr.blextId,all:t.tags,selected:this.$node.text().split(", ")}),i={width:"200px",tags:!0,data:t.tags,placeholder:this.attr.blank,multiple:!0,tokenSeparators:[","," "],separator:", ",minimumInputLength:1};this.$node.editable({mode:"popup",type:"select2",url:this.attr.map.path+"/tags.json",ajaxOptions:{method:"POST",dataType:"json"},params:{path:this.attr.path,source_id:t?t.id:null},emptytext:this.attr.blank,onblur:"ignore",select2:i,tpl:this.makeTagSelect(e)}).on("save",function(i,n){"ok"==n.response.status&&(t?t.tags=_.union(t.tags,n.response.blext.tags):(t=n.response.source,this.attr.map.sources[t.key]=t),e.all=t.tags,e.selected=n.response.blext.tags,$(i.target).editable("option","tpl",this.makeTagSelect(e)))}.bind(this))},this.makeTagSelect=function(t){var e=_.collect(t.all,function(e){return{tag:e,selected:_.contains(t.selected||[],e)}}),i=$.extend({},t,{tags:e});return LL.Tags.tsTemplate(i)},this.onDestroy=function(){debug("destroying Tags widget"),this.$node.editable("destroy"),this.teardown()},this.after("initialize",function(){t=this.attr.source,LL.Tags.tsTemplate||(LL.Tags.tsTemplate=Handlebars.compile("<select class='' data-pk='{{pk}}' data-name='{{name}}'>{{#each tags}}<option value='{{tag}}'{{#if selected}} selected='selected'{{/if}}>{{tag}}</option>{{/each}}</select>")),this.setup()})})}(),function(){function t(){var t=null;this.onCommentAdded=function(t,e){if(e.parent_id){var i=$(".thread[data-parent="+e.parent_id+"]",this.$node);LL.Templates.fetch("reply",function(t){var n=t(e),o=$(".reply-container",i);$(n).insertBefore(o)})}},this.onKeyUp=function(e){27==e.keyCode&&t.closeAllThreads()},this.onClickReply=function(t){var e=$(t.currentTarget).closest(".reply-container"),i=e.data("parent");LL.TalkBox.addTo(i),t.preventDefault()},this.loadThread=function(e){var i=$("tr[data-id="+e+"]");if(!i.hasClass("showing-conversation")&&!i.hasClass("loading-conversation")){i.addClass("loading-conversation");var n=LL.Spinner.start();$.get("/comments/"+e+".json",function(e){LL.Templates.fetch(["conversation","thread","reply"],function(n){t.trigger("spinner:stop"),i.removeClass("loading-conversation").addClass("showing-conversation");var o=$(n.conversation(e)).insertAfter(i).hide().slideDown();$(".close",o).click(t.onClickClose),$("a.reply-button",o).click(t.onClickReply)})}).always(function(){LL.Spinner.stop(n)})}},this.onClickSubject=function(t){var e=$(t.currentTarget).attr("data-id"),i=$("tr[data-parent="+e+"]");i.exists()?this.closeThread(e):this.loadThread(e),t.preventDefault()},this.onClickClose=function(t){var e=$(t.currentTarget).closest("tr[data-parent]"),i=e.attr("data-parent");$("tr[data-id="+i+"]").removeClass("showing-conversation"),$("tr[data-parent="+i+"]").slideUp().delay(500).remove(),t.preventDefault()},this.closeThread=function(t){$("tr[data-id="+t+"]").removeClass("showing-conversation"),$("tr[data-parent="+t+"]").slideUp().delay(500).remove()},this.closeAllThreads=function(){$("tr.showing-conversation").removeClass("showing-conversation"),$("tr.conversation-row").slideUp().delay(500).remove()},this.after("initialize",function(){t=this,this.on("td > a.subject","click",this.onClickSubject),this.on(document,"keyup",this.onKeyUp),this.on(document,"talk:comment:add",this.onCommentAdded),LL.Templates.preload(["conversation","thread","reply","talk_box"])})}LL.Talk=flight.component(t)}(),function(){function t(){this.attributes({ajax:!0,spec:"",parentId:!1,"private":!1,sitecontrol:!1}),this.onFocus=function(){var t=$(".guidelines",this.$node);t.is(":visible")||t.hide().removeClass("hide").slideDown()},this.valid=function(){var t=$("textarea[name=body]",this.$node).val(),e=$("input[type=file]",this.$node).val();return t.length>0||e.length>0},this.doPost=function(){return this.valid()?void(this.attr.ajax?this.submitAjax():$("form",this.$node).submit()):(alert("Please enter something in the message or add a photo."),!1)},this.submitAjax=function(){var t=$("form.talk-form",this.$node),e=new FormData(t.get(0));$.ajax({url:"/comments.json",type:"POST",data:e,contentType:!1,processData:!1,success:function(t){"ok"==t.status?(this.trigger("talk:comment:add",t.comment),this.doClear()):$(".guidelines",this.$node).text(t.message)}.bind(this)})},this.onChangeText=function(){this.updateValidation()},this.onClickPost=function(t){return this.doPost(),t.preventDefault(),!1},this.onClickCancel=function(t){return this.doClear(),t.preventDefault(),!1},this.doClear=function(){$("input[type=text], textarea, input[type=image]",this.$node).val(""),$(".guidelines",this.$node).slideUp();var t=$("a.photo",this.$node);t.html(t.data("original")),imageData=null,this.updateValidation();var e=this.$node.closest(".reply-container");$(".reply-button",e).removeClass("hide"),this.teardown(),this.$node.remove()},this.onClickPhoto=function(t){var e=$(".btn.photo",this.$node),i=$("input[name=image]",this.$node);return i.change(function(){e.html(e.data("original")+" Photo attached!"),this.updateValidation()}.bind(this)),i.click(),t.preventDefault(),!1},this.updateValidation=function(){this.valid()?$("a.post",this.$node).attr("disabled",!1).addClass("btn-primary").removeClass("btn-default"):$("a.post",this.$node).attr("disabled",!0).removeClass("btn-primary").addClass("btn-default")},this.onSetTarget=function(t,e){var i={shortcut:e.path};this.attr.spec=i,$("input[name=spec]",this.$node).val(JSON.stringify(i))},this.after("initialize",function(){this.authToken=$("meta[name='csrf-token']").attr("content"),$("a.photo",this.$node).data("original",$("a.photo",this.$node).html()),$("input[name=authenticity_token]",this.$node).val(this.authToken),$("input[name=spec]",this.$node).val(this.attr.spec?JSON.stringify(this.attr.spec):null),$("input[name=private]",this.$node).val(this.attr["private"]?"1":""),this.on("input[type=text], textarea","focus",this.onFocus),this.on("input[type=text], textarea","keyup",this.onChangeText),this.on("a.post","click",this.onClickPost),this.on("a.cancel","click",this.onClickCancel),this.on("a.photo","click",this.onClickPhoto),this.on("talk:set-target",this.onSetTarget)})}LL.TalkBox=flight.component(t),LL.TalkBox.addTo=function(t,e){var i=$(".reply-container[data-parent="+t+"]");if(i.exists()){if(window.data.signed_in)LL.Templates.fetch("talk_box",function(n){var o=n({parentId:t});i.append(o);var s=$(".talk-box",i);LL.TalkBox.attachTo(s,$.extend({ajax:!0,parentId:t},e))});else{var n="<div class='talk-box'><i class='fa fa-comment'/> If you were signed in, you could write a response here and join in!</div>";$("td.conversation",i).append(n)}$(".reply-button",i).addClass("hide")}}}(),function(){var t={},e=[],i="/templates.json",n=this;LL.Templates={preload:function(i){var n="string"==typeof i?[i]:i;e=e.concat(_.select(n,function(e){return!t[e]}))},fetch:function(o,s){var r=!1;"string"==typeof o&&(r=!0,o=[o]);var a=_.groupBy(o,function(e){return t[e]?"cached":"fetch"});if(a.cached&&!a.fetch){var l=r?t[o[0]]:_.pick(t,a.cached);s.apply(n,[l])}if(a.fetch){var h=a.fetch;e.length>0&&(debug("Queued template reqs come along too.."),h=_.union(a.fetch,e),e=[]),debug("Fetching: "+h.join(", "));var c=LL.Spinner.start();$.get(i,{names:h},function(e){if("ok"==e.status){_.each(e.templates,function(e,i){var n=Handlebars.compile(e);t[i]=n,Handlebars.registerPartial(i,n)});var i=_.pick(t,o);r&&(i=i[o[0]]),s.apply(n,[i])}else debug("Error fetching template fragments..")}).always(function(){LL.Spinner.stop(c)})}}}}(),function(){function t(){this.attributes({});var t={},e={},i={},n=null;this.initializePano=function(){debug("googlepano init");var e=this.$node.get(0),i={addressControl:!1,clickToGo:!1,pov:{heading:0,pitch:0,zoom:1}};t=this.panorama=new google.maps.StreetViewPanorama(e,i),this.trigger("google-pano:initialized",t),google.maps.event.addListener(t,"status_changed",this.onStatusChanged.bind(this))},this.onStatusChanged=function(){this.trigger("google-pano:updated")},this.set=function(t,i){var n=i.property;e=this.makeGoogleLatLng(n.centroid),this.getDefaultPano(e,function(t){t?(this.trigger("google-pano:view-available",n),this.updatePano(e,t)):(debug("No street view available for this property."),this.trigger("google-pano:no-view",n))}.bind(this))},this.getDefaultPano=function(t,e){var i=new google.maps.StreetViewService,n=50;i.getPanoramaByLocation(t,n,e)},this.updatePano=function(t,o){var s=o.location.latLng,r=this.computeHeading(s,t);i={heading:r,pitch:0,zoom:1},n=o.imageDate,e=t,this.invoke({setPano:o.location.pano}),this.on("google-pano:updated",function(){this.invoke({setPov:i})})},this.serveView=function(){var e=t.getPosition().toString(),i=t.getPov(),o=this.convertZoomToFov(i.zoom),s={location:e,heading:i.heading,pitch:i.pitch,zoom:i.zoom,fov:o,image_date:n};s.url=this.generateViewUrl(s),this.trigger("google-pano:view:served",s)},this.invoke=function(e,i){i=i||e,_.each(i,function(e,i){t[i](e)})},this.convertZoomToFov=function(t){return ZOOM_TO_FOV={0:120,1:90,2:50,3:30,4:15,5:0},ZOOM_TO_FOV[t]||50},this.resetPano=function(){t.setPosition(e),t.setPov(i)},this.onDestroy=function(){debug("destroy googlepano"),this.teardown()},this.after("initialize",function(){this.initializePano(),this.on(document,"bu:destroy",this.onDestroy),this.on(document,"google-pano:set",this.set),this.on(document,"google-pano:invoke",this.invoke),this.on(document,"google-pano:reset",this.resetPano),this.on(document,"google-pano:view:requested",this.serveView)})}LL.GooglePano=flight.component(t,mapMixin)}(),function(){function t(){this.attributes({options:{}});var t="<div id='mini-map'/>";this.initializeMap=function(){debug("survey map initializeMap");var t=$("#mini-map",this.$node).get(0),e={zoom:18};this.attr.options&&_.extend(e,this.attr.options);var i=new google.maps.Map(t,e);this.map=i,i.setTilt(0),i.data.setStyle({strokeColor:"#f1c40f",strokeWeight:1}),this.trigger("bu:map:initialized",i),google.maps.event.addListener(i,"tilesloaded",function(){this.trigger("bu:map:tiles-loaded",i)}.bind(this))},this.onPanoInit=function(t,e){debug("surveymap gets bu:pano:initialized"),this.map?this.map.setStreetView(e):debug("what! no map yet!")},this.updateMap=function(t,e){var i=this.makeGoogleLatLng(e.centroid),n={type:"Feature",geometry:e.geometry};this.clearData(),this.latLng=i,this.map.setCenter(i),this.map.data.addGeoJson(n)},this.clearData=function(){var t=this.map;t.data.forEach(function(e){t.data.remove(e)})},this.triggerResize=function(t,e){if(this.map){if(e){var i=this.map.getCenter();i&&(i.k=this.latLng.k,this.map.setCenter(i))}google.maps.event.trigger(this.map,"resize")}},this.serveView=function(){var t=this.map,e=t.getCenter().toString(),i=t.getZoom(),n={center:e,zoom:i,maptype:t.getMapTypeId()};n.url=this.generateViewUrl(n),this.trigger("google-map:view:served",n)},this.onTeardown=function(){debug("tearing down minimap"),this.$node.empty(),this.teardown()},this.after("initialize",function(){debug("survey_map init"),this.map=null,this.$node.html(t),this.initializeMap(),this.on("bu:map:resize",this.triggerResize),this.on("bu:map:teardown",this.onTeardown),this.on(document,"bu:panorama:initialized",this.onPanoInit),this.on(document,"bu:property:served",this.updateMap),this.on(document,"bu:destroy",this.onTeardown),this.on(document,"bu:map:set",this.updateMap),this.on(document,"google-map:view:requested",this.serveView)})}LL.SurveyMap=flight.component(t,mapMixin)}(),function(){function t(){this.attributes({templateId:"survey_pano",backupMapActive:!1,panoCanvas:"#pano-canvas",mapCanvas:"#map-canvas",resetPano:"#reset-map",noStreetviewAvailable:".no-streetview-available"}),this.activateBackupMap=function(t,e){if(!this.attr.backupMapActive){this.toggleBackupMap(!0);var i={zoom:19,mapTypeId:google.maps.MapTypeId.HYBRID,mapTypeControl:!1,streetViewControl:!1};LL.SurveyMap.attachTo(this.attr.mapCanvas,{options:i})}this.trigger(this.attr.mapCanvas,"bu:map:set",e),this.trigger("bu:panorama:updated")},this.destroyBackupMap=function(){this.toggleBackupMap(!1),this.trigger(this.attr.mapCanvas,"bu:map:teardown")},this.toggleBackupMap=function(t){this.attr.backupMapActive=t,this.select("noStreetviewAvailable").toggleClass("hide",!t),this.select("panoCanvas").toggle(!t),this.select("resetPano").toggle(!t),this.select("mapCanvas").toggle(t)},this.onPropertyServed=function(t,e){this.trigger("google-pano:set",{property:e})},this.serveView=function(){this.attr.backupMapActive?this.trigger(this.attr.mapCanvas,"google-map:view:requested"):this.trigger(this.attr.panoCanvas,"google-pano:view:requested")},this.resetPano=function(){this.trigger(this.attr.panoCanvas,"google-pano:reset")},this.onDestroy=function(){debug("destroy survey_pano"),this.teardown()},this.after("initialize",function(){debug("survey_pano init"),this.on(document,"bu:property:served",this.onPropertyServed),this.on(document,"bu:streetview:requested",this.serveView),this.on("#reset-map","click",this.resetPano),this.on(document,"bu:destroy",this.onDestroy),this.on(document,"google-pano:initialized","bu:panorama:initialized"),this.on(document,"google-pano:updated","bu:panorama:updated"),this.on(document,"google-pano:view:served","bu:streetview:served"),this.on(document,"google-map:view:served","bu:streetview:served"),this.on(document,"google-pano:no-view",this.activateBackupMap),this.on(document,"google-pano:view-available",this.destroyBackupMap),LL.GooglePano.attachTo("#pano-canvas")})}LL.SurveyPano=flight.component(t,mapMixin)}(),function(){function t(){this.queue=[],this.attributes({basePath:"/survey",mapSlug:!1});var t="USA";this.onSubmit=function(){this.save()},this.getNext=function(){var t=$.deparam.fragment();this.trigger("bu:property:get-next",t)},this.updateWith=function(e){if(this.properties=e,this.properties.specString=this.makeSpecString(e),this.properties.bounds){t=this.properties.bounds.headline;var i=window.data.sitecontrol&&this.attr.mapSlug?s.sprintf("/m/%s#s=%s",this.attr.mapSlug,this.properties.bounds.path):this.properties.bounds.path;$(".return").attr("href",i).removeClass("hide")}else $(".return").addClass("hide");this.setBounds(e),$.bbq.setState({s:e.bounds.path,p:e.path});var n="";n+=this.properties.path?s.sprintf("<a href='%s'>%s</a>",this.properties.path,this.properties.headline):this.properties.headline||"[address unknown]",n+=", "+this.properties.specString,$("#property-address").html(n),this.trigger("bu:property:served",this.properties)},this.onGetNext=function(t,e){if(this.queue.length<2){var i=LL.Spinner.start();$.get(this.attr.basePath+"/next_property.json",e,function(t){"error"==t.status?debug(t.message):(this.queue=_.uniq(this.queue.concat(t),function(t){return t.path}),this.queue=_.reject(this.queue,function(t){return this.properties&&t.path==this.properties.path}.bind(this)),this.updateWith(this.queue.shift()))}.bind(this)).fail(function(t){debug("Error fetching property: ",t)}.bind(this)).always(function(){LL.Spinner.stop(i)}.bind(this))}else this.updateWith(this.queue.shift())},this.nextInScope=function(){var t=$("#survey-bounds option:selected").data("url-fragment");$.bbq.setState({s:t}),this.queue=[],this.getNext()};var e=Handlebars.compile("{{#each scope}}<option data-url-fragment='{{path}}'>{{headline}}</option>{{/each}}");this.setBounds=function(t){var i=e(t);$("#survey-bounds",this.$node).html(i),$("#survey-bounds option[data-url-fragment='"+t.bounds.path+"']").attr("selected","1")},this.makeSpecString=function(t){return t.city?t.city.headline:t.bounds?t.bounds.headline:""},this.save=function(){if(!this.saving){this.saving=!0;var t=this.marshall();this._saveData(t)}},this.onSurveySkipped=function(){this.saveAsUnsurveyable()},this.saveAsUnsurveyable=function(){var t=this.marshall();t.survey.answers={no_streetview:!0},this._saveData(t)},this._saveData=function(t){var e=LL.Spinner.start();$.post(this.attr.basePath+"/create.json",t,function(t){this.trigger("bu:survey:saved",t.blext)}.bind(this)).always(function(){this.saving=!1,LL.Spinner.stop(e)}.bind(this))},this.onSurveySaved=function(){this.getNext()},this.onSetPhoto=function(t,e){this.properties.photo=e.photo},this.marshall=function(){var t=requestServe("bu:streetview"),e=requestServe("bu:survey-tags",{validate:!0}),i=t.url.replace(/[()]/g,""),n={spec:this.properties.spec,survey:{streetview:t,streetview_url:i,photo:this.properties.photo}};return $.extend(n.survey,e),n},this.viewImg=function(){var t=requestServe("bu:streetview").url;window.open(t)},this.onDestroy=function(){debug("destroy survey property"),this.teardown()},this.after("initialize",function(){this.properties=null,this.saving=!1,$("#survey-bounds",this.$node).on("change",this.nextInScope.bind(this)),this.on(document,"bu:property:get-next",this.onGetNext),this.on(document,"bu:property:set-photo",this.onSetPhoto),this.on(document,"bu:survey:skipped",this.onSurveySkipped),this.on(document,"bu:survey:saved",this.onSurveySaved),this.on(document,"bu:survey:submit",this.onSubmit),this.on(document,"bu:destroy",this.onDestroy)})}LL.SurveyProperty=flight.component(t)}(),function(){function t(){this.attributes({templateId:"survey_questions",url:"/survey/questions.json",questions:[],skip:"Unable to Survey",photoHint:"Note: This will override the streetview or aerial picture.",answer:".answer",crumb:".question-breadcrumb",nextQuestion:".next-question",additionalNotes:"#additional-notes"}),this.getQuestions=function(){this.attr.questions&&0!=this.attr.questions.length?this.getQuestion(0):$.get(this.attr.url,function(t){this.attr.questions=t,this.getQuestion(0)}.bind(this))},this.current=function(){var t=this.attr.questions,e=this.currentIndex;return t[e]},this.setIndex=function(t){this.currentIndex=t},this.getQuestion=function(t){t=t||0,this.setIndex(t);var e=this.current();this.renderQuestion(e)},this.renderQuestion=function(t){var e={question:t,done:!t,previous:this.previous,skip:this.attr.skip,photoHint:this.attr.photoHint};this.render(e),this.trigger("bu:small-panel:resize")},this.isLast=function(){return this.currentIndex===this.attr.questions.length-1},this.jumpToPrevious=function(t){t.preventDefault();var e=$(t.target).closest(this.attr.crumb),i=e.index(),n=this.previous.splice(i),o=n[0].index;this.removeAnswers(n),this.getQuestion(o)},this.removeAnswers=function(t){_.each(t,this.removeAnswer.bind(this))},this.removeAnswer=function(t){delete this.answers[t.column]},this.pushPrevious=function(){var t=this.current();this.previous.push({column:t.column,index:this.currentIndex})},this.selectAnswer=function(t){var e=$(t.target).closest(this.attr.answer),i=e.index(),n=this.current(),o=n.answers[i];this.addAnswer(o),this.pushPrevious(),this.getQuestion(o.next?o.next.index:this.currentIndex+1)},this.addAnswer=function(t){var e=this.current();this.answers[e.column]=t.value},this.nextQuestion=function(){var t=$(this.attr.additionalNotes,this.$node).val();this.addAnswer({value:t}),this.pushPrevious(),this.getQuestion(this.currentIndex+1)},this.serveAnswers=function(t,e){e=e||t.payload;var i={answers:this.getAnswers()};this.trigger("bu:survey-tags:served",i)},this.getAnswers=function(){return this.answers},this.onClickSubmit=function(t){var i=this.getAnswers();debug(i);var n=e?[e]:[];this.trigger("bu:survey:submit",{answers:i,images:n}),t.preventDefault()};var t=null,e=null,i=null;this.onChangePhoto=function(e){e.target.files&&e.target.files[0]&&t.readAsDataURL(e.target.files[0])},this.initPhotoUpload=function(){e=null,t=new FileReader,t.onload=function(t){this.trigger("bu:property:set-photo",{photo:t.target.result})}.bind(this)},this.onClickPhoto=function(t){var e=$("#photo",this.$node);i||(i=e.html());var n=$("input[name=image]",this.$node);return n.change(function(t){t.target.files.length>0&&e.text(t.target.files[0].name+" attached!")}),n.click(),t.preventDefault(),!1},this.onSetPhoto=function(t,n){n.photo?e=n.photo:i&&($("#photo",this.$node).html(i),e=null)},this.onDestroy=function(){debug("destroy surveyQuestions"),this.$node.empty(),this.teardown()},this.resetForm=function(){this.previous=[],this.answers={},this.getQuestion(0),this.initPhotoUpload()},this.after("initialize",function(){this.previous=[],this.answers={},this.currentIndex=0,this.getQuestions(),this.initPhotoUpload(),this.on(document,"bu:destroy",this.onDestroy),this.on(document,"bu:survey-tags:requested",this.serveAnswers),this.on(document,"bu:survey:saved",this.resetForm),this.on(document,"bu:survey:skipped",this.resetForm),this.on(document,"bu:property:set-photo",this.onSetPhoto),this.$node.on("click","#submit-form",this.onClickSubmit.bind(this)),this.$node.on("change","#upload_photo",this.onChangePhoto.bind(this)),this.$node.on("click","#photo",this.onClickPhoto.bind(this)),this.on(this.node,"click",{answer:this.selectAnswer,crumb:this.jumpToPrevious,nextQuestion:this.nextQuestion})})}LL.SurveyQuestions=flight.component(t,renderMixin)}(),function(){function t(){this.attributes({templateId:"survey_stats",url:"/survey/stats.json",selector:".stats"});var t=null;this.renderData=function(e){debug("surveyStats.renderData"),debug(e),"string"==typeof e&&(e=JSON.parse(e)),t=e,LL.Templates.fetch(this.attr.templateId,function(t){debug(e);var i=t(e);debug(i),$(this.attr.selector,this.$node).html(i)}.bind(this))},this.getStats=function(){var t={};$.get(this.attr.url,t,this.renderData.bind(this)).fail(function(){}).always(function(){})},this.onAdd=function(e,i){t&&"Feature"==i.type&&(t.properties_done+=1,this.renderData(t))},this.onDestroy=function(){debug("destroy: surveyStats"),this.teardown()},this.after("initialize",function(){LL.Templates.preload([this.attr.templateId]),this.getStats(),this.on(document,"bin:add",this.onAdd),this.on(document,"mapp:destroy",this.onDestroy)})}LL.SurveyStats=flight.component(t)}(),function(){function t(){this.attributes({selectedClass:"btn-primary",selectedTagSetClass:"selected-tag-set",templateId:"survey_tags",autoRender:!0,noStructure:"no-structure",tagSets:null,tag:".tag",tagText:".tag-text",tagSet:".tag-set",selectedTag:".tag.required.btn-primary",customTag:".tag.custom:visible",removeTag:".remove-tag",customTagForm:".custom-tag-form",toggleCustomTagForm:"#toggle-custom-tags",footer:".survey-tags-footer",validations:".select-tags-warning",customTagInput:"#new-tag"}),this.isValid=function(){var t=this.getRequiredTags();return t.length>=4||this.noStructureSelected(t)},this.toggleTagSelection=function(t){var e=$(t.target).closest(this.attr.tag);this.unselectSiblings(e),e.toggleClass(this.attr.selectedClass);var i=e.hasClass(this.attr.selectedClass);e.closest(this.attr.tagSet).toggleClass(this.attr.selectedTagSetClass,i);var n=this.noStructureSelected();this.toggleSiblingTagSets(e,n)},this.getTagText=function(t){return $(t).find(this.attr.tagText).text()},this.unselectSiblings=function(t){t.siblings().removeClass(this.attr.selectedClass)},this.toggleSiblingTagSets=function(t,e){t.closest(this.attr.tagSet).siblings().toggleClass("inactive-tag-set",e)},this.removeTag=function(t){$(t.target).closest(this.attr.tag).remove()},this.getRequiredTags=function(){var t=this.select("selectedTag").map(function(t,e){return this.getTagText(e)}.bind(this)).toArray();return this.noStructureSelected(t)&&(t=[this.attr.noStructure]),t},this.getCustomTags=function(){return this.select("customTag").map(function(t,e){return this.getTagText(e)}.bind(this)).toArray()},this.getSelectedTags=function(){var t=this.getRequiredTags(),e=this.getCustomTags();return t.concat(e)},this.noStructureSelected=function(t){return t=t||this.getRequiredTags(),t.indexOf(this.attr.noStructure)>-1},this.serveSelectedTags=function(t,e){e=e||t.payload;var i={tags:this.getSelectedTags()};if(e&&e.validate){var n=this.isValid();i.isValid=n,n||(this.select("validations").show(),this.trigger("bu:survey-tags:changed"))}this.trigger("bu:survey-tags:served",i)},this.toggleCustomTagForm=function(t){t.preventDefault(),this.select("customTagForm").toggle();var e=this.select("footer");e.find("i").toggleClass("hide"),e.find("span").toggleClass("hide"),$("#new-tag").focus(),this.trigger("bu:survey-tags:changed")},this.evaluateCustomTagAction=function(t){var e=t.keyCode,i=$(t.target),n=i.val();if(13===e||32===e){if(!n)return;this.addCustomTag(n),i.val("")}8!==e||n||$(".custom-tag-form .tag").last().remove()},this.addCustomTag=function(t){var e=$("<span>").addClass("btn btn-primary tag custom"),i=$("<span>").addClass("tag-text").text(t),n=$("<i>").addClass("glyphicon glyphicon-remove remove-tag");e.append(i,n),e.insertBefore($("#new-tag")),e.on("click",".remove-tag",function(){e.remove()})},this.resetForm=function(){this.select("customTag").remove(),this.select("validations").hide(),this.select("selectedTag").removeClass(this.attr.selectedClass),this.select("tagSet").removeClass(this.attr.selectedTagSetClass).removeClass("inactive-tag-set")},this.onDestroy=function(){debug("destroy surveyTags"),this.teardown()},this.after("initialize",function(){this.on(document,"bu:survey-tags:requested",this.serveSelectedTags),this.on(document,"bu:survey:changed",this.resetForm),this.on(document,"bu:destroy",this.onDestroy),this.on(document,"click",{tag:this.toggleTagSelection,removeTag:this.removeTag,toggleCustomTagForm:this.toggleCustomTagForm}),this.on(document,"keydown",{customTagInput:this.evaluateCustomTagAction}),$(document).on("click",".custom-tag-form",function(){$("#new-tag").focus()})})}LL.SurveyTags=flight.component(t,renderMixin)}(),LL.Wallet=function(){this.attributes({clientToken:null,originalCardToken:null,authToken:!1,addCardTitle:!1,cardClass:"col-md-4"});var t=null;this.fetchMyCards=function(){this.$node.html("<div class='centered'><i class='fa fa-spinner fa-spin big'></div>");var t="/account/cards.json";this.attr.authToken&&(t+="?token="+this.attr.authToken),$.get(t,function(t){this.clientToken=t.client_token,this.cardInfo=t,this.renderCards()}.bind(this))},this.renderCards=function(){this.cardInfo&&(_.each(this.cardInfo.cards,function(t){delete t.classes,delete t.button,t.cardClass=this.attr.cardClass,t.token==this.cardToken&&(t.classes="active"),t.token==this.attr.originalCardToken&&(t.button="This is the Current Card",t.noRemove=!0),t.expired&&(t.classes="expired",t.button="Expired!",t.noChoose=!0)}.bind(this)),this.cardInfo.cardClass=this.attr.cardClass,LL.Templates.fetch("card_list",function(t){var e=t(this.cardInfo);this.$node.html(e),this.postRender(),this.cardInfo.cards&&0!=this.cardInfo.cards.length||this.showAddForm()}.bind(this))),t=t||new braintree.api.Client({clientToken:this.clientToken})},this.postRender=function(){$(".card .choose",this.$node).click(this.onChooseCard.bind(this)),$(".card .remove",this.$node).click(this.onRemoveCard.bind(this)),$(".add-card",this.$node).click(this.onClickAdd.bind(this)),this.$node.addClass("loaded"),this.cardToken&&this.trigger("wallet:activate",{cardToken:this.cardToken})},this.onChooseCard=function(t){var e=$(t.target).closest(".card");if(e.hasClass("expired")){var i=$(".btn",e),n=i.css("background-color");return i.stop().css("background-color","#ff6020").animate({backgroundColor:n},1e3),!1}var o=e.data("token"),s=this.getCardInfoByToken(o),r={clientToken:this.clientToken,cardToken:o,card:s};this.trigger("wallet:chosen",r),t.stopPropagation()},this.onCardAdded=function(t,e){this.cardInfo&&(this.cardInfo.cards.push(e.card),this.renderCards())},this.onCardChosen=function(t,e){this.cardToken=e.cardToken,$(".add-card-container",this.$node).slideUp(),this.trigger("wallet:activate",{cardToken:this.cardToken})},this.onRemoveCard=function(t){var e=$(t.target).closest(".card"),i=e.data("token"),n="/account/cards/"+i+".json";this.attr.authToken&&(n+="?token="+this.attr.authToken),$.ajax(n,{method:"DELETE",success:function(t){"ok"==t.status?(e.parent().remove(),this.cardInfo.cards=_.reject(this.cardInfo.cards,function(t){return t.token==i})):$(".remove",e).text("Error removing!")}.bind(this)}),t.stopPropagation()},this.onClickAdd=function(t){this.showAddForm(),t.preventDefault()},this.showAddForm=function(){var e=$(".add-card-container",this.$node);flight.component(LL.AddCard).attachTo(e,{title:this.attr.addCardTitle,cardClass:this.attr.cardClass,clientToken:this.attr.clientToken,authToken:this.attr.authToken,client:t,wallet:this})},this.getCardInfoByToken=function(t){return this.cardInfo&&t?_.find(this.cardInfo.cards,function(e){return e.token==t}):null},this.onActivate=function(t,e){var i=$(".card",this.$node);i.removeClass("active"),$(".choose",i).text("Use This Card");var n=$(".card[data-token='"+e.cardToken+"']",this.$node);n.addClass("active"),$(".remove",n).remove(),$(".choose",n).text("This is the Current Card")},this.onDestroy=function(){debug("wallet: destroying"),this.trigger("wallet:destroy"),this.$node.removeClass("loaded"),this.$node.empty(),this.teardown()},this.after("initialize",function(){this.clientToken=this.attr.clientToken,this.cardToken=this.attr.originalCardToken,this.on(document,"pjax:beforeSend",this.onDestroy),this.on("wallet:added",this.onCardAdded),this.on("wallet:chosen",this.onCardChosen),this.on("wallet:activate",this.onActivate),LL.Templates.preload(["card_list","card_add"]),this.cardInfo?this.renderCards():this.fetchMyCards()
})},LL.AddCard=function(){this.attributes({clientToken:null,authToken:!1,title:!1,cardClass:"",client:null,wallet:null});var t=null;this.render=function(){LL.Templates.fetch("card_add",function(e){var i=e({cardClass:this.attr.cardClass,title:this.attr.title});t=this.$node.html(),$(".add-card",this.$node).replaceWith(i),this.on(".save-card","click",this.onClickSave),("development"==window.data.env||"staging"==window.data.env)&&this.loadSampleDetails(),$("#wallet .existing .card").exists()||$(".add-card-container").addClass("only")}.bind(this))},this.onClickSave=function(t){var e=this.readCardForm();$(".btn.save-card",this.$node).html("<i class='fa fa-spinner fa-spin'/> Saving...").addClass("active").attr("disabled","true"),this.attr.client.tokenizeCard(e,function(t,e){if(e){$("input",this.$node).attr("disabled","true"),this.trigger("wallet:message",{});var i={nonce:e};this.attr.authToken&&(i.token=this.attr.authToken),$.post("/account/cards.json",i,function(t){"ok"==t.status?this.onCardSaved(t):this.trigger("wallet:error:add",{errors:t.message.split("\n")})}.bind(this))}else this.trigger("wallet:error:add",{errors:[t]})}.bind(this)),t.preventDefault()},this.onCardSaved=function(t){$(".btn.save-card",this.$node).html("<i class='fa fa-check-circle'/> Saved!").addClass("active").off("click");var e={clientToken:this.attr.clientToken,cardToken:t.card.token,card:t.card};this.attr.wallet.trigger("wallet:added",e),this.attr.wallet.trigger("wallet:chosen",e)},this.loadSampleDetails=function(){var t={cardholderName:window.data.username,number:"4111111111111111",expirationMonth:"10",expirationYear:"18",cvv:"123",postalCode:"94130"};_.each(t,function(t,e){$(s.sprintf("input[data-braintree-name='%s']",e),this.$node).val(t)}.bind(this))},this.readCardForm=function(){var t=$("input[data-braintree-name]",this.$node),e={billingAddress:{}};return t.each(function(t,i){var n=$(i).data("braintree-name"),o=$(i).val();"postalCode"==n?e.billingAddress[n]=o:e[n]=o}),e},this.onShowMessage=function(t,e){e&&e.lines?$(".messages",this.$node).html(e.lines.join("<br/>")):$(".messages",this.$node).empty()},this.onSaveError=function(t,e){this.trigger("wallet:message",{lines:e.errors}),this.trigger("wallet:unsubmit")},this.onUnsubmit=function(){$(".btn.save-card",this.$node).html("Save and Use").removeClass("active").removeAttr("disabled"),$("input",this.$node).removeAttr("disabled"),this.cardToken=null},this.onClear=function(){this.trigger("wallet:unsubmit"),$("input",this.$node).val("")},this.onDestroy=function(){debug("wallet new-card destroying"),this.$node.empty(),this.teardown()},this.after("initialize",function(){debug("card-adder initializing"),this.on(document,"wallet:destroy",this.onDestroy),this.on("wallet:message",this.onShowMessage),this.on("wallet:unsubmit",this.onUnsubmit),this.on("wallet:error:add",this.onSaveError),this.on("wallet:clear",this.onClear),this.render()})};